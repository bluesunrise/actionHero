<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <meta content="IE=edge,chrome=1" http-equiv="X-UA-Compatible">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

    <meta name="description" content="actionhero.js is a multi-transport framework Node.JS API Server with integrated cluster capabilities and delayed tasks">
    <meta name="keywords" content="actionhero, actionherojs, node, nodejs, node.js, framework, server, api, cluster, redis, task, job, background, middleware">
    <link rel="icon" href="/images/favicon.ico" type="image/x-icon" />

    <title>ActionHero Documentation and API Reference</title>

    <style>
      .highlight table td { padding: 5px; }
.highlight table pre { margin: 0; }
.highlight, .highlight .w {
  color: #f8f8f2;
  background-color: #272822;
}
.highlight .err {
  color: #151515;
  background-color: #ac4142;
}
.highlight .c, .highlight .cd, .highlight .cm, .highlight .c1, .highlight .cs {
  color: #505050;
}
.highlight .cp {
  color: #f4bf75;
}
.highlight .nt {
  color: #f4bf75;
}
.highlight .o, .highlight .ow {
  color: #d0d0d0;
}
.highlight .p, .highlight .pi {
  color: #d0d0d0;
}
.highlight .gi {
  color: #90a959;
}
.highlight .gd {
  color: #ac4142;
}
.highlight .gh {
  color: #6a9fb5;
  background-color: #151515;
  font-weight: bold;
}
.highlight .k, .highlight .kn, .highlight .kp, .highlight .kr, .highlight .kv {
  color: #aa759f;
}
.highlight .kc {
  color: #d28445;
}
.highlight .kt {
  color: #d28445;
}
.highlight .kd {
  color: #d28445;
}
.highlight .s, .highlight .sb, .highlight .sc, .highlight .sd, .highlight .s2, .highlight .sh, .highlight .sx, .highlight .s1 {
  color: #90a959;
}
.highlight .sr {
  color: #75b5aa;
}
.highlight .si {
  color: #8f5536;
}
.highlight .se {
  color: #8f5536;
}
.highlight .nn {
  color: #f4bf75;
}
.highlight .nc {
  color: #f4bf75;
}
.highlight .no {
  color: #f4bf75;
}
.highlight .na {
  color: #6a9fb5;
}
.highlight .m, .highlight .mf, .highlight .mh, .highlight .mi, .highlight .il, .highlight .mo, .highlight .mb, .highlight .mx {
  color: #90a959;
}
.highlight .ss {
  color: #90a959;
}
    </style>
    <link href="../stylesheets/docs/screen.css" rel="stylesheet" media="screen" />
    <link href="../stylesheets/docs/print.css" rel="stylesheet" media="print" />
      <script src="../javascripts/docs/all.js"></script>
  </head>

  <body class="docs docs_index" data-languages="[]">
    <a href="#" id="nav-button">
      <span>
        NAV
        <img src="../images/navbar.png" />
      </span>
    </a>
    <div class="tocify-wrapper">
      <img src="../images/logo.png" />
        <div class="lang-selector">
        </div>
        <div class="search">
          <input type="text" class="search" id="input-search" placeholder="Search">
        </div>
        <ul class="search-results"></ul>
      <div id="toc">
      </div>
        <ul class="toc-footer">
            <li><a href='http://actionherojs.com'>ActionHero Website</a></li>
            <li><a href='https://github.com/evantahler/actionHero'>GitHub</a></li>
            <li><a href='https://www.npmjs.com/package/actionhero'>NPM</a></li>
            <li><a href='https://github.com/evantahler/actionHero/releases'>Relase History</a></li>
            <li><a href='https://groups.google.com/forum/#!forum/actionhero-js'>Mailing List</a></li>
            <li><a href='http://slack.actionherojs.com'>Chat</a></li>
            <li><br/></li>
            <li><a href='http://github.com/tripit/slate'>Documentation Powered by Slate</a></li>
        </ul>
    </div>
    <div class="page-wrapper">
      <div class="dark-box"></div>
      <div class="content">
        
          <h1 id="introduction">Introduction</h1>

<h2 id="who-is-the-actionhero">Who is the ActionHero?</h2>
<pre class="highlight shell"><code><span class="gp">&gt; </span>npm start

<span class="gp">&gt; </span>actionhero@12.2.2 start /Users/evantahler/Projects/actionhero
<span class="gp">&gt; </span>node ./bin/actionhero

info: actionhero &gt;&gt; start
2015-11-14 16:01:27 - notice: <span class="k">***</span> starting actionhero <span class="k">***</span>
2015-11-14 16:01:27 - info: actionhero member 10.0.1.15 has joined the cluster
2015-11-14 16:01:27 - notice: pid: 36087
2015-11-14 16:01:27 - notice: server ID: 10.0.1.15
2015-11-14 16:01:27 - info: ensuring the existence of the chatRoom: defaultRoom
2015-11-14 16:01:27 - info: ensuring the existence of the chatRoom: anotherRoom
2015-11-14 16:01:27 - notice: starting server: web
2015-11-14 16:01:27 - notice: starting server: websocket
2015-11-14 16:01:28 - notice: environment: development
2015-11-14 16:01:28 - notice: <span class="k">***</span> Server Started @ 2015-11-14 16:01:28 <span class="k">***</span>
</code></pre>

<p>ActionHero is a <a href="http://nodejs.org">node.js</a> <strong>API framework</strong> for both <strong>tcp sockets</strong>, <strong>web sockets</strong>, and <strong>http clients</strong>.  The goal of ActionHero is to create an easy-to-use toolkit for making <strong>reusable</strong> &amp; <strong>scalable</strong> APIs.  Clients connected to an ActionHero server can <strong>consume the api</strong>, <strong>consume static content</strong>, and <strong>communicate with each other</strong>.</p>

<p>ActionHero servers can process both requests and tasks (delayed actions like <code class="prettyprint">send e-mail</code> or other background jobs).  ActionHero servers can also run in a cluster (on the same or multiple machines) to work in concert to handle your load.</p>

<p>The ActionHero API defines a single access point and accepts GET, POST, PUT and DELETE input along with persistent connection via TCP or web sockets. You define <strong>Actions</strong> which handle input and response, such as <code class="prettyprint">userAdd</code> or <code class="prettyprint">geoLocate</code>. HTTP, HTTPS, and TCP clients can all use these actions.  The ActionHero API is not inherently &ldquo;RESTful&rdquo; (which is meaningless for persistent socket connections) but can be extended to be so if you wish.</p>

<p>ActionHero will also serve static files for you, but ActionHero is not a &lsquo;rendering&rsquo; server (like express or rails).</p>

<h2 id="contributing">Contributing</h2>

<p>The actionherojs.com website and documentation is hosted on <a href="http://pages.github.com/">GitHub Pages</a>.  You can submit pull requests to the <a href="https://github.com/evantahler/actionhero/tree/master/docs">master branch&rsquo;s <code class="prettyprint">docs</code> folder</a> within the ActionHero project.</p>

<h2 id="documentation-notes">Documentation Notes</h2>

<p>This documentation will always reflect the master branch of ActionHero, and therefore may be slightly ahead of the latest release on NPM.</p>

          <h1 id="getting-started">Getting Started</h1>

<h2 id="requirements">Requirements</h2>
<pre class="highlight shell"><code><span class="c"># On OSX With Homebrew:</span>

brew install node
brew install redis

<span class="c"># On Ubuntu:</span>

<span class="o">(</span>sudo<span class="o">)</span> apt-get install node
<span class="o">(</span>sudo<span class="o">)</span> apt-get install redis-server

<span class="c"># On Windows:</span>

<span class="o">[</span>download nodeJS]<span class="o">(</span>https://nodejs.org/en/download<span class="o">)</span>
<span class="o">[</span>download redis]<span class="o">(</span>https://github.com/MSOpenTech/redis<span class="o">)</span>
</code></pre>

<ul>
<li>node.js ( &gt;= v4.0.0)</li>
<li>npm</li>
<li>redis (for cluster support, cache, stats, and tasks); but not required.</li>
</ul>

<h2 id="install-amp-quickstart">Install &amp; Quickstart</h2>

<p><strong>Get Started Now:</strong></p>
<pre class="highlight shell"><code>mkdir ~/project <span class="o">&amp;&amp;</span> <span class="nb">cd</span> ~/project
npm install actionhero
./node_modules/.bin/actionhero generate
npm install
npm start
</code></pre>

<ul>
<li>Create a new directory <code class="prettyprint">mkdir ~/project &amp;&amp; cd ~/project</code></li>
<li>Checkout the actionhero source <code class="prettyprint">npm install actionhero</code></li>
<li>Use the generator to create a template project <code class="prettyprint">./node_modules/.bin/actionhero generate</code></li>
<li><code class="prettyprint">npm install</code> to install dependencies</li>
<li>You can now start up the server: <code class="prettyprint">npm start</code></li>
</ul>

<p>Visit <code class="prettyprint">http://127.0.0.1:8080</code> in your browser to see the actionhero in action!</p>

<p>You can also opt to install ActionHero globally <code class="prettyprint">npm install actionhero -g</code> and then you can just call <code class="prettyprint">actionhero start</code>.</p>

<h2 id="application-structure">Application Structure</h2>
<pre class="highlight shell"><code><span class="c"># ActionHero Project Layout</span>

|- config
| -- api.js
| -- errors.js
| -- i18n.js
| -- logger.js
| -- redis.js
| -- routes.js
| -- tasks.js
| -- servers
| ---- web.js
| ---- websocket.js
| ---- socket.js
|-- <span class="o">(</span>project settings<span class="o">)</span>
|
|- actions
|-- <span class="o">(</span>your actions<span class="o">)</span>
|
|- initializers
|-- <span class="o">(</span>any additional initializers you want<span class="o">)</span>
|
|- log
|-- <span class="o">(</span>default location <span class="k">for </span>logs<span class="o">)</span>
|
|- node_modules
|-- <span class="o">(</span>your modules, ActionHero should be npm installed <span class="k">in </span>here<span class="o">)</span>
|
|- pids
|-- <span class="o">(</span>pidfiles <span class="k">for </span>your running servers<span class="o">)</span>
|
|- public
|-- <span class="o">(</span>your static assets to be served by /file<span class="o">)</span>
|
|- servers
|-- <span class="o">(</span>custom servers you may make<span class="o">)</span>
|
|- tasks
|-- <span class="o">(</span>your tasks<span class="o">)</span>
|
|- locales
|-- <span class="o">(</span>translation files<span class="o">)</span>
|
|- tests
|-- <span class="o">(</span>tests <span class="k">for </span>your API<span class="o">)</span>
|
readme.md
package.json <span class="o">(</span>be sure to include <span class="s1">'actionhero'</span>:<span class="s1">'x'</span><span class="o">)</span>
</code></pre>

<p>The map to the right describes ActionHero&rsquo;s default project layout.</p>

<p>Actions in <code class="prettyprint">/actions</code> will be loaded in automatically, along <code class="prettyprint">/initializers</code> and <code class="prettyprint">/tasks</code>.</p>

<p><code class="prettyprint">/public</code> will become your application&rsquo;s default static asset location.   </p>

<p>If you wish to customize your project&rsquo;s paths, you can do so within <code class="prettyprint">config/api.js</code> in the <code class="prettyprint">api.config.general.paths</code> section</p>

<h2 id="tutorial">Tutorial</h2>

<p>Want to see an example application using ActionHero?  You can check out the code and follow the detailed guide <a href="https://github.com/evantahler/actionhero-tutorial">here (https://github.com/evantahler/actionhero-tutorial)</a>.  This project demonstrates many of the core features of ActionHero in a simple project.</p>

          <h1 id="all-diagrams">All Diagrams</h1>

<h2 id="actionhero-sections">ActionHero sections</h2>

<p><img src="../images/actionheroGraphic.png" /></p>

<h2 id="actionhero-action-request-flow">ActionHero Action Request Flow</h2>

<p><img src="../images/connection_flow_actions.png" /></p>

<h2 id="actionhero-task-request-flow">ActionHero Task Request Flow</h2>

<p><img src="../images/connection_flow_tasks.png" /></p>

<h2 id="cluster-topology">cluster topology</h2>

<p><img src="../images/cluster.png" /></p>

<h2 id="redis-configurations">redis configurations</h2>

<p><img src="../images/redis.png" /></p>

          <h1 id="actions">Actions</h1>

<h2 id="general">General</h2>
<pre class="highlight javascript"><code><span class="c1">/////////////////////</span>
<span class="c1">// A Simple Action //</span>
<span class="c1">/////////////////////</span>

<span class="nx">exports</span><span class="p">.</span><span class="nx">action</span> <span class="o">=</span> <span class="p">{</span>
  <span class="na">name</span><span class="p">:</span> <span class="s1">'randomNumber'</span><span class="p">,</span>
  <span class="na">description</span><span class="p">:</span> <span class="s1">'I am an API method which will generate a random number'</span><span class="p">,</span>
  <span class="na">outputExample</span><span class="p">:</span> <span class="p">{</span>
    <span class="na">randomNumber</span><span class="p">:</span> <span class="mf">0.123</span>
  <span class="p">},</span>

  <span class="na">run</span><span class="p">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">api</span><span class="p">,</span> <span class="nx">data</span><span class="p">,</span> <span class="nx">next</span><span class="p">){</span>
    <span class="nx">data</span><span class="p">.</span><span class="nx">response</span><span class="p">.</span><span class="nx">randomNumber</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">random</span><span class="p">();</span>
    <span class="nx">next</span><span class="p">();</span>
  <span class="p">}</span>

<span class="p">};</span>
</code></pre>

<p>The core of ActionHero is the Action framework, and <strong>actions</strong> are the basic units of work.  All connection types from all servers can use actions.  This means that you only need to write an action once, and both HTTP clients and websocket clients can consume it.</p>

<p>The goal of an action is to read <code class="prettyprint">data.params</code> (which are the arguments a connection provides), do work, and set the <code class="prettyprint">data.response</code> (and <code class="prettyprint">error</code> when needed) values to build the response to the client.</p>

<p>You can create you own actions by placing them in a <code class="prettyprint">./actions/</code> folder at the root of your application.  You can use the generator with <code class="prettyprint">actionhero generate action --name=myAction</code></p>

<p>Here&rsquo;s an example of a simple action which will return a random number to the client:</p>

<p>You can also define more than one action per file if you would like, to share common methods and components (like input parsers):</p>
<pre class="highlight javascript"><code>
<span class="c1">/////////////////////////////////////////</span>
<span class="c1">// A Combound Action with Shared Inputs//</span>
<span class="c1">/////////////////////////////////////////</span>

<span class="kd">var</span> <span class="nx">commonInputs</span> <span class="o">=</span> <span class="p">{</span>
  <span class="na">email</span><span class="p">:</span> <span class="p">{</span>
    <span class="na">required</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
    <span class="na">validator</span><span class="p">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">param</span><span class="p">){</span>
      <span class="kd">var</span> <span class="nx">re</span> <span class="o">=</span> <span class="sr">/^</span><span class="se">(([^</span><span class="sr">&lt;&gt;()[</span><span class="se">\]\\</span><span class="sr">.,;:</span><span class="se">\s</span><span class="sr">@</span><span class="se">\"]</span><span class="sr">+</span><span class="se">(\.[^</span><span class="sr">&lt;&gt;()[</span><span class="se">\]\\</span><span class="sr">.,;:</span><span class="se">\s</span><span class="sr">@</span><span class="se">\"]</span><span class="sr">+</span><span class="se">)</span><span class="sr">*</span><span class="se">)</span><span class="sr">|</span><span class="se">(\"</span><span class="sr">.+</span><span class="se">\"))</span><span class="sr">@</span><span class="se">((\[[</span><span class="sr">0-9</span><span class="se">]{1,3}\.[</span><span class="sr">0-9</span><span class="se">]{1,3}\.[</span><span class="sr">0-9</span><span class="se">]{1,3}\.[</span><span class="sr">0-9</span><span class="se">]{1,3}\])</span><span class="sr">|</span><span class="se">(([</span><span class="sr">a-zA-Z</span><span class="se">\-</span><span class="sr">0-9</span><span class="se">]</span><span class="sr">+</span><span class="se">\.)</span><span class="sr">+</span><span class="se">[</span><span class="sr">a-zA-Z</span><span class="se">]{2,}))</span><span class="sr">$/</span><span class="p">;</span>
      <span class="k">if</span><span class="p">(</span> <span class="nx">re</span><span class="p">.</span><span class="nx">test</span><span class="p">(</span><span class="nx">email</span><span class="p">)</span> <span class="p">){</span>
        <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
      <span class="p">}</span><span class="k">else</span><span class="p">{</span>
        <span class="k">return</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s1">'that is not a valid email address'</span><span class="p">);</span>
      <span class="p">}</span>
    <span class="p">},</span>  
  <span class="p">},</span>
  <span class="na">password</span><span class="p">:</span> <span class="p">{</span>
    <span class="na">required</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
    <span class="na">validator</span><span class="p">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">param</span><span class="p">){</span>
      <span class="k">if</span><span class="p">(</span><span class="nx">param</span><span class="p">.</span><span class="nx">length</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">){</span>
        <span class="k">return</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s1">'password should be at least 3 letters long'</span><span class="p">);</span>
      <span class="p">}</span><span class="k">else</span><span class="p">{</span>
        <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">},</span>
    <span class="na">formatter</span><span class="p">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">param</span><span class="p">){</span>
      <span class="k">return</span> <span class="nb">String</span><span class="p">(</span><span class="nx">param</span><span class="p">);</span>
    <span class="p">},</span>
  <span class="p">}</span>
<span class="p">};</span>

<span class="c1">// the actions</span>

<span class="nx">exports</span><span class="p">.</span><span class="nx">userAdd</span> <span class="o">=</span> <span class="p">{</span>
  <span class="na">name</span><span class="p">:</span> <span class="s1">'userAdd'</span><span class="p">,</span>
  <span class="na">description</span><span class="p">:</span> <span class="s1">'I add a user'</span><span class="p">,</span>
  <span class="na">inputs</span><span class="p">:</span> <span class="nx">commonInputs</span><span class="p">,</span>
  <span class="na">run</span><span class="p">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">api</span><span class="p">,</span> <span class="nx">data</span><span class="p">,</span> <span class="nx">next</span><span class="p">){</span>
    <span class="c1">// your code here</span>
    <span class="nx">next</span><span class="p">(</span><span class="nx">error</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">};</span>

<span class="nx">exports</span><span class="p">.</span><span class="nx">userDelete</span> <span class="o">=</span> <span class="p">{</span>
  <span class="na">name</span><span class="p">:</span> <span class="s1">'userDelete'</span><span class="p">,</span>
  <span class="na">description</span><span class="p">:</span> <span class="s1">'I delete a user'</span><span class="p">,</span>
  <span class="na">inputs</span><span class="p">:</span> <span class="nx">commonInputs</span><span class="p">,</span>
  <span class="na">run</span><span class="p">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">api</span><span class="p">,</span> <span class="nx">data</span><span class="p">,</span> <span class="nx">next</span><span class="p">){</span>
    <span class="c1">// your code here</span>
    <span class="nx">next</span><span class="p">(</span><span class="nx">error</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre>

<h2 id="versions">Versions</h2>

<p>ActionHero supports multiple versions of the same action.  This will allow you to support actions/routes of the same name with upgraded functionality.</p>

<ul>
<li>actions optionally have the <code class="prettyprint">action.version</code> attribute.</li>
<li>a reserved param, <code class="prettyprint">apiVersion</code> is used to directly specify the version of an action a client may request.</li>
<li>if a client doesn&rsquo;t specify an <code class="prettyprint">apiVersion</code>, they will be directed to the highest numerical version of that action.</li>
</ul>

<p>You can optionally create routes to handle your API versioning:</p>
<pre class="highlight javascript"><code><span class="nx">exports</span><span class="p">.</span><span class="nx">routes</span> <span class="o">=</span> <span class="p">{</span>
  <span class="na">all</span><span class="p">:</span> <span class="p">[</span>
    <span class="c1">// creates routes like `/api/myAction/1/` and `/api/myAction/2/`</span>
    <span class="c1">// will also default `/api/myAction` to the latest version</span>
    <span class="p">{</span> <span class="na">path</span><span class="p">:</span> <span class="s2">"/myAction/:apiVersion"</span><span class="p">,</span> <span class="na">action</span><span class="p">:</span> <span class="s2">"myAction"</span> <span class="p">},</span>

    <span class="c1">// creates routes like `/api/1/myAction/` and `/api/2/myAction/`</span>
    <span class="c1">// will also default `/api/myAction` to the latest version</span>
    <span class="p">{</span> <span class="na">path</span><span class="p">:</span> <span class="s2">"/:apiVersion/myAction"</span><span class="p">,</span> <span class="na">action</span><span class="p">:</span> <span class="s2">"myAction"</span> <span class="p">},</span>
  <span class="p">]</span>
<span class="p">};</span>
</code></pre>

<p><em>As a note, if a client accessing ActionHero via routes does not provide an apiVersion and it is explicitly defined in the route, the highest number will not be assigned automatically, and will be seen as a routing error.</em></p>

<h2 id="options">Options</h2>
<pre class="highlight javascript"><code><span class="nx">exports</span><span class="p">.</span><span class="nx">action</span> <span class="o">=</span> <span class="p">{</span>
  <span class="c1">// the action's name (the `exports` key doesn't matter)</span>
  <span class="na">name</span><span class="p">:</span> <span class="s2">"randomNumber"</span><span class="p">,</span>
  <span class="c1">// the description</span>
  <span class="na">description</span><span class="p">:</span> <span class="s2">"I am an API method which will generate a random number"</span><span class="p">,</span>
  <span class="c1">// a hash of all the inputs this action will accept</span>
  <span class="c1">// any inputs provided to the action not in this hash will be stripped</span>
  <span class="na">inputs</span><span class="p">:</span> <span class="p">{</span>
    <span class="na">multiplier</span><span class="p">:</span> <span class="p">{</span>
      <span class="na">required</span><span class="p">:</span> <span class="kc">false</span><span class="p">,</span>
      <span class="na">validator</span><span class="p">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">param</span><span class="p">,</span> <span class="nx">connection</span><span class="p">,</span> <span class="nx">actionTemplate</span><span class="p">){</span> <span class="k">if</span><span class="p">(</span><span class="nx">param</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">){</span>
        <span class="k">return</span> <span class="s1">'must be &gt; 0'</span> <span class="p">}</span><span class="k">else</span><span class="p">{</span> <span class="k">return</span> <span class="kc">true</span><span class="p">;</span> <span class="p">}</span>
      <span class="p">},</span>
      <span class="na">formatter</span><span class="p">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">param</span><span class="p">,</span> <span class="nx">connection</span><span class="p">,</span> <span class="nx">actionTemplate</span><span class="p">){</span>
        <span class="k">return</span> <span class="nb">parseInt</span><span class="p">(</span><span class="nx">param</span><span class="p">);</span>
      <span class="p">},</span>
      <span class="na">default</span><span class="p">:</span>   <span class="kd">function</span><span class="p">(</span><span class="nx">param</span><span class="p">,</span> <span class="nx">connection</span><span class="p">,</span> <span class="nx">actionTemplate</span><span class="p">){</span>
        <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
      <span class="p">},</span>
    <span class="p">}</span>
  <span class="p">},</span>
  <span class="c1">// any middlewares to apply before/after this action</span>
  <span class="c1">// global middleware will be applied automatically</span>
  <span class="na">middleware</span><span class="p">:</span> <span class="p">[],</span>
  <span class="c1">// an example response</span>
  <span class="na">outputExample</span><span class="p">:</span> <span class="p">{</span> <span class="na">randomNumber</span><span class="p">:</span> <span class="mi">123</span> <span class="p">},</span>
  <span class="c1">// you can choose to block certain servers from using this action</span>
  <span class="na">blockedConnectionTypes</span><span class="p">:</span> <span class="p">[</span><span class="s2">"webSocket"</span><span class="p">],</span>
  <span class="c1">// how should this action be logged?</span>
  <span class="na">logLevel</span><span class="p">:</span> <span class="s2">"warning"</span><span class="p">,</span>
  <span class="c1">// (HTTP only) if the route for this action includes an extension (like .jpg), should the response MIME be adjusted to match?</span>
  <span class="na">matchExtensionMimeType</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
  <span class="c1">// should this action appear wthin `api.documentation.documentation`</span>
  <span class="na">toDocument</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>

  <span class="na">run</span><span class="p">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">api</span><span class="p">,</span> <span class="nx">data</span><span class="p">,</span> <span class="nx">next</span><span class="p">){</span>
    <span class="kd">var</span> <span class="nx">error</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>

    <span class="nx">data</span><span class="p">.</span><span class="nx">response</span><span class="p">.</span><span class="nx">randomNumber</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">random</span><span class="p">()</span> <span class="o">*</span> <span class="nx">data</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">multiplier</span><span class="p">;</span>
    <span class="nx">next</span><span class="p">(</span><span class="nx">error</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre>

<p>The complete set of options an action can have are:</p>

<h2 id="inputs">Inputs</h2>
<pre class="highlight javascript"><code><span class="nx">action</span><span class="p">.</span><span class="nx">inputs</span> <span class="o">=</span> <span class="p">{</span>
  <span class="c1">// a simple input</span>
  <span class="c1">// defaults assume required = false</span>
  <span class="na">minimalInput</span><span class="p">:</span> <span class="p">{}</span>
  <span class="c1">// a complex input</span>
  <span class="nl">multiplier</span><span class="p">:</span> <span class="p">{</span>
    <span class="nl">required</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
    <span class="na">validator</span><span class="p">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">param</span><span class="p">,</span> <span class="nx">connection</span><span class="p">,</span> <span class="nx">actionTemplate</span><span class="p">){</span>
      <span class="k">if</span><span class="p">(</span><span class="nx">param</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">){</span> <span class="k">return</span> <span class="s1">'must be &gt; 0'</span><span class="p">;</span> <span class="p">}</span><span class="k">else</span><span class="p">{</span> <span class="k">return</span> <span class="kc">true</span><span class="p">;</span> <span class="p">}</span>
    <span class="p">},</span>
    <span class="na">formatter</span><span class="p">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">param</span><span class="p">,</span> <span class="nx">connection</span><span class="p">,</span> <span class="nx">actionTemplate</span><span class="p">){</span>
      <span class="k">return</span> <span class="nb">parseInt</span><span class="p">(</span><span class="nx">param</span><span class="p">);</span>
    <span class="p">},</span>
    <span class="na">default</span><span class="p">:</span>   <span class="kd">function</span><span class="p">(</span><span class="nx">param</span><span class="p">,</span> <span class="nx">connection</span><span class="p">,</span> <span class="nx">actionTemplate</span><span class="p">){</span>
      <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
    <span class="p">},</span>
  <span class="p">}</span>
<span class="p">};</span>
</code></pre>

<p>The properties of an input are:</p>

<ul>
<li><code class="prettyprint">required</code> (boolean)

<ul>
<li>Default: <code class="prettyprint">false</code></li>
</ul></li>
<li><code class="prettyprint">formatter = function(param, connection, actionTemplate)</code>

<ul>
<li>will return the new value of the param</li>
<li>Default: The parameter is not reformatted</li>
</ul></li>
<li><code class="prettyprint">default = function(param, connection, actionTemplate)</code>

<ul>
<li>will return the default value of the param</li>
<li>you can also have a static assignment for <code class="prettyprint">default</code> father than a function, ie: <code class="prettyprint">default: 123</code></li>
<li>Default: Parameter has no default value</li>
</ul></li>
<li><code class="prettyprint">validator = function(param, connection, actionTemplate)</code>

<ul>
<li>should return <code class="prettyprint">true</code> if validation passed</li>
<li>should return an error message if validation fails which will be returned to the client</li>
<li>Default: Parameter is always valid</li>
</ul></li>
</ul>

<p>You can define <code class="prettyprint">api.config.general.missingParamChecks = [null, &#39;&#39;, undefined]</code> to choose explicitly how you want un-set params to be handled in your actions.  For example, if you want to allow explicit <code class="prettyprint">null</code> values in a JSON payload but not <code class="prettyprint">undefined</code>, you can now opt-in to that behavior.  This is what <code class="prettyprint">action.inputs.x.required = true</code> will check against.</p>

<p>Since all properties of an input are optional, the smallest possible definition of an input is: <code class="prettyprint">name : {}</code>.  However, you should usually specify that an input is required (or not), ie: <code class="prettyprint">name: {required: false}</code>.  </p>

<p>The methods <code class="prettyprint">default</code>, <code class="prettyprint">formatter</code>, and <code class="prettyprint">validator</code> have the api object set as <code class="prettyprint">this</code> within their scopes.  This means that you can define common formatters within middleware and reference them in each action.</p>

<p>The methods are applied in this order:</p>

<ul>
<li><code class="prettyprint">default()</code></li>
<li><code class="prettyprint">formatter()</code></li>
<li><code class="prettyprint">validator()</code></li>
<li><code class="prettyprint">required()</code></li>
</ul>

<p>Here&rsquo;s an example&hellip;</p>
<pre class="highlight javascript"><code><span class="nx">moneyInCents</span><span class="err">:</span> <span class="p">{</span>
  <span class="nl">required</span><span class="p">:</span>  <span class="kc">true</span><span class="p">,</span>
  <span class="k">default</span><span class="err">:</span>   <span class="kd">function</span><span class="p">(</span><span class="nx">p</span><span class="p">){</span> <span class="k">return</span> <span class="mi">0</span><span class="p">;</span> <span class="p">},</span>
  <span class="nx">formatter</span><span class="err">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">p</span><span class="p">){</span> <span class="k">return</span> <span class="nb">parseFloat</span><span class="p">(</span><span class="nx">p</span><span class="p">);</span> <span class="p">},</span>
  <span class="nx">validator</span><span class="err">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">p</span><span class="p">){</span>
    <span class="k">if</span><span class="p">(</span><span class="nb">isNaN</span><span class="p">(</span><span class="nb">parseFloat</span><span class="p">(</span><span class="nx">p</span><span class="p">)){</span> <span class="k">return</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s1">'not a number'</span><span class="p">);</span> <span class="p">}</span>
    <span class="k">if</span><span class="p">(</span><span class="nx">p</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">){</span> <span class="k">return</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s1">'money cannot be negative'</span><span class="p">);</span> <span class="p">}</span>
    <span class="k">else</span><span class="p">{</span> <span class="k">return</span> <span class="kc">true</span><span class="p">;</span> <span class="p">}</span>
  <span class="p">},</span>
<span class="p">}</span>
</code></pre>

<p>&hellip;and the results would be:</p>

<ul>
<li>If moneyInCents = <code class="prettyprint">4</code>       =&gt; (4 =&gt; 4 =&gt; 400 =&gt; ok)</li>
<li>If moneyInCents = <code class="prettyprint">&quot;4&quot;</code>     =&gt; (&ldquo;4&rdquo; =&gt; 4 =&gt; 400 =&gt; ok)</li>
<li>If moneyInCents = <code class="prettyprint">&quot;-4&quot;</code>    =&gt; (&ldquo;-4&rdquo; =&gt; -4 =&gt; -400 =&gt; Error(&lsquo;money cannot be negative&rsquo;))</li>
<li>If moneyInCents = <code class="prettyprint">&quot;&quot;</code>      =&gt; 0 (default value)</li>
<li>If moneyInCents = <code class="prettyprint">null</code>    =&gt; 0 (default value)</li>
<li>If moneyInCents = <code class="prettyprint">&quot;hello&quot;</code> =&gt; Error(&#39;not a number&rsquo;)</li>
</ul>

<p>Formatters and Validators can also be named method names. For example, you might have an action like:</p>
<pre class="highlight javascript"><code><span class="nx">exports</span><span class="p">.</span><span class="nx">cacheTest</span> <span class="o">=</span> <span class="p">{</span>
  <span class="na">name</span><span class="p">:</span> <span class="s1">'cacheTest'</span><span class="p">,</span>
  <span class="na">description</span><span class="p">:</span> <span class="s1">'I will test the internal cache functions of the API'</span><span class="p">,</span>
  <span class="na">outputExample</span><span class="p">:</span> <span class="p">{},</span>

  <span class="na">inputs</span><span class="p">:</span> <span class="p">{</span>
    <span class="na">key</span><span class="p">:</span> <span class="p">{</span>
      <span class="na">required</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
      <span class="na">formatter</span><span class="p">:</span> <span class="p">[</span>
         <span class="kd">function</span><span class="p">(</span><span class="nx">s</span><span class="p">){</span> <span class="k">return</span> <span class="nb">String</span><span class="p">(</span><span class="nx">s</span><span class="p">);</span> <span class="p">},</span>
         <span class="s1">'api.formatter.uniqueKeyName'</span> <span class="c1">// &lt;----------- HERE</span>
      <span class="p">]</span>
    <span class="p">},</span>
    <span class="na">value</span><span class="p">:</span> <span class="p">{</span>
      <span class="na">required</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
      <span class="na">formatter</span><span class="p">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">s</span><span class="p">){</span> <span class="k">return</span> <span class="nb">String</span><span class="p">(</span><span class="nx">s</span><span class="p">);</span> <span class="p">},</span>
      <span class="na">validator</span><span class="p">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">s</span><span class="p">){</span>
        <span class="k">if</span><span class="p">(</span><span class="nx">s</span><span class="p">.</span><span class="nx">length</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">){</span> <span class="k">return</span> <span class="s1">'`value` should be at least 3 letters long'</span><span class="p">;</span> <span class="p">}</span>
        <span class="k">else</span><span class="p">{</span> <span class="k">return</span> <span class="kc">true</span><span class="p">;</span> <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">},</span>
  <span class="p">},</span>

  <span class="na">run</span><span class="p">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">api</span><span class="p">,</span> <span class="nx">data</span><span class="p">,</span> <span class="nx">next</span><span class="p">){</span>
    <span class="c1">// ...</span>
  <span class="p">}</span>

<span class="p">};</span>
</code></pre>

<p>You can define <code class="prettyprint">api.formatter.uniqueKeyName</code> elsewhere in your project, like this initializer:</p>
<pre class="highlight javascript"><code><span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="p">{</span>
  <span class="na">initialize</span><span class="p">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">api</span><span class="p">,</span> <span class="nx">next</span><span class="p">){</span>
    <span class="nx">api</span><span class="p">.</span><span class="nx">formatter</span> <span class="o">=</span> <span class="p">{</span>
      <span class="na">uniqueKeyName</span><span class="p">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">key</span><span class="p">){</span>
        <span class="k">return</span> <span class="nx">key</span> <span class="o">+</span> <span class="s1">'-'</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">connection</span><span class="p">.</span><span class="nx">id</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">};</span>

    <span class="nx">next</span><span class="p">();</span>
  <span class="p">},</span>
<span class="p">};</span>
</code></pre>

<h2 id="the-data-object">The Data Object</h2>
<pre class="highlight javascript"><code><span class="nx">data</span> <span class="o">=</span> <span class="p">{</span>
  <span class="na">connection</span><span class="p">:</span> <span class="nx">connection</span><span class="p">,</span>
  <span class="na">action</span><span class="p">:</span> <span class="s1">'randomNumber'</span><span class="p">,</span>
  <span class="na">toProcess</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
  <span class="na">toRender</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
  <span class="na">messageCount</span><span class="p">:</span> <span class="mi">123</span><span class="p">,</span>
  <span class="na">params</span><span class="p">:</span> <span class="p">{</span> <span class="na">action</span><span class="p">:</span> <span class="s1">'randomNumber'</span><span class="p">,</span> <span class="na">apiVersion</span><span class="p">:</span> <span class="mi">1</span> <span class="p">},</span>
  <span class="na">actionStartTime</span><span class="p">:</span> <span class="mi">123</span><span class="p">,</span>
  <span class="na">response</span><span class="p">:</span> <span class="p">{},</span>
<span class="p">}</span>
</code></pre>

<p>The <code class="prettyprint">data</code> object passed into your action captures the state of the connection at the time the action was started.  Midleware preProcessors have already fired, and input formatting and validation has occurred.  Here are the properties of the <code class="prettyprint">data</code> object:</p>

<p>The goal of most actions is to do work and then modify the value of <code class="prettyprint">data.response</code>, which will eventually be sent down to the client.  </p>

<p>You can also modify properties of the connection by accessing <code class="prettyprint">data.connection</code>, IE changing the response header for a HTTP request.  </p>

<p>If you don&rsquo;t want your action to respond to the client, or you have already sent data to the client (perhaps you already rendered a file to them or sent an error HTTP header), you can set <code class="prettyprint">data.toRender = false;</code></p>

<h2 id="using-middleware-in-actions">Using Middleware in Actions</h2>

<p>You can create middlware which would apply to the connection both before and after an action.  Middleware can be either global (applied to all actions) or local, speficied in each action via <code class="prettyprint">action.middleware = []</code>.  Supply the <code class="prettyprint">names</code> of any middleware you want to use.</p>

<p>You can <a href="/docs#middleware">learn more about middleware here</a>.</p>

<h2 id="notes">Notes</h2>

<ul>
<li>Actions are asynchronous, and require in the API object, the <code class="prettyprint">data</code> object, and the callback function.  Completing an action is as simple as calling <code class="prettyprint">next(error)</code>.  If you have an error, be sure that it is a <code class="prettyprint">new Error()</code> object, and not a string.</li>
<li>The metadata <code class="prettyprint">outputExample</code> is used in reflexive and self-documenting actions in the API, available via the <code class="prettyprint">documentation</code> verb (and /api/ showDocumenation action).<br></li>
<li>You can limit how many actions a persistent client (websocket, tcp, etc) can have pending at once with <code class="prettyprint">api.config.general.simultaniousActions</code></li>
<li><code class="prettyprint">actions.inputs</code> are used for both documentation and for building the whitelist of allowed parameters the API will accept.  Client params not included in these whitelists will be ignored for security. If you wish to disable the whitelisting you can use the flag at <code class="prettyprint">api.config.general.disableParamScrubbing</code>. Note that <a href="/docs#middleware">Middleware</a> preProcessors will always have access to all params pre-scrubbing.</li>
<li><code class="prettyprint">matchExtensionMimeType</code> is curently only used by the <code class="prettyprint">web</code> server, and it indicates that if this action is successfully called by a client with <code class="prettyprint">connection.extension</code> set, the headers of the response should be changed to match that file type.  This is useful when creating actions that download files.</li>
<li>ActionHero strives to keep the <code class="prettyprint">data.connection</code> object uniform among various client types, and more importantly, present <code class="prettyprint">data.params</code> in a homogenous way.  You can inspect <code class="prettyprint">data.connection.type</code> to learn more about the connection.  The gory details of the connection (which vary on its type) are stored in <code class="prettyprint">data.connection.rawConnection</code> which will contain the websocket, tcp connection, etc.  For web clients, <code class="prettyprint">data.connection.rawConnection = {req: req, res: res}</code> for example.<br>

<ul>
<li>You can learn more about some of the <code class="prettyprint">rawConnection</code> options by learning how to <a href="/docs#sending-files-from-actions">send files from actions</a>.</li>
</ul></li>
</ul>

<p><a href="/docs#uploading-files">You can learn more about handling HTTP verbs and file uploads here</a> and <a href="/docs#files-and-routes">TCP Clients</a> and <a href="/docs#websocket-server">Web-Socket Clients</a></p>

          <h1 id="tasks">Tasks</h1>

<h2 id="general">General</h2>

<p>Tasks are background jobs meant to be run separately from a client&rsquo;s request.  They can be started by an action or by the server itself.  With ActionHero, there is no need to run a separate daemon to process these jobs.  ActionHero uses the <a href="https://github.com/taskrabbit/node-resque">node-resque</a> package to store and process tasks in a way compatible with the <a href="https://github.com/resque/resque">resque</a> ecosystem.</p>

<p>There are 3 types of tasks ActionHero can process: <code class="prettyprint">normal</code>, <code class="prettyprint">delayed</code>, and <code class="prettyprint">periodic</code>.</p>

<ul>
<li><code class="prettyprint">normal</code> tasks are enqueued and processed one-by-one by the task TaskProcessors</li>
<li><code class="prettyprint">delayed</code> tasks are enqueued in a special &lsquo;delayed&rsquo; queue to only be processed at some time in the future (defined either by a timestamp in ms or miliseconds-from-now)</li>
<li><code class="prettyprint">periodic</code> tasks are like delayed tasks, but they run on a set frequency (e.g. every 5 minutes).<br>

<ul>
<li>Periodic tasks can take no input parameters.</li>
</ul></li>
</ul>

<h2 id="enqueuing-a-task">Enqueuing a Task</h2>
<pre class="highlight javascript"><code><span class="c1">// Enqueue the task now, and process it ASAP</span>
<span class="c1">// api.tasks.enqueue(nameOfTask, args, queue, callback)</span>
<span class="nx">api</span><span class="p">.</span><span class="nx">tasks</span><span class="p">.</span><span class="nx">enqueue</span><span class="p">(</span><span class="s2">"sendWelcomeEmail"</span><span class="p">,</span> <span class="p">{</span><span class="na">to</span><span class="p">:</span> <span class="s1">'evan@evantahler.com'</span><span class="p">},</span> <span class="s1">'default'</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">error</span><span class="p">,</span> <span class="nx">toRun</span><span class="p">){</span>
  <span class="c1">// enqueued!</span>
<span class="p">});</span>

<span class="c1">// Enqueue the task now, and process it once `timestamp` has arrived</span>
<span class="c1">// api.tasks.enqueueAt(timestamp, nameOfTask, args, queue, callback)</span>
<span class="nx">api</span><span class="p">.</span><span class="nx">tasks</span><span class="p">.</span><span class="nx">enqueueAt</span><span class="p">(</span><span class="mi">1234556</span><span class="p">,</span> <span class="s2">"sendWelcomeEmail"</span><span class="p">,</span> <span class="p">{</span><span class="na">to</span><span class="p">:</span> <span class="s1">'evan@evantahler.com'</span><span class="p">},</span> <span class="s1">'default'</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">error</span><span class="p">,</span> <span class="nx">toRun</span><span class="p">){</span>
  <span class="c1">// enqueued!</span>
<span class="p">});</span>

<span class="c1">// Enqueue the task now, and process it once `delay` (ms) has passed</span>
<span class="c1">// api.tasks.enqueueIn(delay, nameOfTask, args, queue, callback)</span>
<span class="nx">api</span><span class="p">.</span><span class="nx">tasks</span><span class="p">.</span><span class="nx">enqueueIn</span><span class="p">(</span><span class="mi">10000</span><span class="p">,</span> <span class="s2">"sendWelcomeEmail"</span><span class="p">,</span> <span class="p">{</span><span class="na">to</span><span class="p">:</span> <span class="s1">'evan@evantahler.com'</span><span class="p">},</span> <span class="s1">'default'</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">error</span><span class="p">,</span> <span class="nx">toRun</span><span class="p">){</span>
  <span class="c1">// enqueued!</span>
<span class="p">});</span>
</code></pre>

<p>Here are examples of the 3 ways to programmatically enqueue a task.</p>

<p>&ldquo;sendWelcomeEmail&rdquo; should be a task defined in the project, and <code class="prettyprint">{to: &#39;evan@evantahler.com&#39;}</code> are arguments to that task.  This task will be processed by TaskProcessors assigned to the &#39;default queue&rsquo;.</p>

<p>You can also enqueue tasks to be run at some time in the future (timestamp is in ms):</p>

<p><code class="prettyprint">enqueueAt</code> asks for a timestamp (in ms) to run at, and <code class="prettyprint">enqueueIn</code> asks for the number of ms from now to run.</p>

<p>The final type of task, periodic tasks, are defined with a <code class="prettyprint">task.frequency</code> of greater than 0, and are loaded in by ActionHero when it boots.  You cannot modify these tasks once the server is running.</p>

<h2 id="processing-tasks">Processing Tasks</h2>
<pre class="highlight javascript"><code><span class="c1">// From /config/tasks.js:</span>

<span class="nx">exports</span><span class="p">.</span><span class="k">default</span> <span class="o">=</span> <span class="p">{</span>
  <span class="na">tasks</span><span class="p">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">api</span><span class="p">){</span>
    <span class="k">return</span> <span class="p">{</span>
      <span class="c1">// Should this node run a scheduler to promote delayed tasks?</span>
      <span class="na">scheduler</span><span class="p">:</span> <span class="kc">false</span><span class="p">,</span>
      <span class="c1">// what queues should the TaskProcessors work?</span>
      <span class="na">queues</span><span class="p">:</span> <span class="p">[</span><span class="s1">'*'</span><span class="p">],</span>
      <span class="c1">// Logging levels of task workers</span>
      <span class="na">workerLogging</span> <span class="p">:</span> <span class="p">{</span>
        <span class="na">failure</span>   <span class="p">:</span> <span class="s1">'error'</span><span class="p">,</span> <span class="c1">// task failure</span>
        <span class="na">success</span>   <span class="p">:</span> <span class="s1">'info'</span><span class="p">,</span>  <span class="c1">// task success</span>
        <span class="na">start</span>     <span class="p">:</span> <span class="s1">'info'</span><span class="p">,</span>
        <span class="na">end</span>       <span class="p">:</span> <span class="s1">'info'</span><span class="p">,</span>
        <span class="na">cleaning_worker</span> <span class="p">:</span> <span class="s1">'info'</span><span class="p">,</span>
        <span class="na">poll</span>      <span class="p">:</span> <span class="s1">'debug'</span><span class="p">,</span>
        <span class="na">job</span>       <span class="p">:</span> <span class="s1">'debug'</span><span class="p">,</span>
        <span class="na">pause</span>     <span class="p">:</span> <span class="s1">'debug'</span><span class="p">,</span>
        <span class="na">internalError</span> <span class="p">:</span> <span class="s1">'error'</span><span class="p">,</span>
        <span class="na">multiWorkerAction</span> <span class="p">:</span> <span class="s1">'debug'</span>
      <span class="p">},</span>
      <span class="c1">// Logging levels of the task scheduler</span>
      <span class="na">schedulerLogging</span> <span class="p">:</span> <span class="p">{</span>
        <span class="na">start</span>     <span class="p">:</span> <span class="s1">'info'</span><span class="p">,</span>
        <span class="na">end</span>       <span class="p">:</span> <span class="s1">'info'</span><span class="p">,</span>
        <span class="na">poll</span>      <span class="p">:</span> <span class="s1">'debug'</span><span class="p">,</span>
        <span class="na">enqueue</span>   <span class="p">:</span> <span class="s1">'debug'</span><span class="p">,</span>
        <span class="na">reEnqueue</span> <span class="p">:</span> <span class="s1">'debug'</span><span class="p">,</span>
        <span class="na">working_timestamp</span> <span class="p">:</span> <span class="s1">'debug'</span><span class="p">,</span>
        <span class="na">transferred_job</span>   <span class="p">:</span> <span class="s1">'debug'</span>
      <span class="p">},</span>
      <span class="c1">// how long to sleep between jobs / scheduler checks</span>
      <span class="na">timeout</span><span class="p">:</span> <span class="mi">5000</span><span class="p">,</span>
      <span class="c1">// at minimum, how many parallel taskProcessors should this node spawn?</span>
      <span class="c1">// (have number &gt; 0 to enable, and &lt; 1 to disable)</span>
      <span class="na">minTaskProcessors</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
      <span class="c1">// at maximum, how many parallel taskProcessors should this node spawn?</span>
      <span class="na">maxTaskProcessors</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
      <span class="c1">// how often should we check the event loop to spawn more TaskProcessors?</span>
      <span class="na">checkTimeout</span><span class="p">:</span> <span class="mi">500</span><span class="p">,</span>
      <span class="c1">// how many ms would constitue an event loop delay to halt TaskProcessors spawning?</span>
      <span class="na">maxEventLoopDelay</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span>
      <span class="c1">// When we kill off a taskProcessor, should we disonnect that local redis connection?</span>
      <span class="na">toDisconnectProcessors</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
      <span class="c1">// Customize Resque primitives, replace null with required replacement.</span>
      <span class="na">resque_overrides</span><span class="p">:</span> <span class="p">{</span>
        <span class="na">queue</span><span class="p">:</span> <span class="kc">null</span><span class="p">,</span>
        <span class="na">multiWorker</span><span class="p">:</span> <span class="kc">null</span><span class="p">,</span>
        <span class="na">scheduler</span><span class="p">:</span> <span class="kc">null</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre>

<p>To work these tasks, you need to run ActionHero with at least one <code class="prettyprint">taskProcessor</code>.  <code class="prettyprint">TaskProcessor</code>s run in-line with the rest of your server and process jobs.  This is controlled by settings in <a href="https://github.com/evantahler/actionhero/blob/master/config/tasks.js">/config/tasks.js</a>.</p>

<p>If you are enqueuing delayed or periodic tasks, you also need to enable the scheduler.  This is a part of ActionHero that will periodically check the delayed queues for jobs that are ready to work now, and move them to the normal queues when the time comes.</p>

<p>Because node and ActionHero are asynchronous, we can process more than one job at a time.  However, if the jobs we are processing are CPU-intensive, we want to limit how many we are working on at one time.  To do this, we tell ActionHero to run somewhere between <code class="prettyprint">minTaskProcessors</code> and <code class="prettyprint">maxTaskProcessors</code> and check every so often if the server could be working more or less jobs at a time.  Depending on the response characteristics you want for your server, you can modify these values.  </p>

<p>In production, it is best to set up some ActionHero servers that only handle requests from clients (that is, servers with no TaskProcessors) and others that handle no requests, and only process jobs (that is, no servers, many <code class="prettyprint">TaskProcessor</code>s).</p>

<p>As you noticed above, when you enqueue a task, you tell it which queue to be enqueued within.  This is so you can separate load or priority.  For example, you might have a <code class="prettyprint">high</code> priority queue which does jobs like &ldquo;sendPushMessage&rdquo; and a <code class="prettyprint">low</code> priority queue which does a task like &ldquo;cleanupCache&rdquo;.  You tell the <code class="prettyprint">taskProcessor</code>s which jobs to work, and in which priority. For the example above, you would ensure that all <code class="prettyprint">high</code> jobs happen before all <code class="prettyprint">low</code> jobs by setting: <code class="prettyprint">api.config.tasks.queues = [&#39;high&#39;, &#39;low&#39;]</code>.
You could also configure more nodes to work on the <code class="prettyprint">high</code> queue than the <code class="prettyprint">low</code> queue, thus further ensuring that <code class="prettyprint">high</code> priority jobs are processed faster and sooner than <code class="prettyprint">low</code> priority jobs.</p>

<h2 id="creating-a-task">Creating a Task</h2>
<pre class="highlight javascript"><code><span class="c1">// define a single task in a file</span>

<span class="kd">var</span> <span class="nx">task</span> <span class="o">=</span> <span class="p">{</span>
  <span class="na">name</span><span class="p">:</span>          <span class="s2">"sendWelcomeEmail"</span><span class="p">,</span>
  <span class="na">description</span><span class="p">:</span>   <span class="s2">"I will send a new user a welcome email"</span><span class="p">,</span>
  <span class="na">queue</span><span class="p">:</span>         <span class="s2">"default"</span><span class="p">,</span>
  <span class="na">plugins</span><span class="p">:</span>       <span class="p">[],</span>
  <span class="na">pluginOptions</span><span class="p">:</span> <span class="p">[],</span>
  <span class="na">frequency</span><span class="p">:</span>     <span class="mi">0</span><span class="p">,</span>
  <span class="na">run</span><span class="p">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">api</span><span class="p">,</span> <span class="nx">params</span><span class="p">,</span> <span class="nx">next</span><span class="p">){</span>
    <span class="nx">api</span><span class="p">.</span><span class="nx">sendEmail</span><span class="p">(</span><span class="nx">params</span><span class="p">.</span><span class="nx">email</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">error</span><span class="p">){</span>
      <span class="nx">next</span><span class="p">(</span><span class="nx">error</span><span class="p">);</span> <span class="c1">//task will fail if sendEmail does</span>
    <span class="p">})</span>
  <span class="p">}</span>
<span class="p">};</span>

<span class="nx">exports</span><span class="p">.</span><span class="nx">task</span> <span class="o">=</span> <span class="nx">task</span><span class="p">;</span>

<span class="c1">// define multiple tasks (so you can share methods)</span>

<span class="nx">exports</span><span class="p">.</span><span class="nx">sayHello</span> <span class="o">=</span> <span class="p">{</span>
  <span class="na">name</span><span class="p">:</span>          <span class="s1">'sayHello'</span><span class="p">,</span>
  <span class="na">description</span><span class="p">:</span>   <span class="s1">'I say hello'</span><span class="p">,</span>
  <span class="na">queue</span><span class="p">:</span>         <span class="s2">"default"</span><span class="p">,</span>
  <span class="na">plugins</span><span class="p">:</span>       <span class="p">[],</span>
  <span class="na">pluginOptions</span><span class="p">:</span> <span class="p">[],</span>
  <span class="na">frequency</span><span class="p">:</span>     <span class="mi">1000</span><span class="p">,</span>
  <span class="na">run</span><span class="p">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">api</span><span class="p">,</span> <span class="nx">params</span><span class="p">,</span> <span class="nx">next</span><span class="p">){</span>
    <span class="nx">api</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">"hello"</span><span class="p">)</span>
    <span class="nx">next</span><span class="p">();</span>
  <span class="p">}</span>
<span class="p">};</span>

<span class="nx">exports</span><span class="p">.</span><span class="nx">sayGoodbye</span> <span class="o">=</span> <span class="p">{</span>
  <span class="na">name</span><span class="p">:</span>          <span class="s1">'sayGoodbye'</span><span class="p">,</span>
  <span class="na">description</span><span class="p">:</span>   <span class="s1">'I say goodbye'</span><span class="p">,</span>
  <span class="na">queue</span><span class="p">:</span>         <span class="s2">"default"</span><span class="p">,</span>
  <span class="na">plugins</span><span class="p">:</span>       <span class="p">[],</span>
  <span class="na">pluginOptions</span><span class="p">:</span> <span class="p">[],</span>
  <span class="na">frequency</span><span class="p">:</span>     <span class="mi">2000</span><span class="p">,</span>
  <span class="na">run</span><span class="p">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">api</span><span class="p">,</span> <span class="nx">params</span><span class="p">,</span> <span class="nx">next</span><span class="p">){</span>
    <span class="nx">api</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">"goodbye"</span><span class="p">)</span>
    <span class="nx">next</span><span class="p">();</span>
  <span class="p">}</span>
<span class="p">};</span>
</code></pre>
<pre class="highlight shell"><code><span class="c"># The output of running the last 2 tasks would be:</span>

2013-11-28 15:21:56 - debug: resque scheduler working timestamp 1385680913
2013-11-28 15:21:56 - debug: resque scheduler enquing job 1385680913 <span class="nv">class</span><span class="o">=</span>sayHello, <span class="nv">queue</span><span class="o">=</span>default,
2013-11-28 15:21:56 - debug: resque scheduler working timestamp 1385680914
2013-11-28 15:21:56 - debug: resque scheduler enquing job 1385680914 <span class="nv">class</span><span class="o">=</span>sayGoodbye, <span class="nv">queue</span><span class="o">=</span>default,
2013-11-28 15:21:56 - debug: resque worker <span class="c">#1 working job default class=sayHello, queue=default,</span>
2013-11-28 15:21:56 - info: hello
2013-11-28 15:21:56 - debug: re-enqueued reccurent job sayHello
2013-11-28 15:21:56 - debug: resque worker <span class="c">#1 working job default class=sayGoodbye, queue=default,</span>
2013-11-28 15:21:56 - info: goodbye
2013-11-28 15:21:56 - debug: re-enqueued reccurent job sayGoodbye
</code></pre>

<p>You can create you own tasks by placing them in a <code class="prettyprint">./tasks/</code> directory at the root of your application.  You can use the generator <code class="prettyprint">actionhero generate task --name=myTask</code>. Like actions, all tasks have some required metadata:</p>

<ul>
<li><code class="prettyprint">task.name</code>: The unique name of your task</li>
<li><code class="prettyprint">task.description</code>: a description</li>
<li><code class="prettyprint">task.queue</code>: the default queue to run this task within (can be overwritten when enqueued)</li>
<li><code class="prettyprint">task.frequency</code>: In milliseconds, how often should I run?.  A frequency of &gt;0 denotes this task as periodic and ActionHero will automatically enqueued when the server boots.  Only one instance of a periodic task will be enqueued within the cluster at a time, regardless of how many ActionHero nodes are connected.</li>
<li><code class="prettyprint">task.plugins</code>: You can use resque plugins in your task from the node-resque project.  Plugins modify how your tasks are enqueued.  For example, if you use the <code class="prettyprint">queue-lock</code> plugin, only one instance of any job (with similar arguments) can be enqueued at a time.  You can learn more about plugins from the <a href="https://github.com/taskrabbit/node-resque#plugins">node-resque project</a>.</li>
<li><code class="prettyprint">task.pluginOptions</code>: a hash of options for the plugins</li>
</ul>

<p><code class="prettyprint">task.run</code> contains the actual work that the task does. It takes the following arguments:</p>

<ul>
<li><code class="prettyprint">api</code>: The ActionHero api object</li>
<li><code class="prettyprint">params</code>: An array of parameters that the task was enqueued with. This is whatever was passed as the second argument to <code class="prettyprint">api.tasks.enqueue</code></li>
<li><code class="prettyprint">next</code>: A callback to call when the task is done. This callback is of the type <code class="prettyprint">function(error, result)</code>.

<ul>
<li>Passing an <code class="prettyprint">error</code> object will cause the job to be marked as a failure.</li>
<li>The result is currently not captured anywhere.</li>
</ul></li>
</ul>

<h2 id="queue-inspection">Queue Inspection</h2>

<p>ActionHero provides some methods to help inspect the state of your queue.  You can use these methods to check if your jobs are processing in a timely manner, if there are errors in task processing, etc.</p>

<h3 id="api-tasks-scheduledat-queue-taskname-args-next">api.tasks.scheduledAt(queue, taskName, args, next)</h3>

<ul>
<li>next(error, timestamps)</li>
<li>finds all matching instances of queue + taskName + args from the delayed queues</li>
<li>timestamps will be an array of the delayed timestamps</li>
</ul>

<h3 id="api-tasks-del-queue-taskname-args-count-next">api.tasks.del(queue, taskName, args, count, next)</h3>

<ul>
<li>next(error, count)</li>
<li>removes all matching instances of queue + taskName + args from the normal queues</li>
<li>count is how many instances of this task were removed</li>
</ul>

<h3 id="api-tasks-deldelayed-queue-taskname-args-next">api.tasks.delDelayed(queue, taskName, args, next)</h3>

<ul>
<li>next(error, timestamps)</li>
<li>removes all matching instances of queue + taskName + args from the delayed queues</li>
<li>timestamps will be an array of the delayed timestamps which the task was removed from</li>
</ul>

<h3 id="api-tasks-delqueue-queue-next">api.tasks.delQueue(queue, next)</h3>

<ul>
<li>next(error)</li>
<li>removes all jobs in a resque queue</li>
</ul>

<h3 id="api-tasks-enqueuerecurrentjob-taskname-next">api.tasks.enqueueRecurrentJob(taskName, next)</h3>

<ul>
<li>next()</li>
<li>will enqueue are recurring job</li>
<li>might not actually enqueue the job if it is already enqueued due to resque plugins</li>
</ul>

<h3 id="api-tasks-stoprecurrentjob-taskname-next">api.tasks.stopRecurrentJob(taskName, next)</h3>

<ul>
<li>next(error, removedCount)</li>
<li>will remove all instances of <code class="prettyprint">taskName</code> from the delayed queues and normal queues</li>
<li>removedCount will inform you of how many instances of this job were removed</li>
</ul>

<h3 id="api-tasks-timestamps-next">api.tasks.timestamps(next)</h3>

<ul>
<li>next(error, timestamps)</li>
<li>will return an array of all timesamps which have at least one job scheduled to be run</li>
<li>for use with <code class="prettyprint">api.tasks.delayedAt</code></li>
</ul>

<h3 id="api-tasks-queued-q-start-stop-next">api.tasks.queued(q, start, stop, next)</h3>

<ul>
<li>next(error, jobs)</li>
<li>will return an array of all pending jobs in a resque queue (paginated via start/stop)</li>
</ul>

<h3 id="api-tasks-stats-next">api.tasks.stats(next)</h3>

<ul>
<li>next(error, stats)</li>
<li>will return an array of all stats from your resque cluster</li>
</ul>

<h3 id="api-tasks-locks-next">api.tasks.locks(next)</h3>

<ul>
<li>next(error, locks)</li>
<li>will return an array of all locks from your resque cluster (both queue and worker)</li>
</ul>

<h3 id="api-tasks-dellock-lockname-next">api.tasks.delLock(lockName, next)</h3>

<ul>
<li>next(error, count)</li>
<li>will return the count of locks deleted (if any)</li>
</ul>

<h3 id="api-tasks-delayedat-timestamp-next">api.tasks.delayedAt(timestamp, next)</h3>

<ul>
<li>next(error, jobs)</li>
<li>will return the list of jobs enqueued to run after this timestamp</li>
</ul>

<h3 id="api-tasks-alldelayed-next">api.tasks.allDelayed(next)</h3>

<ul>
<li>next(error, jobs)</li>
<li>will return the list of all jobs enqueued by the timestamp they are enqueued to run at</li>
</ul>

<h3 id="api-tasks-workers-next">api.tasks.workers(next)</h3>

<ul>
<li>next(error, workers)</li>
<li>list all taskProcessors</li>
</ul>

<h3 id="api-tasks-workingon-workername-queues-next">api.tasks.workingOn(workerName, queues, next)</h3>

<ul>
<li>next(error, status)</li>
<li>list what a specific taskProcessors (defined by the name of the server + queues) is working on (or sleeping)</li>
</ul>

<h3 id="api-tasks-allworkingon-next">api.tasks.allWorkingOn(next)</h3>

<ul>
<li>next(error, workers)</li>
<li>list what all taskProcessors are working on (or sleeping)</li>
</ul>

<h3 id="api-tasks-details-next">api.tasks.details(next)</h3>

<ul>
<li>next(error, details)</li>
<li>details is a hash of all the queues in the system and how long they are</li>
<li>this method also returns metadata about the taskProcessors and what they are currently working on</li>
</ul>

<h3 id="api-tasks-failedcount-next">api.tasks.failedCount(next)</h3>

<ul>
<li>next(error, failedCount)</li>
<li><code class="prettyprint">failedCount</code> is how many resque jobs are in the failed queue.</li>
</ul>

<h3 id="api-tasks-failed-start-stop-next">api.tasks.failed(start, stop, next)</h3>

<ul>
<li>next(error, failedJobs)</li>
<li><code class="prettyprint">failedJobs</code> is an array listing the data of the failed jobs.  You can see an example at https://github.com/taskrabbit/node-resque#failed-job-managment</li>
</ul>

<h3 id="api-tasks-removefailed-failedjob-next">api.tasks.removeFailed(failedJob, next)</h3>

<ul>
<li>next(error, removedCount)</li>
<li>the input <code class="prettyprint">failedJob</code> is an expanded node object representing the failed job, retrieved via <code class="prettyprint">api.tasks.failed</code></li>
</ul>

<h3 id="api-tasks-retryandremovefailed-failedjob-next">api.tasks.retryAndRemoveFailed(failedJob, next)</h3>

<ul>
<li>next(error, failedJob)</li>
<li>the error <code class="prettyprint">failedJob</code> is an expanded node object representing the failed job, retrieved via <code class="prettyprint">api.tasks.failed</code></li>
</ul>

<h2 id="job-schedules">Job Schedules</h2>
<pre class="highlight javascript"><code><span class="c1">// file: initializers/node_schedule.js</span>

<span class="kd">var</span> <span class="nx">schedule</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'node-schedule'</span><span class="p">);</span>

<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="p">{</span>
  <span class="na">initialize</span><span class="p">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">api</span><span class="p">,</span> <span class="nx">next</span><span class="p">){</span>
    <span class="nx">api</span><span class="p">.</span><span class="nx">scheduledJobs</span> <span class="o">=</span> <span class="p">[];</span>
    <span class="nx">next</span><span class="p">();</span>
  <span class="p">},</span>

  <span class="na">start</span><span class="p">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">api</span><span class="p">,</span> <span class="nx">next</span><span class="p">){</span>

    <span class="c1">// do this job every 10 seconds, cron style</span>
    <span class="kd">var</span> <span class="nx">job</span> <span class="o">=</span> <span class="nx">schedule</span><span class="p">.</span><span class="nx">scheduleJob</span><span class="p">(</span><span class="s1">'0,10,20,30,40,50 * * * * *'</span><span class="p">,</span> <span class="kd">function</span><span class="p">(){</span>
      <span class="c1">// we want to ensure that only one instance of this job is scheduled in our environment at once,</span>
      <span class="c1">// no matter how many schedulers we have running</span>

      <span class="k">if</span><span class="p">(</span><span class="nx">api</span><span class="p">.</span><span class="nx">resque</span><span class="p">.</span><span class="nx">scheduler</span> <span class="o">&amp;&amp;</span> <span class="nx">api</span><span class="p">.</span><span class="nx">resque</span><span class="p">.</span><span class="nx">scheduler</span><span class="p">.</span><span class="nx">master</span><span class="p">){</span>
        <span class="nx">api</span><span class="p">.</span><span class="nx">tasks</span><span class="p">.</span><span class="nx">enqueue</span><span class="p">(</span><span class="s1">'sayHello'</span><span class="p">,</span> <span class="p">{</span><span class="na">time</span><span class="p">:</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">().</span><span class="nx">toString</span><span class="p">()},</span> <span class="s1">'default'</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">error</span><span class="p">){</span>
          <span class="k">if</span><span class="p">(</span><span class="nx">error</span><span class="p">){</span> <span class="nx">api</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">error</span><span class="p">,</span> <span class="s1">'error'</span><span class="p">);</span> <span class="p">}</span>
        <span class="p">});</span>
      <span class="p">}</span>
    <span class="p">});</span>

    <span class="nx">api</span><span class="p">.</span><span class="nx">scheduledJobs</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">job</span><span class="p">);</span>

    <span class="nx">next</span><span class="p">();</span>
  <span class="p">},</span>

  <span class="na">stop</span><span class="p">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">api</span><span class="p">,</span> <span class="nx">next</span><span class="p">){</span>
    <span class="nx">api</span><span class="p">.</span><span class="nx">scheduledJobs</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">job</span><span class="p">){</span>
      <span class="nx">job</span><span class="p">.</span><span class="nx">canel</span><span class="p">();</span>
    <span class="p">});</span>

    <span class="nx">next</span><span class="p">();</span>
  <span class="p">}</span>
<span class="p">};</span>
</code></pre>

<p>You may want to schedule jobs every minute/hour/day, like a distributed CRON job.  There are a number of excellent node packages to help you with this, like <a href="https://github.com/tejasmanohar/node-schedule">node-schedule</a> and <a href="https://github.com/ncb000gt/node-cron">node-cron</a>.  ActionHero exposes <a href="https://github.com/taskrabbit/node-resque">node-resque&rsquo;s</a> scheduler to you so you can use the scheduler package of your choice.  </p>

<p>Assuming you are running ActionHero across multiple machines, you will need to ensure that only one of your processes is actually scheduling the jobs.  To help you with this, you can inspect which of the scheduler processes is correctly acting as master, and flag only the master scheduler process to run the schedule.  An <a href="/docs#initializers">initializer for this</a> would look like:</p>

<p>Be sure to have the scheduler enabled on at least one of your ActionHero servers!</p>

<h2 id="failed-job-management">Failed Job Management</h2>
<pre class="highlight javascript"><code>
<span class="kd">var</span> <span class="nx">removeStuckWorkersOlderThan</span> <span class="o">=</span> <span class="mi">10000</span><span class="p">;</span> <span class="c1">// 10000ms</span>
<span class="nx">api</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'removing stuck workers solder than '</span> <span class="o">+</span> <span class="nx">removeStuckWorkersOlderThan</span> <span class="o">+</span> <span class="s1">'ms'</span><span class="p">,</span> <span class="s1">'info'</span><span class="p">);</span>
<span class="nx">api</span><span class="p">.</span><span class="nx">tasks</span><span class="p">.</span><span class="nx">cleanOldWorkers</span><span class="p">(</span><span class="nx">removeStuckWorkersOlderThan</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">error</span><span class="p">,</span> <span class="nx">result</span><span class="p">){</span>
  <span class="k">if</span><span class="p">(</span><span class="nx">error</span><span class="p">){</span>
    <span class="nx">api</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">error</span><span class="p">,</span> <span class="s1">'error'</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="k">if</span><span class="p">(</span><span class="nb">Object</span><span class="p">.</span><span class="nx">keys</span><span class="p">(</span><span class="nx">result</span><span class="p">).</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">){</span>
    <span class="nx">api</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'removed stuck workers with errors: '</span><span class="p">,</span> <span class="s1">'info'</span><span class="p">,</span> <span class="nx">result</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="nx">callback</span><span class="p">();</span>
<span class="p">});</span>

</code></pre>

<p>Sometimes a worker crashes is a severe way, and it doesn&rsquo;t get the time/chance to notify redis that it is leaving the pool (this happens all the time on PAAS providers like Heroku). When this happens, you will not only need to extract the job from the now-zombie worker&rsquo;s &ldquo;working on&rdquo; status, but also remove the stuck worker. To aid you in these edge cases, <code class="prettyprint">api.tasks.cleanOldWorkers(age, callback)</code> is available.</p>

<p>Because there are no &#39;heartbeats&rsquo; in resque, it is impossible for the application to know if a worker has been working on a long job or it is dead. You are required to provide an &ldquo;age&rdquo; for how long a worker has been &ldquo;working&rdquo;, and all those older than that age will be removed, and the job they are working on moved to the error queue (where you can then use <code class="prettyprint">api.tasks.retryAndRemoveFailed</code>) to re-enqueue the job.</p>

<p>You can handle this with an own initializer and the following logic =&gt;</p>

<h2 id="extending-resque">Extending Resque</h2>

<p>In cases where you would like to extend or modify the underlying behaviour or capabilities of Resque you can specify
replacements for the Queues, Scheduler, or Multi Worker implementations in the Tasks configuration.</p>
<pre class="highlight javascript"><code><span class="c1">// From /config/tasks.js:</span>
<span class="kd">var</span> <span class="nx">myQueue</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'../util/myQueue.js'</span><span class="p">);</span>

<span class="nx">exports</span><span class="p">.</span><span class="k">default</span> <span class="o">=</span> <span class="p">{</span>
  <span class="na">tasks</span><span class="p">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">api</span><span class="p">){</span>
    <span class="k">return</span> <span class="p">{</span>
      <span class="p">...</span>
      <span class="c1">// Customize Resque primitives, replace null with required replacement.</span>
      <span class="na">resque_overrides</span><span class="p">:</span> <span class="p">{</span>
        <span class="na">queue</span><span class="p">:</span> <span class="nx">myQueue</span><span class="p">,</span>  <span class="c1">//&lt;-- Explicitly pass replacement Queue implementation</span>
        <span class="na">multiWorker</span><span class="p">:</span> <span class="kc">null</span><span class="p">,</span>
        <span class="na">scheduler</span><span class="p">:</span> <span class="kc">null</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre>
<pre class="highlight javascript"><code><span class="c1">//From util/myQueue.js:</span>
<span class="kd">var</span> <span class="nx">NR</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'node-resque'</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">pluginRunner</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'../node_modules/node-resque/lib/pluginRunner.js'</span><span class="p">);</span>

<span class="kd">let</span> <span class="nx">myQueue</span> <span class="o">=</span> <span class="nx">NR</span><span class="p">.</span><span class="nx">queue</span><span class="p">;</span>

<span class="nx">myQueue</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">enqueueFront</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">q</span><span class="p">,</span> <span class="nx">func</span><span class="p">,</span> <span class="nx">args</span><span class="p">,</span> <span class="nx">callback</span><span class="p">){</span>
  <span class="kd">var</span> <span class="nx">self</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
  <span class="k">if</span><span class="p">(</span><span class="nx">arguments</span><span class="p">.</span><span class="nx">length</span> <span class="o">===</span> <span class="mi">3</span> <span class="o">&amp;&amp;</span> <span class="k">typeof</span> <span class="nx">args</span> <span class="o">===</span> <span class="s1">'function'</span><span class="p">){</span>
   <span class="nx">callback</span> <span class="o">=</span> <span class="nx">args</span><span class="p">;</span>
   <span class="nx">args</span> <span class="o">=</span> <span class="p">[];</span>
  <span class="p">}</span><span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="nx">arguments</span><span class="p">.</span><span class="nx">length</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">){</span>
   <span class="nx">args</span> <span class="o">=</span> <span class="p">[];</span>
  <span class="p">}</span>

  <span class="nx">args</span> <span class="o">=</span> <span class="nx">arrayify</span><span class="p">(</span><span class="nx">args</span><span class="p">);</span>
  <span class="kd">var</span> <span class="nx">job</span> <span class="o">=</span> <span class="nx">self</span><span class="p">.</span><span class="nx">jobs</span><span class="p">[</span><span class="nx">func</span><span class="p">];</span>
  <span class="nx">pluginRunner</span><span class="p">.</span><span class="nx">runPlugins</span><span class="p">(</span><span class="nx">self</span><span class="p">,</span> <span class="s1">'before_enqueue'</span><span class="p">,</span> <span class="nx">func</span><span class="p">,</span> <span class="nx">q</span><span class="p">,</span> <span class="nx">job</span><span class="p">,</span> <span class="nx">args</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">toRun</span><span class="p">){</span>
   <span class="k">if</span><span class="p">(</span><span class="nx">toRun</span> <span class="o">===</span> <span class="kc">false</span><span class="p">){</span>
     <span class="k">if</span><span class="p">(</span><span class="k">typeof</span> <span class="nx">callback</span> <span class="o">===</span> <span class="s1">'function'</span><span class="p">){</span> <span class="nx">callback</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">toRun</span><span class="p">);</span> <span class="p">}</span>
   <span class="p">}</span><span class="k">else</span><span class="p">{</span>
     <span class="nx">self</span><span class="p">.</span><span class="nx">connection</span><span class="p">.</span><span class="nx">redis</span><span class="p">.</span><span class="nx">sadd</span><span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">connection</span><span class="p">.</span><span class="nx">key</span><span class="p">(</span><span class="s1">'queues'</span><span class="p">),</span> <span class="nx">q</span><span class="p">,</span> <span class="kd">function</span><span class="p">(){</span>
       <span class="nx">self</span><span class="p">.</span><span class="nx">connection</span><span class="p">.</span><span class="nx">redis</span><span class="p">.</span><span class="nx">lpush</span><span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">connection</span><span class="p">.</span><span class="nx">key</span><span class="p">(</span><span class="s1">'queue'</span><span class="p">,</span> <span class="nx">q</span><span class="p">),</span> <span class="nx">self</span><span class="p">.</span><span class="nx">encode</span><span class="p">(</span><span class="nx">q</span><span class="p">,</span> <span class="nx">func</span><span class="p">,</span> <span class="nx">args</span><span class="p">),</span> <span class="kd">function</span><span class="p">(){</span>
         <span class="nx">pluginRunner</span><span class="p">.</span><span class="nx">runPlugins</span><span class="p">(</span><span class="nx">self</span><span class="p">,</span> <span class="s1">'after_enqueue'</span><span class="p">,</span> <span class="nx">func</span><span class="p">,</span> <span class="nx">q</span><span class="p">,</span> <span class="nx">job</span><span class="p">,</span> <span class="nx">args</span><span class="p">,</span> <span class="kd">function</span><span class="p">(){</span>
           <span class="k">if</span><span class="p">(</span><span class="k">typeof</span> <span class="nx">callback</span> <span class="o">===</span> <span class="s1">'function'</span><span class="p">){</span> <span class="nx">callback</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">toRun</span><span class="p">);</span> <span class="p">}</span>
         <span class="p">});</span>
       <span class="p">});</span>
     <span class="p">});</span>
   <span class="p">}</span>
  <span class="p">});</span>
<span class="p">};</span>

<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="nx">myQueue</span><span class="p">;</span>
</code></pre>

<p>The above example will give you access to <code class="prettyprint">api.resque.queue.enqueueFront()</code>, which you could use directly or wrap by
extending the <code class="prettyprint">api.tasks</code> object.</p>

<h2 id="notes">Notes</h2>

<p>Note that the <code class="prettyprint">frequency</code>, <code class="prettyprint">enqueueIn</code> and <code class="prettyprint">enqueueAt</code> times are when a task is <strong>allowed</strong> to run, not when it <strong>will</strong> run.  TaskProcessors will work tasks in a first-in-first-out manner.  TaskProcessors also <code class="prettyprint">sleep</code> when there is no work to do, and will take some time (default 5 seconds) to wake up and check for more work to do.</p>

<p>Remember that each ActionHero server uses one thread and one event loop, so that if you have computationally intensive task (like computing Fibonacci numbers), this <strong>will</strong> block tasks, actions, and clients from working.  However, if your tasks are meant to communicate with external services (reading from a database, sending an email, etc), then these are perfect candidates to be run simultaneously as the single thread can work on other things while waiting for these operations to complete.  </p>

<p>Tasks are stored in redis.  Be sure to enable non-fake redis if you want your tasks to persist and be shared across more than one ActionHero server.</p>

<p>If you are running a single ActionHero server, all tasks will be run locally.  As you add more servers, the work will be split evenly across all nodes.  It is very likely that your job will be run on different nodes each time.</p>

          <h1 id="middleware">Middleware</h1>

<p>There are 4 types of middleware in ActionHero:</p>

<ul>
<li>Action</li>
<li>Connection</li>
<li>Chat</li>
<li>Task</li>
</ul>
<pre class="highlight shell"><code><span class="gp">&gt; </span>Client Connects
<span class="c">#     connection middleware, `create` hook</span>
<span class="gp">&gt; </span>Client requests an action
<span class="c">#     action middleware, `preProcessor` hook</span>
<span class="c">#     action middleware, `postProcessor` hook</span>
<span class="gp">&gt; </span>Client joins a room
<span class="c">#     chat middleware, `join` hook</span>
<span class="gp">&gt; </span>Client says a message <span class="k">in </span>a room
<span class="c">#     chat middleware, `say` hook</span>
<span class="c">#     chat middleware, `onSayReceive` hook</span>
<span class="gp">&gt; </span>Client requests a disconnect <span class="o">(</span>quit<span class="o">)</span>
<span class="c">#     chat middleware, `leave` hook</span>
<span class="c">#     connection middleware, `destroy` hook</span>
<span class="gp">&gt; </span>Client executes a task
<span class="c">#     task middleware, `preProcessor` hook</span>
<span class="c">#     task middleware, `postProcessor` hook</span>
</code></pre>

<p>Each type of middleware is distinct from the others, and operates on distinct parts of a client&rsquo;s lifecycle.  For a logical example, please inspect the following connection lifecycle:</p>

<h2 id="action-request-flow">Action Request Flow</h2>

<p><img src="../images/connection_flow_actions.png" /></p>

<h2 id="action-middleware">Action Middleware</h2>
<pre class="highlight javascript"><code><span class="kd">var</span> <span class="nx">middleware</span> <span class="o">=</span> <span class="p">{</span>
  <span class="na">name</span><span class="p">:</span> <span class="s1">'userId checker'</span><span class="p">,</span>
  <span class="na">global</span><span class="p">:</span> <span class="kc">false</span><span class="p">,</span>
  <span class="na">priority</span><span class="p">:</span> <span class="mi">1000</span><span class="p">,</span>
  <span class="na">preProcessor</span><span class="p">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">data</span><span class="p">,</span> <span class="nx">next</span><span class="p">){</span>
    <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">data</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">userId</span><span class="p">){</span>
      <span class="nx">next</span><span class="p">(</span><span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s1">'All actions require a userId'</span><span class="p">)</span> <span class="p">);</span>
    <span class="p">}</span><span class="k">else</span><span class="p">{</span>
      <span class="nx">next</span><span class="p">();</span>
    <span class="p">}</span>
  <span class="p">},</span>
  <span class="na">postProcessor</span><span class="p">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">data</span><span class="p">,</span> <span class="nx">next</span><span class="p">){</span>
    <span class="k">if</span><span class="p">(</span><span class="nx">data</span><span class="p">.</span><span class="nx">thing</span><span class="p">.</span><span class="nx">stuff</span> <span class="o">==</span> <span class="kc">false</span><span class="p">){</span>
      <span class="nx">data</span><span class="p">.</span><span class="nx">toRender</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="nx">next</span><span class="p">(</span><span class="nx">error</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="nx">api</span><span class="p">.</span><span class="nx">actions</span><span class="p">.</span><span class="nx">addMiddleware</span><span class="p">(</span><span class="nx">middleware</span><span class="p">);</span>
</code></pre>

<p>ActionHero provides hooks for you to execute custom code both before and after the execution of all or some actions.  This is a great place to write authentication logic or custom loggers.  </p>

<p>Action middleware requires a <code class="prettyprint">name</code> and at least one of <code class="prettyprint">preProcessor</code> or <code class="prettyprint">postProcessor</code>.  Middleware can be <code class="prettyprint">global</code>, or you can choose to apply each middleware to an action specifically via <code class="prettyprint">action.middleware = []</code> in the action&rsquo;s definition.  You supply a list of middleware names, like <code class="prettyprint">action.middleware = [&#39;userId checker&#39;]</code> in the example above.</p>

<p>Each processor is passed <code class="prettyprint">data</code> and the callback <code class="prettyprint">next</code>.  Just like within actions, you can modify the <code class="prettyprint">data</code> object to add to <code class="prettyprint">data.response</code> to create a response to the client.  If you pass <code class="prettyprint">error</code> to the callback <code class="prettyprint">next</code>, that error will be returned to the client.  If a <code class="prettyprint">preProcessor</code> has an error, the action will never be called.</p>

<p>The priority of a middleware orders it with all other middleware which might fire for an action.  Lower numbers happen first.  If you do not provide a priority, the default from <code class="prettyprint">api.config.general.defaultProcessorPriority</code> will be used</p>

<h2 id="the-data-object">The Data Object</h2>

<p><code class="prettyprint">data</code> contains:</p>
<pre class="highlight javascript"><code><span class="nx">data</span> <span class="o">=</span> <span class="p">{</span>
  <span class="na">connection</span><span class="p">:</span> <span class="p">{},</span>
  <span class="na">action</span><span class="p">:</span> <span class="s1">'randomNumber'</span><span class="p">,</span>
  <span class="na">toProcess</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
  <span class="na">toRender</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
  <span class="na">messageCount</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
  <span class="na">params</span><span class="p">:</span> <span class="p">{</span> <span class="na">action</span><span class="p">:</span> <span class="s1">'randomNumber'</span><span class="p">,</span> <span class="na">apiVersion</span><span class="p">:</span> <span class="mi">1</span> <span class="p">},</span>
  <span class="na">missingParams</span><span class="p">:</span> <span class="p">[],</span>
  <span class="na">validatorErrors</span><span class="p">:</span> <span class="p">[],</span>
  <span class="na">actionStartTime</span><span class="p">:</span> <span class="mi">1429531553417</span><span class="p">,</span>
  <span class="na">actionTemplate</span><span class="p">:</span> <span class="p">{},</span> <span class="c1">// the actual object action definition</span>
  <span class="na">working</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
  <span class="na">response</span><span class="p">:</span> <span class="p">{},</span>
  <span class="na">duration</span><span class="p">:</span> <span class="kc">null</span><span class="p">,</span>
  <span class="na">actionStatus</span><span class="p">:</span> <span class="kc">null</span><span class="p">,</span>
<span class="p">}</span>
</code></pre>

<h2 id="connection-middleware">Connection Middleware</h2>
<pre class="highlight javascript"><code><span class="kd">var</span> <span class="nx">connectionMiddleware</span> <span class="o">=</span> <span class="p">{</span>
  <span class="na">name</span><span class="p">:</span> <span class="s1">'connection middleware'</span><span class="p">,</span>
  <span class="na">priority</span><span class="p">:</span> <span class="mi">1000</span><span class="p">,</span>
  <span class="na">create</span><span class="p">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">connection</span><span class="p">){</span>
    <span class="c1">// do stuff</span>
  <span class="p">},</span>
  <span class="na">destroy</span><span class="p">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">connection</span><span class="p">){</span>
    <span class="c1">// do stuff</span>
  <span class="p">}</span>
<span class="p">};</span>

<span class="nx">api</span><span class="p">.</span><span class="nx">connections</span><span class="p">.</span><span class="nx">addMiddleware</span><span class="p">(</span><span class="nx">connectionMiddleware</span><span class="p">);</span>
</code></pre>

<p>Like the action middleware above, you can also create middleware to react to the creation or destruction of all connections.  Unlike action middleware, connection middleware is non-blocking and connection logic will continue as normal regardless of what you do in this type of middleware.</p>

<p>Keep in mind that some connections persist (webSocket, socket) and some only exist for the duration of a single request (web).  You will likely want to inspect <code class="prettyprint">connection.type</code> in this middleware.  Again, if you do not provide a priority, the default from <code class="prettyprint">api.config.general.defaultProcessorPriority</code> will be used.</p>

<p>Any modification made to the connection at this stage may happen either before or after an action, and may or may not persist to the connection depending on how the server is implemented.</p>

<h2 id="chat-middleware">Chat Middleware</h2>
<pre class="highlight javascript"><code><span class="kd">var</span> <span class="nx">chatMiddleware</span> <span class="o">=</span> <span class="p">{</span>
  <span class="na">name</span><span class="p">:</span> <span class="s1">'chat middleware'</span><span class="p">,</span>
  <span class="na">priority</span><span class="p">:</span> <span class="mi">1000</span><span class="p">,</span>
  <span class="na">join</span><span class="p">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">connection</span><span class="p">,</span> <span class="nx">room</span><span class="p">,</span> <span class="nx">callback</span><span class="p">){</span>
    <span class="c1">// announce all connections entering a room</span>
    <span class="nx">api</span><span class="p">.</span><span class="nx">chatRoom</span><span class="p">.</span><span class="nx">broadcast</span><span class="p">({},</span> <span class="nx">room</span><span class="p">,</span> <span class="s1">'I have joined the room: '</span> <span class="o">+</span> <span class="nx">connection</span><span class="p">.</span><span class="nx">id</span><span class="p">,</span> <span class="nx">callback</span><span class="p">);</span>
  <span class="p">},</span>
  <span class="na">leave</span><span class="p">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">connection</span><span class="p">,</span> <span class="nx">room</span><span class="p">,</span> <span class="nx">callback</span><span class="p">){</span>
    <span class="c1">// announce all connections leaving a room</span>
    <span class="nx">api</span><span class="p">.</span><span class="nx">chatRoom</span><span class="p">.</span><span class="nx">broadcast</span><span class="p">({},</span> <span class="nx">room</span><span class="p">,</span> <span class="s1">'I have left the room: '</span> <span class="o">+</span> <span class="nx">connection</span><span class="p">.</span><span class="nx">id</span><span class="p">,</span> <span class="nx">callback</span><span class="p">);</span>
  <span class="p">},</span>
  <span class="cm">/**
   * Will be executed once per client connection before delivering the message.
   */</span>
  <span class="na">say</span><span class="p">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">connection</span><span class="p">,</span> <span class="nx">room</span><span class="p">,</span> <span class="nx">messagePayload</span><span class="p">,</span> <span class="nx">callback</span><span class="p">){</span>
    <span class="c1">// do stuff</span>
    <span class="nx">api</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">messagePayload</span><span class="p">);</span>
    <span class="nx">callback</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="nx">messagePayload</span><span class="p">);</span>
  <span class="p">},</span>
  <span class="cm">/**
   * Will be executed only once, when the message is sent to the server.
   */</span>
  <span class="na">onSayReceive</span><span class="p">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">connection</span><span class="p">,</span> <span class="nx">room</span><span class="p">,</span> <span class="nx">messagePayload</span><span class="p">,</span> <span class="nx">callback</span><span class="p">){</span>
    <span class="c1">// do stuff</span>
    <span class="nx">api</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">messagePayload</span><span class="p">);</span>
    <span class="nx">callback</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="nx">messagePayload</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">};</span>

<span class="nx">api</span><span class="p">.</span><span class="nx">chatRoom</span><span class="p">.</span><span class="nx">addMiddleware</span><span class="p">(</span><span class="nx">chatMiddleware</span><span class="p">);</span>
</code></pre>

<p>The last type of middleware is used to act when a connection joins, leaves, or communicates within a chat room. We have 4 types of middleware for each step: <code class="prettyprint">say</code>, <code class="prettyprint">onSayReceive</code>, <code class="prettyprint">join</code>, and <code class="prettyprint">leave</code>.</p>

<p>Priority is optional in all cases, but can be used to order your middleware.  If an error is returned in any of these methods, it will be returend to the user, and the action/verb/message will not be sent.</p>

<p>More detail and nuance on chat middleware can be found in the <a href="/docs#chat">chat section</a></p>

<h3 id="chat-midleware-notes">Chat Midleware Notes</h3>

<ul>
<li>In the example above, I want to announce the member joining the room, but he has not yet been added to the room, as the callback chain is still firing.  If the connection itself were to make the broadcast, it would fail because the connection is not in the room.  Instead, an empty <code class="prettyprint">{}</code> connection is used to proxy the message coming from the &lsquo;system&rsquo;</li>
<li>Only the <code class="prettyprint">sayCallbacks</code> have a second return value on the callback, <code class="prettyprint">messagePayload</code>.  This allows you to modify the message being sent to your clients.</li>
<li><code class="prettyprint">messagePayload</code> will be modified and and passed on to all <code class="prettyprint">addSayCallback</code> middlewares inline, so you can append and modify it as you go</li>
<li>If you have a number of callbacks (<code class="prettyprint">say</code>, <code class="prettyprint">onSayReceive</code>, <code class="prettyprint">join</code> or  <code class="prettyprint">leave</code>), the priority maters, and you can block subsequent methods from firing by returning an error to the callback.</li>
<li><code class="prettyprint">sayCallbacks</code> are executed once per client connection. This makes it suitable for customizing the message based on the individual client.</li>
<li><code class="prettyprint">onSayReceiveCallbacks</code> are executed only once, when the message is sent to the server.</li>
</ul>
<pre class="highlight javascript"><code><span class="c1">// in this example no one will be able to join any room, and the `say` callback will never be invoked.</span>

<span class="nx">api</span><span class="p">.</span><span class="nx">chatRoom</span><span class="p">.</span><span class="nx">addMiddleware</span><span class="p">({</span>
  <span class="na">name</span><span class="p">:</span> <span class="s1">'blocking chat middleware'</span><span class="p">,</span>
  <span class="na">join</span><span class="p">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">connection</span><span class="p">,</span> <span class="nx">room</span><span class="p">,</span> <span class="nx">callback</span><span class="p">){</span>
    <span class="nx">callback</span><span class="p">(</span><span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s1">'blocked from joining the room'</span><span class="p">));</span>
  <span class="p">}),</span>
  <span class="na">say</span><span class="p">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">connection</span><span class="p">,</span> <span class="nx">room</span><span class="p">,</span> <span class="nx">messagePayload</span><span class="p">,</span> <span class="nx">callback</span><span class="p">){</span>
    <span class="nx">api</span><span class="p">.</span><span class="nx">chatRoom</span><span class="p">.</span><span class="nx">broadcast</span><span class="p">({},</span> <span class="nx">room</span><span class="p">,</span> <span class="s1">'I have entered the room: '</span> <span class="o">+</span> <span class="nx">connection</span><span class="p">.</span><span class="nx">id</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">e</span><span class="p">){</span>
      <span class="nx">callback</span><span class="p">();</span>
    <span class="p">});</span>
  <span class="p">},</span>
<span class="p">});</span>
</code></pre>

<p>If a <code class="prettyprint">say</code> is blocked/errored, the message will simply not be delivered to the client.  If a  <code class="prettyprint">join</code> or  <code class="prettyprint">leave</code> is blocked/errored, the verb or method used to invoke the call will be returned that error.</p>

<h2 id="task-request-flow">Task Request Flow</h2>

<p><img src="../images/connection_flow_tasks.png" /></p>

<h2 id="task-middleware">Task Middleware</h2>

<p>Task middleware is implemented as a thin wrapper around Node Resque plugins and currently exposes the <code class="prettyprint">before_perform</code>,
<code class="prettyprint">after_perform</code>, <code class="prettyprint">before_enqueue</code>, and <code class="prettyprint">after_enqueue</code> functions of Resque plugins through <code class="prettyprint">preProcessor</code>, <code class="prettyprint">postProcessor</code>,
 <code class="prettyprint">preEnqueue</code>, and <code class="prettyprint">postEnqueue</code> methods. Each middleware requires a <code class="prettyprint">name</code> and at least one function. In addition,
 a middleware can be global, in which case it also requires a <code class="prettyprint">priority</code>.</p>

<p>In the <code class="prettyprint">preProcessor</code>, you can access the original task <code class="prettyprint">params</code> through <code class="prettyprint">this.args[0]</code>.
 In the <code class="prettyprint">postProcessor</code>, you can access the task result at <code class="prettyprint">this.worker.result</code>.
 In the <code class="prettyprint">preEnqueue</code> and <code class="prettyprint">postEnqueue</code> you can access the task <code class="prettyprint">params</code> through <code class="prettyprint">this.args[0]</code>. If you wish to prevent a task from being enqueued
 using the <code class="prettyprint">preEnqueue</code> middleware you must explicitly set the <code class="prettyprint">toRun</code> value to <code class="prettyprint">false</code> in the callback.
 Because the task middleware is executed by Resque <code class="prettyprint">this</code> is an instance of a Resque Worker and contains a number of
 other elements which may be useful in a middleware.</p>

<h3 id="task-middlware-example">Task Middlware Example</h3>

<p>The following example is a simplistic implementation of a task execution timer middleware.</p>
<pre class="highlight javascript"><code><span class="s1">'use strict'</span><span class="p">;</span>

<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="p">{</span>
  <span class="na">loadPriority</span><span class="p">:</span>  <span class="mi">1000</span><span class="p">,</span>
  <span class="na">initialize</span><span class="p">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">api</span><span class="p">,</span> <span class="nx">next</span><span class="p">){</span>
    <span class="nx">api</span><span class="p">.</span><span class="nx">taskTimer</span> <span class="o">=</span> <span class="p">{</span>
      <span class="na">middleware</span><span class="p">:</span> <span class="p">{</span>
        <span class="na">name</span><span class="p">:</span> <span class="s1">'timer'</span><span class="p">,</span>
        <span class="na">global</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
        <span class="na">priority</span><span class="p">:</span> <span class="mi">90</span><span class="p">,</span>
        <span class="na">preProcessor</span><span class="p">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">next</span><span class="p">){</span>
          <span class="kd">var</span> <span class="nx">worker</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">worker</span><span class="p">;</span>
          <span class="nx">worker</span><span class="p">.</span><span class="nx">start</span> <span class="o">=</span> <span class="nx">process</span><span class="p">.</span><span class="nx">hrtime</span><span class="p">();</span>
          <span class="nx">next</span><span class="p">();</span>
        <span class="p">},</span>
        <span class="na">postProcessor</span><span class="p">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">next</span><span class="p">){</span>
          <span class="kd">var</span> <span class="nx">worker</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">worker</span><span class="p">;</span>
          <span class="kd">var</span> <span class="nx">elapsed</span> <span class="o">=</span> <span class="nx">process</span><span class="p">.</span><span class="nx">hrtime</span><span class="p">(</span><span class="nx">worker</span><span class="p">.</span><span class="nx">start</span><span class="p">);</span>
          <span class="kd">var</span> <span class="nx">seconds</span> <span class="o">=</span> <span class="nx">elapsed</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
          <span class="kd">var</span> <span class="nx">millis</span> <span class="o">=</span> <span class="nx">elapsed</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="mi">1000000</span><span class="p">;</span>
          <span class="nx">api</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'Task '</span> <span class="o">+</span> <span class="nx">worker</span><span class="p">.</span><span class="nx">job</span><span class="p">.</span><span class="kr">class</span> <span class="o">+</span> <span class="s1">' finished in '</span> <span class="o">+</span> <span class="nx">seconds</span> <span class="o">+</span> <span class="s1">' s and '</span> <span class="o">+</span> <span class="nx">millis</span> <span class="o">+</span> <span class="s1">' ms.'</span><span class="p">,</span> <span class="s1">'info'</span><span class="p">);</span>
          <span class="nx">next</span><span class="p">();</span>
        <span class="p">},</span>
        <span class="na">preEnqueue</span><span class="p">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">next</span><span class="p">){</span>
          <span class="kd">var</span> <span class="nx">params</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">args</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
          <span class="c1">//Validate params</span>
          <span class="nx">next</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="kc">true</span><span class="p">);</span> <span class="c1">//callback is in form cb(error, toRun)</span>
        <span class="p">},</span>
        <span class="na">postEnqueue</span><span class="p">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">next</span><span class="p">){</span>
          <span class="nx">api</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">"Task successfully enqueued!"</span><span class="p">);</span>
          <span class="nx">next</span><span class="p">();</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">};</span>

    <span class="nx">api</span><span class="p">.</span><span class="nx">tasks</span><span class="p">.</span><span class="nx">addMiddleware</span><span class="p">(</span><span class="nx">api</span><span class="p">.</span><span class="nx">taskTimer</span><span class="p">.</span><span class="nx">middleware</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">};</span>
</code></pre>

          <h1 id="initializers">Initializers</h1>

<p>Initializers are the main way you expand your ActionHero server.  This is where you connect to databases, modify the global <code class="prettyprint">api</code> object with new classes and helper methods, and set up your <a href="docs#middleware">middleware</a>.</p>

<p>Initializers run in 3 phases coinciding with the lifecycles of the application: <code class="prettyprint">init</code>, <code class="prettyprint">start</code>, and <code class="prettyprint">stop</code>.  All <code class="prettyprint">init</code> steps happen before all <code class="prettyprint">start</code> steps.  Initializers can define both methods and priorities which will happen at each phase of the server&rsquo;s lifecycle.</p>

<p>System initializers (like setting up redis and the cache) have priority levels in the 100 to 1000 level range.  Application initializers should run with a priority level of over 1000 to use methods created by the system.  You can of course set priority levels lower than 1000 in your application (perhaps you connect to a database).  The priority level split is purely convention.</p>

<p>In general, <code class="prettyprint">initialize()</code> methods should create prototypes and new objects, and <code class="prettyprint">start()</code> should boot things or connect to external resources.</p>

<h2 id="format">Format</h2>
<pre class="highlight javascript"><code><span class="c1">// initializers/stuffInit.js</span>

<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="p">{</span>
  <span class="na">loadPriority</span><span class="p">:</span>  <span class="mi">1000</span><span class="p">,</span>
  <span class="na">startPriority</span><span class="p">:</span> <span class="mi">1000</span><span class="p">,</span>
  <span class="na">stopPriority</span><span class="p">:</span>  <span class="mi">1000</span><span class="p">,</span>
  <span class="na">initialize</span><span class="p">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">api</span><span class="p">,</span> <span class="nx">next</span><span class="p">){</span>
    <span class="nx">api</span><span class="p">.</span><span class="nx">myObject</span> <span class="o">=</span> <span class="p">{};</span>

    <span class="nx">next</span><span class="p">();</span>
  <span class="p">},</span>
  <span class="na">start</span><span class="p">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">api</span><span class="p">,</span> <span class="nx">next</span><span class="p">){</span>
    <span class="c1">// connect to server</span>
    <span class="nx">next</span><span class="p">();</span>
  <span class="p">},</span>
  <span class="na">stop</span><span class="p">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">api</span><span class="p">,</span> <span class="nx">next</span><span class="p">){</span>
    <span class="c1">// disconnect from server</span>
    <span class="nx">next</span><span class="p">();</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre>

<p>To use a custom initializer, create a <code class="prettyprint">initializers</code> directory in your project. Export an object with at least one of <code class="prettyprint">start</code>, <code class="prettyprint">stop</code> or <code class="prettyprint">initialize</code> and specify your priorities.</p>

<p>You can generate a file of this type with <code class="prettyprint">actionhero generateInitializer --name=stuffInit</code></p>

<h2 id="errors">Errors</h2>

<p>You can pass an error to the callback of any step in the initializer.  Doing so will cause ActionHero to log the error and stop the server.  For example, you might throw an error if you cannot connect to an external service at boot, <a href="https://github.com/evantahler/ah-sequelize-plugin/blob/master/initializers/sequelize.js">like a database</a>. </p>

          <h1 id="actioncluster">ActionCluster</h1>

<p><em>AKA: Running ActionHero in a Cluster</em></p>

<p>ActionHero can be run either as a solitary server or as part of a cluster.  The goal of these cluster helpers is to allow you to create a group of servers which will share state and each be able to handle requests and run tasks.  You can add or remove nodes from the cluster without fear of data loss or task duplication.  You can also run many instances of ActionHero on the same server using node.js&rsquo; cluster methods (<code class="prettyprint">ActionHero start cluster</code>), which you <a href="/docs#production-notes">can learn more about here</a>.</p>

<p>Cluster instances are named sequentially, starting with actionhero-worker-1, and can be retrived from &lsquo;api.id&rsquo;. Logs and PID&rsquo;s, as well as other instance-specific information follow this pattern as well.</p>

<h2 id="cache">Cache</h2>

<p>Using a <a href="http://redis.io/">redis</a> backend, ActionHero nodes share memory objects (using the <code class="prettyprint">api.cache methods</code>) and have a common queue for tasks. This means that all peers will have access to all data stored in the cache.  The task system also becomes a common queue which all peers will work on draining.  There should be no changes required to deploy your applicaiton in a cluster.  </p>

<p>Keep in mind that many clients/server can access a cached value simultaneously, so build your actions carefully not to have conflicting state.  You can <a href="/docs#general-cache-notes">learn more about the cache methods here</a>.  You can also <a href="/docs#redis-configurations">review recommendations about Production Redis configurations</a>.</p>

<h2 id="rpc">RPC</h2>
<pre class="highlight javascript"><code><span class="c1">// This will ask all nodes connected to the cluster if they have connection #`abc123` and if they do, run `connection.set('auth', true) on it`</span>
<span class="nx">api</span><span class="p">.</span><span class="nx">connections</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="s1">'abc123'</span><span class="p">,</span> <span class="s1">'set'</span><span class="p">,</span> <span class="p">[</span><span class="s1">'auth'</span><span class="p">,</span> <span class="kc">true</span><span class="p">],</span> <span class="kd">function</span><span class="p">(</span><span class="nx">error</span><span class="p">){</span>
  <span class="c1">// do stuff</span>
<span class="p">});</span>
</code></pre>

<p>In version 9.0.0, ActionHero introduced Remote Procedure Calls, or RPC for short.  You can call an RPC method to be excecuted on all nodes in your cluster or just a node which holds a specific connection.  You can call RPC methods with the <code class="prettyprint">api.redis.doCluster</code> method.  If you provide the optional callback, you will get the first response back (or a timeout error).  RPC calls are invoked with <code class="prettyprint">api.redis.doCluster(method, args, connectionId, callback)</code>.</p>

<p>For example, if you wanted all nodes to log a message, you would do: <code class="prettyprint">api.redis.doCluster(&#39;api.log&#39;, [&quot;hello from &quot; + api.id]);</code></p>

<p>If you wanted the node which holds connection <code class="prettyprint">abc123</code> to change their <code class="prettyprint">authorized</code> status (perhaps because your room authentication relies on this), you would do:</p>

<p>The RPC system is used heavily by Chat.</p>

<p>Two options have been added to the <code class="prettyprint">config/redis.js</code> config file to support this: <code class="prettyprint">api.config.general.channel</code> ( Which channel to use on redis pub/sub for RPC communication ) and <code class="prettyprint">api.config.general.rpcTimeout</code> ( How long to wait for an RPC call before considering it a failure )</p>

<p><strong>WARNING</strong></p>

<p>RPC calls are authenticated against <code class="prettyprint">api.config.serverToken</code> and communication happens over redis pub/sub. BE CAREFUL, as you can call <em>any</em> method within the API namespace on an ActionHero server, including shutdown() and read <em>any</em> data on that node.</p>

<h3 id="connections">Connections</h3>

<p>Some special RPC tools have been added so that you can interact with connections across multiple nodes.  Speficially the chat sub-system needs to be able to boot and move connections into rooms, regardless of which node they are connected to.</p>

<p>ActionHero has exposed <code class="prettyprint">api.connections.apply</code> which can be used to retrive data about and modify a connection on any node.</p>

<h3 id="api-connections-apply-connectionid-method-args-callback">api.connections.apply(connectionId, method, args, callback)</h3>

<ul>
<li>connectionId is required</li>
<li>if <code class="prettyprint">method</code> and <code class="prettyprint">args</code> can be ignored if you just want to retirve information abou a connection, IE: <code class="prettyprint">api.connections.apply(connectionId, callback)</code></li>
<li><code class="prettyprint">callback</code> is of the form <code class="prettyprint">function(error, connectionDetails)</code></li>
</ul>

<h2 id="generic-pub-sub">Generic Pub/Sub</h2>
<pre class="highlight javascript"><code><span class="c1">// To subscirbe to messages, add a callback for your `messageType`, IE:</span>
<span class="nx">api</span><span class="p">.</span><span class="nx">redis</span><span class="p">.</span><span class="nx">subscriptionHandlers</span><span class="p">[</span><span class="s1">'myMessageType'</span><span class="p">]</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">message</span><span class="p">){</span>
  <span class="c1">// do stuff</span>
<span class="p">}</span>

<span class="c1">// send a message</span>
<span class="kd">var</span> <span class="nx">payload</span> <span class="o">=</span> <span class="p">{</span>
  <span class="na">messageType</span><span class="p">:</span> <span class="s1">'myMessageType'</span><span class="p">,</span>
  <span class="na">serverId</span><span class="p">:</span> <span class="nx">api</span><span class="p">.</span><span class="nx">id</span><span class="p">,</span>
  <span class="na">serverToken</span><span class="p">:</span> <span class="nx">api</span><span class="p">.</span><span class="nx">config</span><span class="p">.</span><span class="nx">general</span><span class="p">.</span><span class="nx">serverToken</span><span class="p">,</span>
  <span class="na">message</span><span class="p">:</span> <span class="s1">'hello!'</span><span class="p">,</span>
<span class="p">}</span>
<span class="nx">api</span><span class="p">.</span><span class="nx">redis</span><span class="p">.</span><span class="nx">publish</span><span class="p">(</span><span class="nx">payload</span><span class="p">)</span>
</code></pre>

<p>ActionHero also uses redis to allow for pub/sub communication between nodes.  </p>

<p>You can broadcast and receive messages from other peers in the cluster:</p>

<h3 id="api-redis-publish-payload">api.redis.publish(payload)</h3>

<ul>
<li>payload must contain:

<ul>
<li><code class="prettyprint">messageType</code>  : &rsquo;{the name of your payload type}&rsquo;,</li>
<li><code class="prettyprint">serverId</code>     : api.id,</li>
<li><code class="prettyprint">serverToken</code>  : api.config.general.serverToken,</li>
</ul></li>
</ul>

          <h1 id="cache">Cache</h1>

<h2 id="general-cache-notes">General Cache Notes</h2>

<p>ActionHero ships with the functions needed for a distributed key-value cache.  You can cache strings, numbers, arrays and objects (anything that responds to <code class="prettyprint">JSON.stringify</code>).  </p>

<p>The cache&rsquo;s redis server is defined by <code class="prettyprint">api.config.redis</code>.  It is possible to use fakeredis.</p>

<h2 id="cache-methods">Cache Methods</h2>

<h3 id="api-cache-save">api.cache.save</h3>

<ul>
<li>Invoke: <code class="prettyprint">api.cache.save(key, value, expireTimeMS, next)</code>

<ul>
<li><code class="prettyprint">expireTimeMS</code> can be null if you never want the object to expire</li>
</ul></li>
<li>Callback: <code class="prettyprint">next(error, newObject)</code>

<ul>
<li><code class="prettyprint">error</code> will be null unless the object can&rsquo;t be saved (perhaps out of ram or a bad object type).</li>
<li>overwriting an existing object will return <code class="prettyprint">newObject = true</code></li>
</ul></li>
</ul>

<p><code class="prettyprint">api.cache.save</code> is used to both create new entires or update existing cache entires.  If you don&rsquo;t define an expireTimeMS, <code class="prettyprint">null</code> will be assumed, and using <code class="prettyprint">null</code> will cause this cached item to never expire.  Expired cache objects will be periodically swept away (but not necessarily exactly when they expire)</p>

<h3 id="api-cache-load">api.cache.load</h3>

<ul>
<li>Invoke: <code class="prettyprint">api.cache.load(key, next)</code> or <code class="prettyprint">api.cache.load(key, options, next)</code>

<ul>
<li><code class="prettyprint">options</code> can be <code class="prettyprint">{expireTimeMS: 1234}</code> where the act of reading the key will reset the key&rsquo;s expire time</li>
<li>If the requested <code class="prettyprint">key</code> is not found (or is expired), all values returned will be null.</li>
</ul></li>
<li>Callback: <code class="prettyprint">next(error, value, expireTimestamp, createdAt, readAt)</code>

<ul>
<li><code class="prettyprint">value</code> will be the object which was saved and <code class="prettyprint">null</code> if the object cannot be found or is expired</li>
<li><code class="prettyprint">expireTimestamp</code> (ms) is when the object is set to expire in system time</li>
<li><code class="prettyprint">createdAt</code> (ms) is when the object was created</li>
<li><code class="prettyprint">readAt</code> (ms) is the timestamp at which the object was last read with <code class="prettyprint">api.cache.load</code>.  Useful for telling if another worker has consumed the object recently</li>
</ul></li>
</ul>

<h3 id="api-cache-destroy">api.cache.destroy</h3>

<ul>
<li>Invoke: <code class="prettyprint">api.cache.destroy(key)</code></li>
<li>Callback: <code class="prettyprint">next(error, destroyed)</code>

<ul>
<li>will be false if the object cannot be found, and true if destroyed</li>
</ul></li>
</ul>

<h2 id="list-methods">List methods</h2>

<p><code class="prettyprint">api.cache</code> implements a distributed shared list.  3 simple functions are provided to interact with this list, <code class="prettyprint">push</code>, <code class="prettyprint">pop</code>, and <code class="prettyprint">listLength</code>.  These lists are stored in Redis, and cannot be locked.  That said, a <code class="prettyprint">push</code> and <code class="prettyprint">pop</code> operation will guarantee that one-and-only-one copy of your data is returned to whichever application acted first (when popping) or an error will be returned (when pushing).</p>

<h3 id="api-cache-push">api.cache.push</h3>

<ul>
<li>Invoke: <code class="prettyprint">api.cache.push(key, data, next)</code>

<ul>
<li>data must be serializable via JSON.stringify</li>
</ul></li>
<li>Callback: <code class="prettyprint">next(error)</code></li>
</ul>

<h3 id="api-cache-pop">api.cache.pop</h3>

<ul>
<li>Invoke: <code class="prettyprint">api.cache.pop(key, next)</code></li>
<li>Callback: <code class="prettyprint">next(error, data)</code>

<ul>
<li>data will be returned in the object form it was saved (array, object, string)</li>
</ul></li>
</ul>

<h3 id="api-cache-listlength">api.cache.listLength</h3>

<ul>
<li>Invoke: <code class="prettyprint">api.cache.listLength(key, next)</code></li>
<li>Callback: <code class="prettyprint">next(error, length)</code>

<ul>
<li>length will be an integer.</li>
<li>if the list does not exist, <code class="prettyprint">0</code> will be returned</li>
</ul></li>
</ul>

<h2 id="lock-methods">Lock Methods</h2>

<p>You may optionally implement locking methods along with your cache objects.  This will allow one ActionHero server to obtain a lock on an object and prevent modification of it by another member of the cluster.  For example you may want to first <code class="prettyprint">api.cache.lock</code> a key, and then save it to prevent other nodes from modifying the object.</p>

<h3 id="api-cache-lock">api.cache.lock</h3>

<ul>
<li>Invoke: <code class="prettyprint">api.cache.lock(key, expireTimeMS, next)</code>

<ul>
<li><code class="prettyprint">expireTimeMS</code> is optional, and will be <code class="prettyprint">expireTimeMS = api.cache.lockDuration = api.config.general.lockDuration</code></li>
</ul></li>
<li>Callback: <code class="prettyprint">next(error, lockOk)</code>

<ul>
<li><code class="prettyprint">error</code> will be null unless there was something wrong with the connection (perhaps a redis error)</li>
<li><code class="prettyprint">lockOk</code> will be <code class="prettyprint">true</code> or <code class="prettyprint">false</code> depending on if the lock was obtained.</li>
</ul></li>
</ul>

<h3 id="api-cache-unlock">api.cache.unlock</h3>

<ul>
<li>Invoke: <code class="prettyprint">api.cache.unlock(key, next)</code></li>
<li>Callback: <code class="prettyprint">next(error, lockOk)</code>

<ul>
<li><code class="prettyprint">error</code> will be null unless there was something wrong with the connection (perhaps a redis error)</li>
<li><code class="prettyprint">lockOk</code> will be <code class="prettyprint">true</code> or <code class="prettyprint">false</code> depending on if the lock was removed.</li>
</ul></li>
</ul>

<h3 id="api-cache-checklock">api.cache.checkLock</h3>

<ul>
<li>Invoke: <code class="prettyprint">api.cache.checkLock(key,retry,  next)</code>

<ul>
<li><code class="prettyprint">retry</code> is either <code class="prettyprint">null</code> or an integer (ms) that we should keep retrying until the lock is free to be re-obtained</li>
</ul></li>
<li>Callback: <code class="prettyprint">next(error, lockOk)</code>

<ul>
<li><code class="prettyprint">error</code> will be null unless there was something wrong with the connection (perhaps a redis error)</li>
<li><code class="prettyprint">lockOk</code> will be <code class="prettyprint">true</code> or <code class="prettyprint">false</code> depending on if the lock is currently obtainable.</li>
</ul></li>
</ul>

<h3 id="api-cache-locks">api.cache.locks</h3>

<ul>
<li>Invoke: <code class="prettyprint">api.cache.locks(next)</code></li>
<li>Callback: <code class="prettyprint">next(error, locks)</code>

<ul>
<li><code class="prettyprint">locks</code> is an array of all currently active locks</li>
</ul></li>
</ul>

<p>You can see an example of using the cache within an action in <a href="https://github.com/evantahler/actionhero/blob/master/actions/cacheTest.js">actions/cacheTest.js</a></p>

<h2 id="redis">Redis</h2>

<p>The timestamps regarding <code class="prettyprint">api.cache.load</code> are to help clients understand if they are working with data which has been modified by another peer (when running in a cluster).</p>

<p>Keep in mind that many clients/servers can access a cached value simultaneously, so build your actions carefully not to have conflicting state.  You can <a href="/docs#general-cache-notes">learn more about the cache methods here</a>.  You can also <a href="/docs#redis-configurations">review recommendations about Production Redis configurations</a>.</p>

          <h1 id="chat">Chat</h1>

<h2 id="general">General</h2>

<p>ActionHero ships with a chat framework which may be used by all persistent connections (<code class="prettyprint">socket</code> and <code class="prettyprint">websocket</code>).  There are methods to create and manage chat rooms and control the users in those rooms.  Chat does not have to be for peer-to-peer communication, and is a metaphor used for many things, including game state in MMOs.</p>

<p>Clients themselves interact with rooms via <code class="prettyprint">verbs</code>.  Verbs are short-form commands that will attempt to modify the connection&rsquo;s state, either joining or leaving a room.  Clients can be in many rooms at once.</p>

<p>Relevant chat verbs are:</p>

<ul>
<li><code class="prettyprint">roomAdd</code></li>
<li><code class="prettyprint">roomLeave</code></li>
<li><code class="prettyprint">roomView</code></li>
<li><code class="prettyprint">say</code></li>
</ul>

<p>The special verb for persistent connections <code class="prettyprint">say</code> makes use of <code class="prettyprint">api.chatRoom.broadcast</code> to tell a message to all other users in the room, IE: <code class="prettyprint">say myRoom Hello World</code> from a socket client or <code class="prettyprint">client.say(&quot;myRoom&quot;, &#39;Hello World&quot;)</code> for a websocket.</p>

<p>Chat on multiple actionHero nodes relies on redis for both chat (pub/sub) and a key store defined by <code class="prettyprint">api.config.redis</code>. Note that if you elect to use fakeredis, you will be using an in-memory redis server rather than a real redis process, which does not work to share data across nodes.  The redis store and the key store don&rsquo;t need to be the same instance of redis, but they do need to be the same for all ActionHero servers you are running in parallel.  This is how ActionHero scales the chat features.</p>

<p>There is no limit to the number of rooms which can be created, but keep in mind that each room stores information in redis, and there load created for each connection.</p>

<h2 id="methods">Methods</h2>

<p>These methods are to be used within your server (perhaps an action or initializer).  They are not exposed directly to clients, but they can be within an action.</p>

<h3 id="api-chatroom-broadcast-connection-room-message-callback">api.chatRoom.broadcast(connection, room, message, callback)</h3>

<ul>
<li>tell a message to all members in a room.</li>
<li>connection can either be a real connection (A message coming from a client), or a mockConnection.  A mockConnection at the very least has the form <code class="prettyprint">{room: &quot;someOtherRoom}</code>.  mockConnections without an id will be assigned the id of 0</li>
<li>The <code class="prettyprint">context</code> of messages sent with <code class="prettyprint">api.chatRoom.broadcast</code> always be <code class="prettyprint">user</code> to differentiate these responses from a <code class="prettyprint">response</code> to a request</li>
</ul>

<h3 id="api-chatroom-list-callback">api.chatRoom.list(callback)</h3>

<ul>
<li>callback will return (error, [rooms])</li>
</ul>

<h3 id="api-chatroom-add-room-callback">api.chatRoom.add(room, callback)</h3>

<ul>
<li>callback will return 1 if you created the room, 0 if it already existed</li>
</ul>

<h3 id="api-chatroom-destroy-room-callback">api.chatRoom.destroy(room, callback)</h3>

<ul>
<li>callback is empty</li>
</ul>

<h3 id="api-chatroom-exists-room-callback">api.chatRoom.exists(room, callback)</h3>

<ul>
<li>callback returns (error, found); found is a boolean</li>
</ul>

<h3 id="api-chatroom-roomstatus-room-callback">api.chatRoom.roomStatus(room, callback)</h3>

<ul>
<li>callback returns (error, details); details is a hash containing room information</li>
<li>details of the form:</li>
</ul>
<pre class="highlight javascript"><code><span class="p">{</span>
  <span class="nl">room</span><span class="p">:</span> <span class="s2">"myRoom"</span><span class="p">,</span>
  <span class="nx">membersCount</span><span class="err">:</span> <span class="mi">2</span><span class="p">,</span>
  <span class="nx">members</span><span class="err">:</span> <span class="p">{</span>
    <span class="nl">aaa</span><span class="p">:</span> <span class="p">{</span><span class="nl">id</span><span class="p">:</span> <span class="s2">"aaa"</span><span class="p">,</span> <span class="nx">joinedAt</span><span class="err">:</span> <span class="mi">123456789</span> <span class="p">},</span>
    <span class="nx">bbb</span><span class="err">:</span> <span class="p">{</span><span class="nl">id</span><span class="p">:</span> <span class="s2">"bbb"</span><span class="p">,</span> <span class="nx">joinedAt</span><span class="err">:</span> <span class="mi">123456789</span> <span class="p">},</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre>

<h3 id="api-chatroom-addmember-connectionid-room-callback">api.chatRoom.addMember(connectionId, room, callback)</h3>

<ul>
<li>callback is of the form (error, wasAdded)</li>
<li>you can add connections from this or any other server in the cluster</li>
</ul>

<h3 id="api-chatroom-removemember-connectionid-room-callback">api.chatRoom.removeMember(connectionId, room, callback)</h3>

<ul>
<li>callback is of the form (error, wasRemoved)</li>
<li>you can remove connections from this or any other server in the cluster</li>
</ul>

<h3 id="api-chatroom-generatememberdetails-connection">api.chatRoom.generateMemberDetails( connection )</h3>

<ul>
<li>defines what is stored from the connection object in the member data</li>
<li>default is <code class="prettyprint">id: connection.id</code></li>
<li>other data that is stored by default is <code class="prettyprint">host: api.id</code> and <code class="prettyprint">joinedAt: new Date().getTime()</code></li>
<li>override the entire method to store custom data <em>that is on the connection</em></li>
</ul>

<h3 id="api-chatroom-sanitizememberdetails-memberdata">api.chatRoom.sanitizeMemberDetails( memberData )</h3>

<ul>
<li>Defines what is pulled out of the member data when returning roomStatus</li>
<li>Defaults to <code class="prettyprint">joinedAt : memberData.joinedAt</code></li>
<li>After method call, always filled with <code class="prettyprint">id</code>, based on the <code class="prettyprint">connection.id</code> used to store the data</li>
<li>Override the entire method to use custom data as defined in <code class="prettyprint">api.chatRoom.generateMemberDetails</code></li>
</ul>

<h3 id="api-chatroom-generatemessagepayload-message">api.chatRoom.generateMessagePayload( message )</h3>

<ul>
<li>Defiens how messages from clients are sanitized</li>
<li>Override the entire method to use custom data as defined in <code class="prettyprint">api.chatRoom.generateMessagePayload</code></li>
</ul>

<h2 id="middleware">Middleware</h2>

<p>There are 4 types of middelware you can install for the chat system: <code class="prettyprint">say</code>, <code class="prettyprint">onSayReceive</code>, <code class="prettyprint">join</code>, and <code class="prettyprint">leave</code>.  You can learn more about <a href="/docs#chat-middleware">chat middleware in the middleware section of this document</a></p>

<h2 id="chatting-to-specific-clients">Chatting to specific clients</h2>

<p>Every connection object also has a <code class="prettyprint">connection.sendMessage(message)</code> method which you can call directly from the server.  </p>

<h2 id="client-use">Client Use</h2>

<p>The details of communicating within a chat room are up to each individual server (see <a href="/docs#websocket-server">websocket</a> or <a href="/docs#socket-server">socket</a>), but the same principals apply:</p>

<ul>
<li>Client will join a room (<code class="prettyprint">client.roomAdd(room)</code>).</li>
<li>Once in the room, clients can send messages (which are strings) to everyone else in the room via <code class="prettyprint">say</code>, ie: <code class="prettyprint">client.say(&#39;room&#39;, Hello World&#39;)</code></li>
<li>Once a client is in a room, they will revive messages from other members of the room as events.  For example, catching say events from the websocket client looks like <code class="prettyprint">client.on(&#39;say&#39;, function(message){ console.log(message); })</code>.  You can inspect <code class="prettyprint">message.room</code> if you are in more than one room.

<ul>
<li>The payload of a message will contain the room, sender, and the message body: <code class="prettyprint">{message: &quot;Hello World&quot;, room: &quot;SecretRoom&quot;, from: &quot;7d419af9-accf-40ac-8d78-9281591dd59e&quot;, context: &quot;user&quot;, sentAt: 1399437579346}</code></li>
</ul></li>
</ul>

<p>If you want to create an authenticated room, there are 2 steps:</p>

<ul>
<li>First, create an action which modifies some property eitehr on the connection object it self, or stores permissions to a database.</li>
<li>Then, create a <code class="prettyprint">joinCallback</code>-style middleware which cheks these values.</li>
</ul>

          <h1 id="development-mode">Development Mode</h1>

<p><strong>Don&rsquo;t use this in production!</strong></p>

<h2 id="about">About</h2>
<pre class="highlight javascript"><code><span class="nx">config</span><span class="p">.</span><span class="nx">general</span> <span class="o">=</span> <span class="p">{</span>
  <span class="na">developmentMode</span><span class="p">:</span> <span class="kc">true</span>
<span class="p">}</span>
</code></pre>

<p>ActionHero&rsquo;s development mode is a little different than tools like <a href="https://github.com/remy/nodemon">nodemon</a> in that it tries hard not to restart the server process. Changes to routes, tasks, and actions can simply replace those in memory when they are updated on disk. Other changes, like changes to <code class="prettyprint">api.config</code> or initializers are more severe, and will restart the whole application (much like nodemon).</p>

<p>To enable development mode simply set <code class="prettyprint">developmentMode: true</code> in your <code class="prettyprint">config/api.js</code>.</p>

<p>Note that <code class="prettyprint">api.config.general.developmentMode</code> is different from <code class="prettyprint">NODE_ENV</code>, which by default is &ldquo;development&rdquo; (and is logged out when ActionHero boots).  <code class="prettyprint">NODE_ENV</code> is used to determine which config settings to use, and has no effect on developmentMode.</p>

<h2 id="effects-of-development-mode">Effects of Development Mode</h2>

<p>Development mode, when enabled, will poll for changes in your actions, tasks and initializers, and reload them on the fly.</p>

<ul>
<li>this uses <code class="prettyprint">fs.watchFile()</code> and may not work on all OSs / file systems.</li>
<li>new files won&rsquo;t be loaded in, only existing files when the app was booted will be monitored</li>
<li>as deleting a file might crash your application, we will not attempt to re-load deleted files</li>
<li>if you have changed the <code class="prettyprint">task.frequency</code> of a periodic task, you will continue to use the old value until the task fires at least once after the change</li>
<li>changing <code class="prettyprint">api.config</code>, initializers, or servers, will attempt to do a &ldquo;full&rdquo; reboot the server rather than just reload that component.</li>
</ul>

<h2 id="watching-custom-files">Watching custom files</h2>
<pre class="highlight javascript"><code><span class="nx">api</span><span class="p">.</span><span class="nx">watchFileAndAct</span><span class="p">(</span><span class="nx">path_to_file</span><span class="p">,</span> <span class="kd">function</span><span class="p">(){</span>
  <span class="nx">api</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'rebooting due to config change: '</span> <span class="o">+</span> <span class="nx">path_to_file</span><span class="p">,</span> <span class="s1">'info'</span><span class="p">);</span>
  <span class="nx">api</span><span class="p">.</span><span class="nx">commands</span><span class="p">.</span><span class="nx">restart</span><span class="p">();</span>
<span class="p">});</span>
</code></pre>

<p>You can use ActionHero&rsquo;s <code class="prettyprint">watchFileAndAct()</code> method to watch additional files your application may have:</p>

<h2 id="debugging">Debugging</h2>

<p>You can use the awesome <a href="https://github.com/dannycoates/node-inspector">node-inspector</a> project to help you debug your ActionHero application within the familar Chrome Browser&rsquo;s developer tools.</p>

<p>Be sure to run ActionHero with node&rsquo;s <code class="prettyprint">--debug</code> flag, ie: <code class="prettyprint">node ./node_modules/.bin/actionhero start --debug</code></p>
<pre class="highlight javascript"><code><span class="c1">// in package.json</span>
<span class="s2">"dependencies"</span><span class="err">:</span> <span class="p">{</span>
  <span class="s2">"actionhero"</span><span class="err">:</span> <span class="s2">"x"</span><span class="p">,</span>
  <span class="s2">"node-inspector"</span><span class="err">:</span> <span class="s2">"x"</span>
<span class="p">},</span>
</code></pre>

<p>Start up node-inspector (both node-inspector and ActionHero have the same default port, so you will need to change one of them) <code class="prettyprint">./node_modules/.bin/node-inspector --web-port=1234</code></p>

<p>That&rsquo;s it! Now you can visit <code class="prettyprint">http://0.0.0.0:1234/debug?port=5858</code> and start debugging.  Remember that the way node-debugger works has you first set a breakpoint in the file view, and then you can use the console to inspect various objects.  IE: I put a breakpoint in the default <code class="prettyprint">status</code> action in the <code class="prettyprint">run</code> method:</p>

<h2 id="repl">REPL</h2>
<pre class="highlight shell"><code><span class="gp">&gt; </span>actionhero console
Running <span class="s2">"console"</span> task
2015-11-14 17:48:01 - notice: <span class="k">***</span> starting actionhero <span class="k">***</span>
2015-11-14 17:48:01 - warning: running with fakeredis
2015-11-14 17:48:01 - info: actionhero member 10.0.1.15 has joined the cluster
2015-11-14 17:48:01 - notice: pid: 38464
2015-11-14 17:48:01 - notice: server ID: 10.0.1.15
2015-11-14 17:48:01 - info: ensuring the existence of the chatRoom: defaultRoom
2015-11-14 17:48:01 - info: ensuring the existence of the chatRoom: anotherRoom
2015-11-14 17:48:01 - notice: environment: development
2015-11-14 17:48:01 - notice: <span class="k">***</span> Server Started @ 2015-11-14 17:48:01 <span class="k">***</span>
<span class="o">[</span> AH::development <span class="o">]</span> &gt;&gt; api.id
<span class="s1">'10.0.1.15'</span>
<span class="o">[</span> AH::development <span class="o">]</span> &gt;&gt; Object.keys<span class="o">(</span>api.actions.actions<span class="o">)</span>
<span class="o">[</span> <span class="s1">'cacheTest'</span>,
  <span class="s1">'randomNumber'</span>,
  <span class="s1">'showDocumentation'</span>,
  <span class="s1">'sleepTest'</span>,
  <span class="s1">'status'</span> <span class="o">]</span>
</code></pre>

<p>ActionHero now has a REPL (<code class="prettyprint">v9.0.0</code>)! This means you can &lsquo;connect&rsquo; to a running instance of ActionHero and manually call all the methods on the <code class="prettyprint">api</code> namespace.  This combined with the new RPC tools make this a powerful debugging and development tool.  Running <code class="prettyprint">ActionHero console</code> will load up a version of action hero in your terminal where you have access to the <code class="prettyprint">api</code> object.  This version of the server will <code class="prettyprint">boot</code>, <code class="prettyprint">initialize</code>, and <code class="prettyprint">start</code>, but will skip booting any <code class="prettyprint">servers</code>.  </p>

<p>The REPL will:</p>

<ul>
<li>source <code class="prettyprint">NODE_ENV</code> properly to load the config</li>
<li>will connect to redis and load any user-defined initializers</li>
<li>will load any plugins</li>
<li>will <strong>not</strong> boot any servers</li>
</ul>

<p>If you are familiar with rails, this is very similar to <code class="prettyprint">rails console</code></p>

<p><img src="https://cloud.githubusercontent.com/assets/303226/2953485/4db6cbe2-da5b-11e3-96de-26fe4931d9af.png"></p>

          <h1 id="file-server">File Server</h1>

<h2 id="general">General</h2>
<pre class="highlight shell"><code><span class="gp">&gt; </span>curl localhost:8080/simple.html -v
<span class="k">*</span>   Trying ::1...
<span class="k">*</span> connect to ::1 port 8080 failed: Connection refused
<span class="k">*</span>   Trying 127.0.0.1...
<span class="k">*</span> Connected to localhost <span class="o">(</span>127.0.0.1<span class="o">)</span> port 8080 <span class="o">(</span><span class="c">#0)</span>
<span class="gp">&gt; </span>GET /simple.html HTTP/1.1
<span class="gp">&gt; </span>Host: localhost:8080
<span class="gp">&gt; </span>User-Agent: curl/7.43.0
<span class="gp">&gt; </span>Accept: <span class="k">*</span>/<span class="k">*</span>
&gt;
&lt; HTTP/1.1 200 OK
&lt; Last-Modified: Fri Jun 12 2015 02:51:29 GMT-0700 <span class="o">(</span>PDT<span class="o">)</span>
&lt; Cache-Control: max-age<span class="o">=</span>60, must-revalidate, public
&lt; Expires: Sun, 15 Nov 2015 02:07:46 GMT
&lt; Content-Type: text/html
&lt; Access-Control-Allow-Headers: Content-Type
&lt; Access-Control-Allow-Methods: HEAD, GET, POST, PUT, PATCH, DELETE, OPTIONS, TRACE
&lt; Access-Control-Allow-Origin: <span class="k">*</span>
&lt; X-Powered-By: actionhero API
&lt; Set-Cookie: <span class="nv">sessionID</span><span class="o">=</span>d4453f54ff066a2ef078e5c80f18dc78a81f44ff;path<span class="o">=</span>/;expires<span class="o">=</span>Sun, 15 Nov 2015 03:06:46 GMT;
&lt; Content-Length: 101
&lt; Date: Sun, 15 Nov 2015 02:06:46 GMT
&lt; Connection: keep-alive
&lt;
<span class="k">*</span> Connection <span class="c">#0 to host localhost left intact</span>
&lt;h1&gt;ActionHero&lt;/h1&gt;<span class="se">\n</span>I am a flat file being served to you via the API from ./public/simple.html&lt;br /&gt;
</code></pre>

<p>ActionHero comes with a file server which clients can make use of to request files on the ActionHero server.  ActionHero is not meant to be a &lsquo;rendering&rsquo; server (like express or rails), but can serve static files.</p>

<p>If a directory is requested rather than a file, ActionHero will look for the file in that directory defined by <code class="prettyprint">api.config.commonWeb.directoryFileType</code> (which defaults to <code class="prettyprint">index.html</code>).  Failing to find this file, an error will be returned defined in <code class="prettyprint">api.config.general.flatFileIndexPageNotFoundMessage</code></p>

<p>You can use the <code class="prettyprint">api.staticFile.get(connection, next)</code> in your actions (where <code class="prettyprint">next(connection, error, fileStream, mime, length)</code>).  Note that fileStream is a stream which can be pipe&rsquo;d to a client.  You can use this in actions if you wish,</p>

<p>On .nix operating system&rsquo;s symlinks for both files and folders will be followed.</p>

<h2 id="web-clients">Web Clients</h2>

<ul>
<li><code class="prettyprint">Cache-Control</code> and <code class="prettyprint">Expires</code> or respectively <code class="prettyprint">ETag</code> headers (depending on configuration) will be sent with it&rsquo;s caching or revalidation time defined by <code class="prettyprint">api.config.servers.web.flatFileCacheDuration</code></li>
<li>Content-Types for files will attempt to be determined using the <a href="https://npmjs.org/package/mime">mime package</a></li>
<li>web clients may request <code class="prettyprint">connection.params.file</code> directly within an action which makes use of  <code class="prettyprint">api.sendFile</code>, or if they are  under the <code class="prettyprint">api.config.servers.web.urlPathForFiles</code> route, the file will be looked up as if the route matches the directory structure under <code class="prettyprint">flatFileDirectory</code>.</li>
<li>if your action wants to send content down to a client directly, you will do so like this <code class="prettyprint">server.sendFile(connection, null, stream, &#39;text/html&#39;, length);</code></li>
</ul>

<h2 id="non-web-clients">Non-web Clients</h2>

<ul>
<li>the param <code class="prettyprint">file</code> should be used to request a path</li>
<li>file data is sent <code class="prettyprint">raw</code>, and is likely to contain binary content and line breaks.  Parse your responses accordingly!</li>
</ul>

<h2 id="sending-files-from-actions">Sending files from Actions</h2>
<pre class="highlight javascript"><code><span class="c1">// success case</span>
<span class="nx">data</span><span class="p">.</span><span class="nx">connection</span><span class="p">.</span><span class="nx">sendFile</span><span class="p">(</span><span class="s1">'/path/to/file.mp3'</span><span class="p">);</span>
<span class="nx">data</span><span class="p">.</span><span class="nx">toRender</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
<span class="nx">next</span><span class="p">();</span>

<span class="c1">// failure case</span>
<span class="nx">data</span><span class="p">.</span><span class="nx">connection</span><span class="p">.</span><span class="nx">rawConnection</span><span class="p">.</span><span class="nx">responseHttpCode</span> <span class="o">=</span> <span class="mi">404</span><span class="p">;</span>
<span class="nx">data</span><span class="p">.</span><span class="nx">connection</span><span class="p">.</span><span class="nx">sendFile</span><span class="p">(</span><span class="s1">'404.html'</span><span class="p">);</span>
<span class="nx">data</span><span class="p">.</span><span class="nx">toRender</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
<span class="nx">next</span><span class="p">();</span>
</code></pre>

<p>You can send files from within actions using <code class="prettyprint">connection.sendFile()</code>.  Here&rsquo;s an example:</p>

<p>Note that you can optionally modify responseCodes (for HTTP clients only).  Be sure to set <code class="prettyprint">toRender = false</code> in the callback, as you have already sent data to the client, and probably don&rsquo;t want to do so again on a file request.  If you try to <code class="prettyprint">sendFile</code> on a path that doesn&rsquo;t exist (within your public directory), the 404 header will be handled automatically for you.  </p>

<h2 id="customizing-the-file-server">Customizing the File Server</h2>
<pre class="highlight javascript"><code><span class="c1">// in an initializer, override api.staticFile.path</span>

<span class="nx">api</span><span class="p">.</span><span class="nx">staticFile</span><span class="p">.</span><span class="nx">path</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">connection</span><span class="p">){</span>
  <span class="k">if</span><span class="p">(</span><span class="nx">connection</span><span class="p">.</span><span class="nx">action</span> <span class="o">==</span> <span class="s1">'sendFile'</span><span class="p">){</span>
    <span class="k">return</span> <span class="s1">'/tmp/uploads'</span><span class="p">;</span>
  <span class="p">}</span><span class="k">else</span><span class="p">{</span>
    <span class="k">return</span> <span class="nx">api</span><span class="p">.</span><span class="nx">config</span><span class="p">.</span><span class="nx">general</span><span class="p">.</span><span class="nx">paths</span><span class="p">.</span><span class="kr">public</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre>

<p>By default, we want ActionHero&rsquo;s file server to be very locked-down, and only serve files from directories defined in <code class="prettyprint">api.config.general.paths.public</code>.  This is the safest default for beginners. However, you can customize things by changing the behavior of <code class="prettyprint">api.staticFile.path()</code>.</p>

<p>This would serve files from <code class="prettyprint">/public</code> for all requests except the <code class="prettyprint">sendFile</code> action, which will serve files from <code class="prettyprint">/tmp</code></p>

          <h1 id="logging">Logging</h1>

<h2 id="winston">Winston</h2>

<p>ActionHero uses the <a href="https://github.com/flatiron/winston">Winston logger</a>.  This allows for better, more customizable logging.  </p>

<h2 id="defaults">Defaults</h2>
<pre class="highlight javascript"><code><span class="nx">config</span><span class="p">.</span><span class="nx">logger</span> <span class="o">=</span> <span class="p">{</span>
  <span class="na">transports</span><span class="p">:</span> <span class="p">[</span>
    <span class="kd">function</span><span class="p">(</span><span class="nx">api</span><span class="p">){</span>
      <span class="k">return</span> <span class="k">new</span> <span class="p">(</span><span class="nx">winston</span><span class="p">.</span><span class="nx">transports</span><span class="p">.</span><span class="nx">Console</span><span class="p">)({</span>
        <span class="na">colorize</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
        <span class="na">level</span><span class="p">:</span> <span class="s2">"debug"</span><span class="p">,</span>
      <span class="p">});</span>
    <span class="p">},</span>
    <span class="kd">function</span><span class="p">(</span><span class="nx">api</span><span class="p">){</span>
      <span class="k">return</span> <span class="k">new</span> <span class="p">(</span><span class="nx">winston</span><span class="p">.</span><span class="nx">transports</span><span class="p">.</span><span class="nx">File</span><span class="p">)({</span>
        <span class="na">filename</span><span class="p">:</span> <span class="s1">'./log/'</span> <span class="o">+</span> <span class="nx">api</span><span class="p">.</span><span class="nx">pids</span><span class="p">.</span><span class="nx">title</span> <span class="o">+</span> <span class="s1">'.log'</span><span class="p">,</span>
        <span class="na">level</span><span class="p">:</span> <span class="s2">"info"</span><span class="p">,</span>
        <span class="na">timestamp</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
      <span class="p">});</span>
    <span class="p">}</span>
  <span class="p">]</span>
<span class="p">};</span>
</code></pre>

<p>In your <code class="prettyprint">config/logger.js</code>, you can customize which <code class="prettyprint">transports</code> you would like the logger to use. If none are provided, a default logger which only will print to stdout will be used.  See winston&rsquo;s documentation for all the logger types, but know that they include console, file, s3, riak, and more.</p>

<p>The default loggers are =&gt;</p>

<p>You can set a transport directly, IE <code class="prettyprint">new (winston.transports.Console)()</code> or in a function which will be passed the <code class="prettyprint">api</code> object like the examples above.  The benefit of using the function invocation is you will have access to other methods and configuration options (like the title of the process).</p>

<h2 id="levels">Levels</h2>
<pre class="highlight javascript"><code><span class="nx">api</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'hello'</span><span class="p">);</span> <span class="c1">// will use the default, 'info' level</span>
<span class="nx">api</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'debug message'</span><span class="p">,</span> <span class="s1">'debug'</span><span class="p">)</span> <span class="c1">// will not show up unless you have configured your logger in this NODE_ENV to be debug</span>
<span class="nx">api</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'OH NO'</span><span class="p">,</span> <span class="s1">'emerg'</span><span class="p">)</span> <span class="c1">// will show up in all logger levels</span>
<span class="nx">api</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'the params were'</span><span class="p">,</span> <span class="s1">'info'</span><span class="p">,</span> <span class="nx">data</span><span class="p">.</span><span class="nx">params</span><span class="p">)</span> <span class="c1">// you can log objects too</span>
</code></pre>

<p>Note that you can set a <code class="prettyprint">level</code> which indicates which level (and those above it) you wish to log per transport.  The log levels are:</p>

<ul>
<li>0=debug</li>
<li>1=info</li>
<li>2=notice</li>
<li>3=warning</li>
<li>4=error</li>
<li>5=crit</li>
<li>6=alert</li>
<li>7=emerg</li>
</ul>

<p>You can customize these via <code class="prettyprint">api.config.logger.levels</code> and <code class="prettyprint">api.config.logger.colors</code>.  See <a href="https://github.com/winstonjs/winston#using-custom-logging-levels">Winston&rsquo;s documenation for more information</a></p>

<p>For example, if you set the logger&rsquo;s level to &ldquo;notice&rdquo;, you would also see &ldquo;crit&rdquo; messages, but not &ldquo;debug&rdquo; messages.</p>

<p>To invoke the logger from your code, use: <code class="prettyprint">api.log(message, severity, metadata)</code></p>

<h2 id="methods">Methods</h2>

<p><code class="prettyprint">api.logger.log</code> and <code class="prettyprint">api.logger[severity]</code> also exist which allow you to call and modify the Winston instance directly.</p>

<p><code class="prettyprint">api.log</code> will pass your message to all transports.</p>

<h3 id="api-log-message-severity-metadata">api.log(message, severity, metadata)</h3>
<pre class="highlight javascript"><code><span class="c1">// the most basic use.  Will assume 'info' as the severity</span>
<span class="nx">api</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'hello'</span><span class="p">);</span>

<span class="c1">// custom severity</span>
<span class="nx">api</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'OH NO!'</span><span class="p">,</span> <span class="s1">'warning'</span><span class="p">);</span>

<span class="c1">// custom severity with a metadata object</span>
<span class="nx">api</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'OH NO, something went wrong'</span><span class="p">,</span> <span class="s1">'warning'</span><span class="p">,</span> <span class="p">{</span> <span class="na">error</span><span class="p">:</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s1">'things are busted'</span><span class="p">)</span> <span class="p">});</span>

<span class="c1">// using sprintf-style interpolations</span>
<span class="kd">var</span> <span class="nx">message</span> <span class="o">=</span> <span class="p">[</span><span class="s1">'Hello there, the time is now %s'</span><span class="p">,</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">()];</span>
<span class="nx">api</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">message</span><span class="p">,</span> <span class="s1">'debug'</span><span class="p">);</span>
</code></pre>

<ul>
<li>message is a string or an array containing a <code class="prettyprint">sprintf</code> style string and replacements

<ul>
<li>an example of this would be: <code class="prettyprint">api.log([&#39;Hello %s&#39;, connection.params.firstName], &#39;info&#39;)</code></li>
<li>the message you pass will be used with the localization engines (<code class="prettyprint">i18n</code>).  You can <a href="/docs/#localizing-the-logger">learn more here</a></li>
</ul></li>
<li>severity is a string, and should match the log-level (IE: &lsquo;info&rsquo; or &#39;warning&rsquo;)</li>
<li>the default severity level is &#39;info&rsquo;</li>
<li>(optional) metadata is anything that can be stringified with <code class="prettyprint">JSON.stringify</code></li>
</ul>

          <h1 id="plugins">Plugins</h1>

<p>As of ActionHero version <code class="prettyprint">v8.0.0</code>, you can create and include plugins for you ActionHero project.  Plugins are collections of <code class="prettyprint">tasks</code>, <code class="prettyprint">actions</code>, <code class="prettyprint">servers</code>, and <code class="prettyprint">initializers</code> that are collected as a module.  You can install plugins via NPM or keep them in a local path.</p>

<p>Plugins are loaded after all local ActionHero project files, but initializers follow the same priority scheme as all other initializers.</p>

<h2 id="including-plugins">Including Plugins</h2>

<p><code class="prettyprint">api.config.general.paths.plugin</code> (loaded from <code class="prettyprint">/config/api.js</code>) is an array which contains the search path for your plugins.  This will default to <code class="prettyprint">./node_modules</code>, but you can add a local path to your project.  Once you have the plugin search paths set up, you use <code class="prettyprint">npm run actionhero link -- --name nameOfPlugin</code> (or <code class="prettyprint">./node_modules/.bin/actionhero link --name nameOfPlugin</code>, which is equivalent) to create links in your top-level project to the plugin.  This will also copy over any config files from the plugin into your project so you can modify them.  The act of &ldquo;linking&rdquo; simply creates a <code class="prettyprint">myPlugin.link</code> file in each component of your top-level project (actions, tasks, etc) which tells ActionHero to load up files at boot from that plugin.  </p>

<p>When you want to overwrite the config files when the plugin is linked, add the parameter <code class="prettyprint">overwriteConfig</code> to the <code class="prettyprint">link</code> call (e.g. <code class="prettyprint">npm run actionhero link --name nameOfPlugin --overwriteConfig</code>)</p>

<p>You can delete the linked files with the &ldquo;unlink&rdquo; method using  <code class="prettyprint">npm run actionhero unlink --name nameOfPlugin</code>.
Remember that you have to delete the config files of unlinked plugins manually!
If your plugin was installed via NPM, also be sure to remove it from your package.json or uninstall it with <code class="prettyprint">npm uninstall --save</code></p>

<h2 id="creating-plugins">Creating Plugins</h2>
<pre class="highlight shell"><code>/
| - actions
| - tasks
| - servers
| - initializers
| - scripts
| - config
|
| - package.json
</code></pre>

<p>To create a plugin, create a project with the following structure:</p>

<p>This structure will allow elements to be loaded into ActionHero (we search <code class="prettyprint">/actions</code> for actions, <code class="prettyprint">/tasks</code> for tasks, etc)</p>

<p>When developing your plugin locally, you can load it into an existing ActionHero project to test it out.</p>

<p>First, add the path your plugin is in to <code class="prettyprint">api.config.general.paths.plugin</code>.  If your ActionHero app is in <code class="prettyprint">/var/ah/actionhero</code> and your plugin is in <code class="prettyprint">/var/ah/my_plugin</code>, add <code class="prettyprint">/var/ah</code> to <code class="prettyprint">api.config.general.paths.plugin</code></p>

<p><strong>Please use the npm naming convention <code class="prettyprint">ah-(name)-plugin</code> when uploading your plugin to npm</strong></p>

<h2 id="changes-in-v13-0-0">Changes in V13.0.0</h2>

<p>The plugin system was significantly changes in ActionHero version <code class="prettyprint">13.0.0</code>.  Older plugins will not work.<br>
- <code class="prettyprint">config/plugins.js</code> has been removed in favor of the linking system
- Config files from within plugins are no longer sourced
- There should be no more postinstall scripts needed, and as such, none are executed
- Be sure that your plugin is OS-independant. Use path.sep for file path separators and things like that. Use relative paths for everything in your plugin.</p>

<h2 id="plugin-methods">Plugin methods</h2>

<p>When creating plugins, you may find yourself wanting to do things which could normally be accomplished easily with a &ldquo;top level&rdquo; ActionHero project, but might be difficult from within the <code class="prettyprint">node_modules</code> folder.  Here are some helpers:</p>

<h3 id="routes">Routes:</h3>

<ul>
<li><code class="prettyprint">api.routes.registerRoute(method, path, action, apiVersion, matchTrailingPathParts)</code>

<ul>
<li>Add a route to the system.<br></li>
</ul></li>
</ul>

<h2 id="example-plugin">Example Plugin</h2>

<p><a href="https://github.com/evantahler/ah-sample-plugin">You can view a sample plugin here</a></p>

<h2 id="published-plugins">Published Plugins</h2>

<p>You can view a list of plugins maintined by <a href="https://github.com/l0oky">@l0oky</a> via <a href="https://github.com/l0oky/awesome-actionhero"><img alt="Awesome" src="https://cdn.rawgit.com/sindresorhus/awesome/d7305f38d29fed78fa85652e3a63e154dd8e8829/media/badge.svg" /></a></p>

          <h1 id="servers">Servers</h1>
<pre class="highlight javascript"><code><span class="kd">var</span> <span class="nx">initialize</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">api</span><span class="p">,</span> <span class="nx">options</span><span class="p">,</span> <span class="nx">next</span><span class="p">){</span>

  <span class="c1">//////////</span>
  <span class="c1">// INIT //</span>
  <span class="c1">//////////</span>

  <span class="kd">var</span> <span class="nx">type</span> <span class="o">=</span> <span class="s2">"test"</span>
  <span class="kd">var</span> <span class="nx">attributes</span> <span class="o">=</span> <span class="p">{</span>
    <span class="na">canChat</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
    <span class="na">logConnections</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
    <span class="na">logExits</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
    <span class="na">sendWelcomeMessage</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
    <span class="na">verbs</span><span class="p">:</span> <span class="p">[],</span>
  <span class="p">}</span>

  <span class="kd">var</span> <span class="nx">server</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">api</span><span class="p">.</span><span class="nx">genericServer</span><span class="p">(</span><span class="nx">type</span><span class="p">,</span> <span class="nx">options</span><span class="p">,</span> <span class="nx">attributes</span><span class="p">);</span>

  <span class="c1">//////////////////////</span>
  <span class="c1">// REQUIRED METHODS //</span>
  <span class="c1">//////////////////////</span>

  <span class="nx">server</span><span class="p">.</span><span class="nx">start</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">next</span><span class="p">){}</span>

  <span class="nx">server</span><span class="p">.</span><span class="nx">stop</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">next</span><span class="p">){}</span>

  <span class="nx">server</span><span class="p">.</span><span class="nx">sendMessage</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">connection</span><span class="p">,</span> <span class="nx">message</span><span class="p">,</span> <span class="nx">messageCount</span><span class="p">){}</span>

  <span class="nx">server</span><span class="p">.</span><span class="nx">sendFile</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">connection</span><span class="p">,</span> <span class="nx">error</span><span class="p">,</span> <span class="nx">fileStream</span><span class="p">,</span> <span class="nx">mime</span><span class="p">,</span> <span class="nx">length</span><span class="p">){};</span>

  <span class="nx">server</span><span class="p">.</span><span class="nx">goodbye</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">connection</span><span class="p">,</span> <span class="nx">reason</span><span class="p">){};</span>

  <span class="c1">////////////</span>
  <span class="c1">// EVENTS //</span>
  <span class="c1">////////////</span>

  <span class="nx">server</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s2">"connection"</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">connection</span><span class="p">){});</span>

  <span class="nx">server</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">'actionComplete'</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">data</span><span class="p">){</span>
    <span class="nx">completeResponse</span><span class="p">(</span><span class="nx">data</span><span class="p">);</span>
  <span class="p">});</span>

  <span class="c1">/////////////</span>
  <span class="c1">// HELPERS //</span>
  <span class="c1">/////////////</span>

  <span class="nx">next</span><span class="p">(</span><span class="nx">server</span><span class="p">);</span>
<span class="p">}</span>

<span class="c1">/////////////////////////////////////////////////////////////////////</span>
<span class="c1">// exports</span>
<span class="nx">exports</span><span class="p">.</span><span class="nx">initialize</span> <span class="o">=</span> <span class="nx">initialize</span><span class="p">;</span>

</code></pre>

<p>In ActionHero v6.0.0 and later, we have introduced a modular server system which allows you to create your own servers.  Servers should be thought of as any type of listener to clients, streams or your file system.  In ActionHero, the goal of each server is to ingest a specific type of connection and transform each client into a generic <code class="prettyprint">connection</code> object which can be operated on by the rest of ActionHero.  To help with this, all servers extend <code class="prettyprint">api.genericServer</code> and fill in the required methods.</p>

<p>To get started, you can use the <code class="prettyprint">generateServer action</code> (name is required).  This will generate a template server which looks like this =&gt;</p>

<p>Like initializers, the <code class="prettyprint">start()</code> and <code class="prettyprint">stop()</code> methods will be called when the server is to boot up in ActionHero&rsquo;s lifecycle, but before any clients are permitted into the system.  Here is where you should actually initialize your server (IE: <code class="prettyprint">https.createServer.listen</code>, etc).</p>

<h2 id="designing-servers">Designing Servers</h2>
<pre class="highlight javascript"><code>
<span class="nx">server</span><span class="p">.</span><span class="nx">buildConnection</span><span class="p">({</span>
  <span class="na">rawConnection</span><span class="p">:</span> <span class="p">{</span>
    <span class="na">req</span><span class="p">:</span> <span class="nx">req</span><span class="p">,</span>
    <span class="na">res</span><span class="p">:</span> <span class="nx">res</span><span class="p">,</span>
    <span class="na">method</span><span class="p">:</span> <span class="nx">method</span><span class="p">,</span>
    <span class="na">cookies</span><span class="p">:</span> <span class="nx">cookies</span><span class="p">,</span>
    <span class="na">responseHeaders</span><span class="p">:</span> <span class="nx">responseHeaders</span><span class="p">,</span>
    <span class="na">responseHttpCode</span><span class="p">:</span> <span class="nx">responseHttpCode</span><span class="p">,</span>
    <span class="na">parsedURL</span><span class="p">:</span> <span class="nx">parsedURL</span>
  <span class="p">},</span>
  <span class="na">id</span><span class="p">:</span> <span class="nx">randomNumber</span><span class="p">(),</span>
  <span class="na">remoteAddress</span><span class="p">:</span> <span class="nx">remoteIP</span><span class="p">,</span>
  <span class="na">remotePort</span><span class="p">:</span> <span class="nx">req</span><span class="p">.</span><span class="nx">connection</span><span class="p">.</span><span class="nx">remotePort</span><span class="p">}</span>
<span class="p">);</span> <span class="c1">// will emit "connection"</span>

<span class="c1">// Note that connections will have a `rawConnection` property.  This is where you should store the actual object(s) returned by your server so that you can use them to communicate back with the client.  Again, an example from the `web` server:</span>

<span class="nx">server</span><span class="p">.</span><span class="nx">sendMessage</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">connection</span><span class="p">,</span> <span class="nx">message</span><span class="p">){</span>
   <span class="nx">cleanHeaders</span><span class="p">(</span><span class="nx">connection</span><span class="p">);</span>
   <span class="kd">var</span> <span class="nx">headers</span> <span class="o">=</span> <span class="nx">connection</span><span class="p">.</span><span class="nx">rawConnection</span><span class="p">.</span><span class="nx">responseHeaders</span><span class="p">;</span>
   <span class="kd">var</span> <span class="nx">responseHttpCode</span> <span class="o">=</span> <span class="nb">parseInt</span><span class="p">(</span><span class="nx">connection</span><span class="p">.</span><span class="nx">rawConnection</span><span class="p">.</span><span class="nx">responseHttpCode</span><span class="p">);</span>
   <span class="kd">var</span> <span class="nx">stringResponse</span> <span class="o">=</span> <span class="nb">String</span><span class="p">(</span><span class="nx">message</span><span class="p">)</span>
   <span class="nx">connection</span><span class="p">.</span><span class="nx">rawConnection</span><span class="p">.</span><span class="nx">res</span><span class="p">.</span><span class="nx">writeHead</span><span class="p">(</span><span class="nx">responseHttpCode</span><span class="p">,</span> <span class="nx">headers</span><span class="p">);</span>
   <span class="nx">connection</span><span class="p">.</span><span class="nx">rawConnection</span><span class="p">.</span><span class="nx">res</span><span class="p">.</span><span class="nx">end</span><span class="p">(</span><span class="nx">stringResponse</span><span class="p">);</span>
   <span class="nx">server</span><span class="p">.</span><span class="nx">destroyConnection</span><span class="p">(</span><span class="nx">connection</span><span class="p">);</span>
 <span class="p">}</span>

</code></pre>

<p>Your job, as a server designer, is to coerce every client&rsquo;s connection into a connection object.  This is done with the <code class="prettyprint">sever.buildConnection</code> helper.  Here is an example from the <code class="prettyprint">web</code> server:</p>

<h2 id="options-and-attributes">Options and Attributes</h2>

<p>A server defines <code class="prettyprint">attributes</code> which define it&rsquo;s behavior.  Variables like <code class="prettyprint">canChat</code> are defined here.  <code class="prettyprint">options</code> are passed in, and come from <code class="prettyprint">api.config.servers[serverName]</code>.  These can be new variables (like https?) or they can also overwrite the set <code class="prettyprint">attributes</code>.</p>

<p>The required attributes are provided in a generated server.</p>

<h2 id="verbs">Verbs</h2>
<pre class="highlight javascript"><code><span class="nx">allowedVerbs</span><span class="err">:</span> <span class="p">[</span>
      <span class="s2">"quit"</span><span class="p">,</span>
      <span class="s2">"exit"</span><span class="p">,</span>
      <span class="s2">"paramAdd"</span><span class="p">,</span>
      <span class="s2">"paramDelete"</span><span class="p">,</span>
      <span class="s2">"paramView"</span><span class="p">,</span>
      <span class="s2">"paramsView"</span><span class="p">,</span>
      <span class="s2">"paramsDelete"</span><span class="p">,</span>
      <span class="s2">"roomChange"</span><span class="p">,</span>
      <span class="s2">"roomView"</span><span class="p">,</span>
      <span class="s2">"listenToRoom"</span><span class="p">,</span>
      <span class="s2">"silenceRoom"</span><span class="p">,</span>
      <span class="s2">"detailsView"</span><span class="p">,</span>
      <span class="s2">"say"</span>
    <span class="p">]</span>
</code></pre>

<p>When an incoming message is detected, it is the server&rsquo;s job to build <code class="prettyprint">connection.params</code>.  In the <code class="prettyprint">web</code> server, this is accomplished by reading GET, POST, and form data.  For <code class="prettyprint">websocket</code> clients, that information is expected to be emitted as part of the action&rsquo;s request.  For other clients, like <code class="prettyprint">socket</code>, ActionHero provides helpers for long-lasting clients to operate on themselves.  These are called connection <code class="prettyprint">verbs</code>.</p>

<p>Clients use verbs to add params to themselves, update the chat room they are in, and more.   The list of verbs currently supported is =&gt;</p>

<p>Your server should be smart enough to tell when a client is trying to run an action, request a file, or use a verb.  One of the attributes of each server is <code class="prettyprint">allowedVerbs</code>, which defines what verbs a client is allowed to preform.  A simplified example of how the <code class="prettyprint">socket</code> server does this:</p>
<pre class="highlight javascript"><code><span class="kd">var</span> <span class="nx">parseRequest</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">connection</span><span class="p">,</span> <span class="nx">line</span><span class="p">){</span>
   <span class="kd">var</span> <span class="nx">words</span> <span class="o">=</span> <span class="nx">line</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s2">" "</span><span class="p">);</span>
   <span class="kd">var</span> <span class="nx">verb</span> <span class="o">=</span> <span class="nx">words</span><span class="p">.</span><span class="nx">shift</span><span class="p">();</span>
   <span class="k">if</span><span class="p">(</span><span class="nx">verb</span> <span class="o">==</span> <span class="s2">"file"</span><span class="p">){</span>
     <span class="k">if</span> <span class="p">(</span><span class="nx">words</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">){</span>
       <span class="nx">connection</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">file</span> <span class="o">=</span> <span class="nx">words</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
     <span class="p">}</span>
     <span class="nx">server</span><span class="p">.</span><span class="nx">processFile</span><span class="p">(</span><span class="nx">connection</span><span class="p">);</span>
   <span class="p">}</span><span class="k">else</span><span class="p">{</span>
     <span class="nx">connection</span><span class="p">.</span><span class="nx">verbs</span><span class="p">(</span><span class="nx">verb</span><span class="p">,</span> <span class="nx">words</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">error</span><span class="p">,</span> <span class="nx">data</span><span class="p">){</span>
       <span class="k">if</span><span class="p">(</span><span class="nx">error</span> <span class="o">==</span> <span class="kc">null</span><span class="p">){</span>
         <span class="kd">var</span> <span class="nx">message</span> <span class="o">=</span> <span class="p">{</span><span class="na">status</span><span class="p">:</span> <span class="s2">"OK"</span><span class="p">,</span> <span class="na">context</span><span class="p">:</span> <span class="s2">"response"</span><span class="p">,</span> <span class="na">data</span><span class="p">:</span> <span class="nx">data</span><span class="p">}</span>
         <span class="nx">server</span><span class="p">.</span><span class="nx">sendMessage</span><span class="p">(</span><span class="nx">connection</span><span class="p">,</span> <span class="nx">message</span><span class="p">);</span>
       <span class="p">}</span><span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="nx">error</span> <span class="o">===</span> <span class="s2">"verb not found or not allowed"</span><span class="p">){</span>
         <span class="nx">connection</span><span class="p">.</span><span class="nx">error</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
         <span class="nx">connection</span><span class="p">.</span><span class="nx">response</span> <span class="o">=</span> <span class="p">{};</span>
         <span class="nx">server</span><span class="p">.</span><span class="nx">processAction</span><span class="p">(</span><span class="nx">connection</span><span class="p">);</span>
       <span class="p">}</span><span class="k">else</span><span class="p">{</span>
         <span class="kd">var</span> <span class="nx">message</span> <span class="o">=</span> <span class="p">{</span><span class="na">status</span><span class="p">:</span> <span class="nx">error</span><span class="p">,</span> <span class="na">context</span><span class="p">:</span> <span class="s2">"response"</span><span class="p">,</span> <span class="na">data</span><span class="p">:</span> <span class="nx">data</span><span class="p">}</span>
         <span class="nx">server</span><span class="p">.</span><span class="nx">sendMessage</span><span class="p">(</span><span class="nx">connection</span><span class="p">,</span> <span class="nx">message</span><span class="p">);</span>
       <span class="p">}</span>
     <span class="p">});</span>
   <span class="p">}</span>
 <span class="p">}</span>
</code></pre>

<h2 id="chat">Chat</h2>

<p>The <code class="prettyprint">attribute</code> &ldquo;canChat&rdquo; defines if clients of this server can chat.  If clients can chat, they should be allowed to use vebs like &ldquo;roomChange&rdquo; and &ldquo;say&rdquo;.  They will also be sent messages in their room (and rooms they are listening too) automatically.</p>

<h2 id="sending-responses">Sending Responses</h2>

<p>All servers need to implement the <code class="prettyprint">server.sendMessage = function(connection, message, messageCount)</code> method so ActionHero knows how to talk to each client.  This is likely to make use of <code class="prettyprint">connection.rawConnection</code>.  If you are writing a server for a persistent connection, it is likely you will need to respond with <code class="prettyprint">messageCount</code> so that the client knows which request your response is about (as they are not always going to get the responses in order).  </p>

<h2 id="sending-files">Sending Files</h2>

<p>Servers can optionally implement the <code class="prettyprint">server.sendFile = function(connection, error, fileStream, mime, length)</code> method.  This method is responsible for any connection-specific file transport (headers, chinking, encoding, etc). Note that fileStream is a <code class="prettyprint">stream</code> which should be <code class="prettyprint">pipe</code>d to the client.</p>

          <h1 id="localization">Localization</h1>

<p>Starting in ActionHero <code class="prettyprint">v13.0.0</code>, you can now use the <a href="https://github.com/mashpie/i18n-node">i18n</a> module to customize all aspects of ActionHero.</p>

<h2 id="locale-files">Locale files</h2>

<ul>
<li>When running ActionHero with <code class="prettyprint">api.config.i18n.updateFiles = true</code>, you will see ActionHero generate a &lsquo;locales&rsquo; folder at the top level of your project which will contain translations of all strings in your project with are passed though the new localization system.  This includes all uses of <code class="prettyprint">api.i18n.localize</code>, <code class="prettyprint">connection.localize</code> and <code class="prettyprint">api.log</code>.<br>

<ul>
<li>be sure to use sprintf-style string interpolation for variables!</li>
</ul></li>
<li>From here, it is an easy matter to change the strings, per locale, to how you would like them presented back in your application.  The next time you restart the server, the values you&rsquo;ve updated in your locale strings file will be used.</li>
<li>disable <code class="prettyprint">api.config.i18n.updateFiles</code> if you do not want this behavior.</li>
</ul>

<h2 id="determining-connection-locales">Determining connection locales</h2>

<p>Since every ActionHero implementation is unique, we cannot ship with a &ldquo;guess&rdquo; about how to determine a given connection&rsquo;s locale. Perhaps you have an HTTP server and you can trust your client&rsquo;s <code class="prettyprint">accept-language</code> headers.  Or perhaps you run your API under a number of different host names and you can presume locale based on them.   Whatever the case, you need to create a synchronous method in an initializer which will be called when each connection connects to return its locale.  </p>

<p>For example, I may have an initializer in my project like this:</p>
<pre class="highlight javascript"><code><span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="p">{</span>
  <span class="na">initialize</span><span class="p">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">api</span><span class="p">,</span> <span class="nx">next</span><span class="p">){</span>
    <span class="nx">api</span><span class="p">.</span><span class="nx">customLocalization</span> <span class="o">=</span> <span class="p">{</span>
      <span class="na">lookup</span><span class="p">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">connection</span><span class="p">){</span>
        <span class="kd">var</span> <span class="nx">locale</span> <span class="o">=</span> <span class="s1">'en'</span><span class="p">;</span>
        <span class="k">if</span><span class="p">(</span><span class="nx">connection</span><span class="p">.</span><span class="nx">type</span> <span class="o">===</span> <span class="s1">'web'</span><span class="p">){</span>
          <span class="k">if</span><span class="p">(</span><span class="nx">connection</span><span class="p">.</span><span class="nx">rawConnection</span><span class="p">.</span><span class="nx">req</span><span class="p">.</span><span class="nx">headers</span><span class="p">.</span><span class="nx">host</span> <span class="o">===</span> <span class="s1">'usa.site.com'</span><span class="p">){</span> <span class="nx">locale</span> <span class="o">=</span> <span class="s1">'en-US'</span><span class="p">;</span> <span class="p">}</span>
          <span class="k">if</span><span class="p">(</span><span class="nx">connection</span><span class="p">.</span><span class="nx">rawConnection</span><span class="p">.</span><span class="nx">req</span><span class="p">.</span><span class="nx">headers</span><span class="p">.</span><span class="nx">host</span> <span class="o">===</span> <span class="s1">'uk.site.com'</span><span class="p">){</span>  <span class="nx">locale</span> <span class="o">=</span> <span class="s1">'en-GB'</span><span class="p">;</span> <span class="p">}</span>
          <span class="k">if</span><span class="p">(</span><span class="nx">connection</span><span class="p">.</span><span class="nx">rawConnection</span><span class="p">.</span><span class="nx">req</span><span class="p">.</span><span class="nx">headers</span><span class="p">.</span><span class="nx">host</span> <span class="o">===</span> <span class="s1">'es.site.com'</span><span class="p">){</span>  <span class="nx">locale</span> <span class="o">=</span> <span class="s1">'es-ES'</span><span class="p">;</span> <span class="p">}</span>
          <span class="k">if</span><span class="p">(</span><span class="nx">connection</span><span class="p">.</span><span class="nx">rawConnection</span><span class="p">.</span><span class="nx">req</span><span class="p">.</span><span class="nx">headers</span><span class="p">.</span><span class="nx">host</span> <span class="o">===</span> <span class="s1">'mx.site.com'</span><span class="p">){</span>  <span class="nx">locale</span> <span class="o">=</span> <span class="s1">'es-MX'</span><span class="p">;</span> <span class="p">}</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="nx">locale</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">}</span>


    <span class="nx">next</span><span class="p">();</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre>

<p>To tell the i18n to use this method with a new connection, set <code class="prettyprint">api.config.i18n.determineConnectionLocale = &#39;api.customLocalization.lookup&#39;</code></p>

<h2 id="connection-methods">Connection Methods</h2>

<ul>
<li><code class="prettyprint">connection.localize(string)</code> or <code class="prettyprint">connection.localize([string-with-interpolation, value])</code>

<ul>
<li>Allows you to interpolate a string based on the connection&rsquo;s current locale.  For example, say in an action you wanted to respond with <code class="prettyprint">data.response.message = connection.localize(&#39;the count was %s&#39;, 4);</code> In your locale files, you would define <code class="prettyprint">the count was %s</code> in every language you cared about, and not need to modify the action itself at all.</li>
</ul></li>
</ul>

<h2 id="localizing-the-logger">Localizing the Logger</h2>

<ul>
<li>Just like connections, the ActionHero logger itself now has localization interpolation built in.  Note how in the new settings you set which locale you want the server&rsquo;s logs to be expressed in.  Using that, you can now use sprintf-style string interpolation as the first argument of <code class="prettyprint">api.log()</code>

<ul>
<li>You might want to log the message <code class="prettyprint">api.log([&#39;The time is %s&#39;, new Date()], &#39;alert&#39;)</code>.<br></li>
<li>Changing the translation of the string <code class="prettyprint">The time is %s</code> in your locale files would apply to the logger as well!</li>
<li>You can of course continue to log plain strings as we have been with the logger as well.</li>
</ul></li>
</ul>

<h2 id="localizing-other-strings">Localizing other strings</h2>

<ul>
<li>To localize strings that are not used in methods mentioned above you can use <code class="prettyprint">api.i18n.localize(string, options)</code> or <code class="prettyprint">api.i18n.localize([string-with-interpolation, value], options)</code>.

<ul>
<li>Allows you to interpolate a string.</li>
<li>Just as the other localize methods above, the input string will be in your locale files for you to change it anytime you want.</li>
<li>The second <code class="prettyprint">options</code> optional argument (default value is <code class="prettyprint">api.i18n</code>) allows you to <a href="https://github.com/mashpie/i18n-node#list-of-all-configuration-options">configure</a> i18n. Note that you will use this argument only in very few special cases, It is recommended to edit the global <code class="prettyprint">api.config.i18n</code> settings to suit your localization needs.</li>
</ul></li>
</ul>

          <h1 id="the-api-object">The API Object</h1>
<pre class="highlight javascript"><code><span class="kd">var</span> <span class="nx">api</span> <span class="o">=</span> <span class="p">{</span>
  <span class="c1">// STATE VARIABLES //</span>
  <span class="na">running</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
  <span class="na">initialized</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
  <span class="na">shuttingDown</span><span class="p">:</span> <span class="kc">false</span><span class="p">,</span>

  <span class="c1">// METADATA //</span>
  <span class="na">bootTime</span><span class="p">:</span> <span class="mi">1421016104943</span><span class="p">,</span>
  <span class="na">env</span><span class="p">:</span> <span class="s1">'development'</span><span class="p">,</span>
  <span class="na">id</span><span class="p">:</span> <span class="s1">'10.0.1.5'</span><span class="p">,</span>
  <span class="na">actionheroVersion</span><span class="p">:</span> <span class="s1">'10.0.0'</span><span class="p">,</span>
  <span class="na">projectRoot</span><span class="p">:</span> <span class="s1">'/Users/evantahler/Dropbox/Projects/actionhero'</span><span class="p">,</span>
  <span class="na">_startingParams</span><span class="p">:</span> <span class="p">{</span> <span class="na">configChanges</span><span class="p">:</span> <span class="p">{</span> <span class="na">general</span><span class="p">:</span> <span class="p">[]</span> <span class="p">}</span> <span class="p">},</span>

  <span class="c1">// DEVELOPER MODE //</span>
  <span class="na">watchedFiles</span><span class="p">:</span> <span class="p">[],</span>
  <span class="na">watchFileAndAct</span><span class="p">:</span> <span class="p">[</span><span class="nb">Function</span><span class="p">],</span>
  <span class="na">unWatchAllFiles</span><span class="p">:</span> <span class="p">[</span><span class="nb">Function</span><span class="p">],</span>
  <span class="na">loadConfigDirectory</span><span class="p">:</span> <span class="p">[</span><span class="nb">Function</span><span class="p">],</span>

  <span class="c1">// SERVER COMMAND AND CONTROL //</span>
  <span class="na">commands</span><span class="p">:{</span>
    <span class="na">initialize</span><span class="p">:</span> <span class="p">[</span><span class="nb">Function</span><span class="p">],</span>
    <span class="na">start</span><span class="p">:</span>      <span class="p">[</span><span class="nb">Function</span><span class="p">],</span>
    <span class="na">stop</span><span class="p">:</span>       <span class="p">[</span><span class="nb">Function</span><span class="p">],</span>
    <span class="na">restart</span><span class="p">:</span>    <span class="p">[</span><span class="nb">Function</span><span class="p">]</span>
  <span class="p">},</span>

  <span class="c1">// COMAND AND CONTROL //</span>
  <span class="na">_self</span><span class="p">:{</span>
    <span class="na">initializers</span><span class="p">:</span> <span class="p">{},</span>
    <span class="na">startingParams</span><span class="p">:</span> <span class="p">{</span> <span class="na">configChanges</span><span class="p">:</span> <span class="p">[]</span> <span class="p">},</span>

     <span class="c1">// arrays containing init/stop/start methods</span>
     <span class="na">configInitializers</span><span class="p">:</span> <span class="p">[],</span>
     <span class="na">loadInitializers</span><span class="p">:</span>   <span class="p">[],</span>
     <span class="na">startInitializers</span><span class="p">:</span>  <span class="p">[],</span>
     <span class="na">stopInitializers</span><span class="p">:</span>   <span class="p">[]</span>
   <span class="p">},</span>

  <span class="c1">// INITIALZER DEFAULTS //</span>
  <span class="na">initializerDefaults</span><span class="p">:{</span>
    <span class="na">load</span><span class="p">:</span>  <span class="mi">1000</span><span class="p">,</span>
    <span class="na">start</span><span class="p">:</span> <span class="mi">1000</span><span class="p">,</span>
    <span class="na">stop</span><span class="p">:</span>  <span class="mi">1000</span>
  <span class="p">},</span>

  <span class="c1">// UTILS //</span>
  <span class="na">utils</span><span class="p">:{</span>
    <span class="na">hashMerge</span><span class="p">:</span>              <span class="p">[</span><span class="nb">Function</span><span class="p">],</span>
    <span class="na">isPlainObject</span><span class="p">:</span>          <span class="p">[</span><span class="nb">Function</span><span class="p">],</span>
    <span class="na">arrayUniqueify</span><span class="p">:</span>         <span class="p">[</span><span class="nb">Function</span><span class="p">],</span>
    <span class="na">recursiveDirectoryGlob</span><span class="p">:</span> <span class="p">[</span><span class="nb">Function</span><span class="p">],</span>
    <span class="na">objClone</span><span class="p">:</span>               <span class="p">[</span><span class="nb">Function</span><span class="p">],</span>
    <span class="na">collapseObjectToArray</span><span class="p">:</span>  <span class="p">[</span><span class="nb">Function</span><span class="p">],</span>
    <span class="na">getExternalIPAddress</span><span class="p">:</span>   <span class="p">[</span><span class="nb">Function</span><span class="p">],</span>
    <span class="na">parseCookies</span><span class="p">:</span>           <span class="p">[</span><span class="nb">Function</span><span class="p">],</span>
    <span class="na">parseIPv6URI</span><span class="p">:</span>           <span class="p">[</span><span class="nb">Function</span><span class="p">]</span>
  <span class="p">},</span>

  <span class="c1">// CONFIG //</span>
  <span class="na">config</span><span class="p">:</span>
   <span class="p">{</span> <span class="na">general</span><span class="p">:</span>
      <span class="p">{</span> <span class="na">apiVersion</span><span class="p">:</span> <span class="s1">'0.0.1'</span><span class="p">,</span>
        <span class="na">serverName</span><span class="p">:</span> <span class="s1">'actionhero API'</span><span class="p">,</span>
        <span class="na">serverToken</span><span class="p">:</span> <span class="s1">'change-me'</span><span class="p">,</span>
        <span class="na">welcomeMessage</span><span class="p">:</span> <span class="s1">'Hello! Welcome to the actionhero api'</span><span class="p">,</span>
        <span class="na">cachePrefix</span><span class="p">:</span> <span class="s1">'actionhero:cache:'</span><span class="p">,</span>
        <span class="na">lockPrefix</span><span class="p">:</span> <span class="s1">'actionhero:lock:'</span><span class="p">,</span>
        <span class="na">lockDuration</span><span class="p">:</span> <span class="mi">10000</span><span class="p">,</span>
        <span class="na">developmentMode</span><span class="p">:</span> <span class="kc">false</span><span class="p">,</span>
        <span class="na">simultaneousActions</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span>
        <span class="na">disableParamScrubbing</span><span class="p">:</span> <span class="kc">false</span><span class="p">,</span>
        <span class="na">filteredParams</span><span class="p">:</span> <span class="p">[],</span>
        <span class="na">missingParamChecks</span><span class="p">:</span> <span class="p">[</span><span class="nb">Object</span><span class="p">],</span>
        <span class="na">directoryFileType</span><span class="p">:</span> <span class="s1">'index.html'</span><span class="p">,</span>
        <span class="na">defaultMiddlewarePriority</span><span class="p">:</span> <span class="mi">100</span><span class="p">,</span>
        <span class="na">paths</span><span class="p">:</span> <span class="p">[</span><span class="nb">Object</span><span class="p">],</span>
        <span class="na">startingChatRooms</span><span class="p">:</span> <span class="p">[</span><span class="nb">Object</span><span class="p">],</span>
        <span class="na">plugins</span><span class="p">:</span> <span class="p">[]</span> <span class="p">},</span>
     <span class="na">errors</span><span class="p">:</span>
      <span class="p">{</span> <span class="na">_toExpand</span><span class="p">:</span> <span class="kc">false</span><span class="p">,</span>
        <span class="na">missingParams</span><span class="p">:</span> <span class="p">[</span><span class="nb">Function</span><span class="p">],</span>
        <span class="na">unknownAction</span><span class="p">:</span> <span class="p">[</span><span class="nb">Function</span><span class="p">],</span>
        <span class="na">unsupportedServerType</span><span class="p">:</span> <span class="p">[</span><span class="nb">Function</span><span class="p">],</span>
        <span class="na">serverShuttingDown</span><span class="p">:</span> <span class="p">[</span><span class="nb">Function</span><span class="p">],</span>
        <span class="na">tooManyPendingActions</span><span class="p">:</span> <span class="p">[</span><span class="nb">Function</span><span class="p">],</span>
        <span class="na">fileNotFound</span><span class="p">:</span> <span class="p">[</span><span class="nb">Function</span><span class="p">],</span>
        <span class="na">fileNotProvided</span><span class="p">:</span> <span class="p">[</span><span class="nb">Function</span><span class="p">],</span>
        <span class="na">fileReadError</span><span class="p">:</span> <span class="p">[</span><span class="nb">Function</span><span class="p">],</span>
        <span class="na">verbNotFound</span><span class="p">:</span> <span class="p">[</span><span class="nb">Function</span><span class="p">],</span>
        <span class="na">verbNotAllowed</span><span class="p">:</span> <span class="p">[</span><span class="nb">Function</span><span class="p">],</span>
        <span class="na">connectionRoomAndMessage</span><span class="p">:</span> <span class="p">[</span><span class="nb">Function</span><span class="p">],</span>
        <span class="na">connectionNotInRoom</span><span class="p">:</span> <span class="p">[</span><span class="nb">Function</span><span class="p">],</span>
        <span class="na">connectionAlreadyInRoom</span><span class="p">:</span> <span class="p">[</span><span class="nb">Function</span><span class="p">],</span>
        <span class="na">connectionRoomHasBeenDeleted</span><span class="p">:</span> <span class="p">[</span><span class="nb">Function</span><span class="p">],</span>
        <span class="na">connectionRoomNotExist</span><span class="p">:</span> <span class="p">[</span><span class="nb">Function</span><span class="p">],</span>
        <span class="na">connectionRoomExists</span><span class="p">:</span> <span class="p">[</span><span class="nb">Function</span><span class="p">],</span>
        <span class="na">connectionRoomRequired</span><span class="p">:</span> <span class="p">[</span><span class="nb">Function</span><span class="p">]</span> <span class="p">},</span>
     <span class="na">logger</span><span class="p">:</span> <span class="p">{</span> <span class="na">transports</span><span class="p">:</span> <span class="p">[</span><span class="nb">Object</span><span class="p">]</span> <span class="p">},</span>
     <span class="na">redis</span><span class="p">:</span>
      <span class="p">{</span> <span class="na">channel</span><span class="p">:</span> <span class="s1">'actionhero'</span><span class="p">,</span>
        <span class="na">rpcTimeout</span><span class="p">:</span> <span class="mi">5000</span><span class="p">,</span>
        <span class="na">pkg</span><span class="p">:</span> <span class="s1">'fakeredis'</span> <span class="p">},</span>
     <span class="na">routes</span><span class="p">:</span> <span class="p">{},</span>
     <span class="na">servers</span><span class="p">:</span>
      <span class="p">{</span> <span class="na">socket</span><span class="p">:</span> <span class="p">[</span><span class="nb">Object</span><span class="p">],</span>
        <span class="na">web</span><span class="p">:</span> <span class="p">[</span><span class="nb">Object</span><span class="p">],</span>
        <span class="na">websocket</span><span class="p">:</span> <span class="p">[</span><span class="nb">Object</span><span class="p">]</span> <span class="p">},</span>
     <span class="na">stats</span><span class="p">:</span> <span class="p">{</span> <span class="na">writeFrequency</span><span class="p">:</span> <span class="mi">1000</span><span class="p">,</span> <span class="na">keys</span><span class="p">:</span> <span class="p">[</span><span class="nb">Object</span><span class="p">]</span> <span class="p">},</span>
     <span class="na">tasks</span><span class="p">:</span>
      <span class="p">{</span> <span class="na">scheduler</span><span class="p">:</span> <span class="kc">false</span><span class="p">,</span>
        <span class="na">queues</span><span class="p">:</span> <span class="p">[],</span>
        <span class="na">timeout</span><span class="p">:</span> <span class="mi">5000</span><span class="p">,</span>
        <span class="na">minTaskProcessors</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
        <span class="na">maxTaskProcessors</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
        <span class="na">checkTimeout</span><span class="p">:</span> <span class="mi">500</span><span class="p">,</span>
        <span class="na">maxEventLoopDelay</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span>
        <span class="na">toDisconnectProcessors</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
        <span class="na">redis</span><span class="p">:</span> <span class="p">[</span><span class="nb">Object</span><span class="p">]</span> <span class="p">}</span> <span class="p">},</span>

  <span class="c1">// PIDS //</span>
  <span class="na">pids</span><span class="p">:</span>
   <span class="p">{</span> <span class="na">pid</span><span class="p">:</span> <span class="mi">26168</span><span class="p">,</span>
     <span class="na">path</span><span class="p">:</span> <span class="s1">'/Users/evantahler/Dropbox/Projects/actionhero/pids'</span><span class="p">,</span>
     <span class="na">sanitizeId</span><span class="p">:</span> <span class="p">[</span><span class="nb">Function</span><span class="p">],</span>
     <span class="na">title</span><span class="p">:</span> <span class="s1">'actionhero-10.0.1.5'</span><span class="p">,</span>
     <span class="na">writePidFile</span><span class="p">:</span> <span class="p">[</span><span class="nb">Function</span><span class="p">],</span>
     <span class="na">clearPidFile</span><span class="p">:</span> <span class="p">[</span><span class="nb">Function</span><span class="p">]</span> <span class="p">},</span>

  <span class="c1">// LOGGER //</span>
  <span class="na">logger</span><span class="p">:</span> <span class="p">{},</span>
  <span class="na">log</span><span class="p">:</span> <span class="p">[</span><span class="nb">Function</span><span class="p">],</span>

  <span class="c1">// EXCEPTION HANDLERS //</span>
  <span class="na">exceptionHandlers</span><span class="p">:{</span>
    <span class="na">reporters</span><span class="p">:</span> <span class="p">[</span> <span class="p">[</span><span class="nb">Function</span><span class="p">]</span> <span class="p">],</span>
    <span class="na">report</span><span class="p">:</span> <span class="p">[</span><span class="nb">Function</span><span class="p">],</span>
    <span class="na">loader</span><span class="p">:</span> <span class="p">[</span><span class="nb">Function</span><span class="p">],</span>
    <span class="na">action</span><span class="p">:</span> <span class="p">[</span><span class="nb">Function</span><span class="p">],</span>
    <span class="na">task</span><span class="p">:</span> <span class="p">[</span><span class="nb">Function</span><span class="p">]</span>
  <span class="p">},</span>

  <span class="c1">// REDIS //</span>
  <span class="na">redis</span><span class="p">:{</span>
    <span class="na">clusterCallbaks</span><span class="p">:</span> <span class="p">{},</span>
    <span class="na">clusterCallbakTimeouts</span><span class="p">:</span> <span class="p">{},</span>
    <span class="na">subscriptionHandlers</span><span class="p">:{</span>
      <span class="na">do</span><span class="p">:</span> <span class="p">[</span><span class="nb">Function</span><span class="p">],</span>
      <span class="na">doResponse</span><span class="p">:</span> <span class="p">[</span><span class="nb">Function</span><span class="p">],</span>
      <span class="na">chat</span><span class="p">:</span> <span class="p">[</span><span class="nb">Function</span><span class="p">]</span>
    <span class="p">},</span>
    <span class="na">status</span><span class="p">:{</span>
      <span class="na">client</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
      <span class="na">subscriber</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
      <span class="na">subscribed</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
      <span class="na">calledback</span><span class="p">:</span> <span class="kc">true</span>
    <span class="p">},</span>
    <span class="na">initialize</span><span class="p">:</span> <span class="p">[</span><span class="nb">Function</span><span class="p">],</span>
    <span class="na">subscribe</span><span class="p">:</span> <span class="p">[</span><span class="nb">Function</span><span class="p">],</span>
    <span class="na">publish</span><span class="p">:</span> <span class="p">[</span><span class="nb">Function</span><span class="p">],</span>
    <span class="na">doCluster</span><span class="p">:</span> <span class="p">[</span><span class="nb">Function</span><span class="p">],</span>
    <span class="na">respondCluster</span><span class="p">:</span> <span class="p">[</span><span class="nb">Function</span><span class="p">],</span>
    <span class="na">client</span><span class="p">:</span> <span class="p">{</span> <span class="p">},</span>
    <span class="na">subscriber</span><span class="p">:</span> <span class="p">{</span> <span class="p">},</span>

  <span class="c1">// CACHE //</span>
  <span class="na">cache</span><span class="p">:{</span>
    <span class="na">redisPrefix</span><span class="p">:</span> <span class="s1">'actionhero:cache:'</span><span class="p">,</span>
    <span class="na">lockPrefix</span><span class="p">:</span> <span class="s1">'actionhero:lock:'</span><span class="p">,</span>
    <span class="na">lockDuration</span><span class="p">:</span> <span class="mi">10000</span><span class="p">,</span>
    <span class="na">lockName</span><span class="p">:</span> <span class="s1">'10.0.1.5'</span><span class="p">,</span>
    <span class="na">lockRetry</span><span class="p">:</span> <span class="mi">100</span><span class="p">,</span>
    <span class="na">keys</span><span class="p">:</span> <span class="p">[</span><span class="nb">Function</span><span class="p">],</span>
    <span class="na">locks</span><span class="p">:</span> <span class="p">[</span><span class="nb">Function</span><span class="p">],</span>
    <span class="na">size</span><span class="p">:</span> <span class="p">[</span><span class="nb">Function</span><span class="p">],</span>
    <span class="na">clear</span><span class="p">:</span> <span class="p">[</span><span class="nb">Function</span><span class="p">],</span>
    <span class="na">dumpWrite</span><span class="p">:</span> <span class="p">[</span><span class="nb">Function</span><span class="p">],</span>
    <span class="na">dumpRead</span><span class="p">:</span> <span class="p">[</span><span class="nb">Function</span><span class="p">],</span>
    <span class="na">saveDumpedElement</span><span class="p">:</span> <span class="p">[</span><span class="nb">Function</span><span class="p">],</span>
    <span class="na">load</span><span class="p">:</span> <span class="p">[</span><span class="nb">Function</span><span class="p">],</span>
    <span class="na">destroy</span><span class="p">:</span> <span class="p">[</span><span class="nb">Function</span><span class="p">],</span>
    <span class="na">save</span><span class="p">:</span> <span class="p">[</span><span class="nb">Function</span><span class="p">],</span>
    <span class="na">lock</span><span class="p">:</span> <span class="p">[</span><span class="nb">Function</span><span class="p">],</span>
    <span class="na">unlock</span><span class="p">:</span> <span class="p">[</span><span class="nb">Function</span><span class="p">],</span>
    <span class="na">checkLock</span><span class="p">:</span> <span class="p">[</span><span class="nb">Function</span><span class="p">]</span>
  <span class="p">},</span>

  <span class="c1">// STATS //</span>
  <span class="na">stats</span><span class="p">:{</span>
    <span class="c1">// timer: null,</span>
    <span class="c1">// pendingIncrements: {},</span>
    <span class="na">increment</span><span class="p">:</span> <span class="p">[</span><span class="nb">Function</span><span class="p">],</span>
    <span class="c1">// writeIncrements: [Function],</span>
    <span class="na">get</span><span class="p">:</span> <span class="p">[</span><span class="nb">Function</span><span class="p">],</span>
    <span class="na">getAll</span><span class="p">:</span> <span class="p">[</span><span class="nb">Function</span><span class="p">]</span>
  <span class="p">},</span>

  <span class="c1">// CONNECTIONS //</span>
  <span class="na">connections</span><span class="p">:{</span>
    <span class="na">createCallbacks</span><span class="p">:</span> <span class="p">{},</span>
    <span class="na">destroyCallbacks</span><span class="p">:</span> <span class="p">{},</span>
    <span class="na">allowedVerbs</span><span class="p">:[</span>
      <span class="s1">'quit'</span><span class="p">,</span>
      <span class="s1">'exit'</span><span class="p">,</span>
      <span class="s1">'documentation'</span><span class="p">,</span>
      <span class="s1">'paramAdd'</span><span class="p">,</span>
      <span class="s1">'paramDelete'</span><span class="p">,</span>
      <span class="s1">'paramView'</span><span class="p">,</span>
      <span class="s1">'paramsView'</span><span class="p">,</span>
      <span class="s1">'paramsDelete'</span><span class="p">,</span>
      <span class="s1">'roomAdd'</span><span class="p">,</span>
      <span class="s1">'roomLeave'</span><span class="p">,</span>
      <span class="s1">'roomView'</span><span class="p">,</span>
      <span class="s1">'detailsView'</span><span class="p">,</span>
      <span class="s1">'say'</span>
      <span class="p">],</span>
     <span class="na">connections</span><span class="p">:</span> <span class="p">{},</span>
     <span class="c1">// apply: [Function],</span>
     <span class="c1">// applyCatch: [Function],</span>
     <span class="na">addCreateCallback</span><span class="p">:</span> <span class="p">[</span><span class="nb">Function</span><span class="p">],</span>
     <span class="na">addDestroyCallback</span><span class="p">:</span> <span class="p">[</span><span class="nb">Function</span><span class="p">]</span>
  <span class="p">},</span>
  <span class="na">connection</span><span class="p">:</span> <span class="p">[</span><span class="nb">Function</span><span class="p">],</span> <span class="c1">// prototype</span>

  <span class="c1">// ACTIONS //</span>
  <span class="na">actions</span><span class="p">:{</span>
    <span class="na">actions</span><span class="p">:</span> <span class="p">{},</span>
    <span class="na">preProcessors</span><span class="p">:</span> <span class="p">{},</span>
    <span class="na">postProcessors</span><span class="p">:</span> <span class="p">{},</span>
    <span class="na">addPreProcessor</span><span class="p">:</span> <span class="p">[</span><span class="nb">Function</span><span class="p">],</span>
    <span class="na">addPostProcessor</span><span class="p">:</span> <span class="p">[</span><span class="nb">Function</span><span class="p">],</span>
    <span class="c1">// validateAction: [Function],</span>
    <span class="c1">// loadFile: [Function]</span>
  <span class="p">},</span>
  <span class="na">actionProcessor</span><span class="p">:</span> <span class="p">[</span><span class="nb">Function</span><span class="p">],</span> <span class="c1">// prototype</span>

  <span class="c1">// PARAMS //</span>
  <span class="na">params</span><span class="p">:{</span>
    <span class="na">globalSafeParams</span><span class="p">:</span> <span class="p">[</span>
      <span class="s1">'file'</span><span class="p">,</span>
      <span class="s1">'apiVersion'</span><span class="p">,</span>
      <span class="s1">'callback'</span><span class="p">,</span>
      <span class="s1">'action'</span>
    <span class="p">],</span>
    <span class="c1">// buildPostVariables: [Function],</span>
    <span class="na">postVariables</span><span class="p">:</span> <span class="p">[]</span>
   <span class="p">},</span>

  <span class="c1">// SERVERS //</span>
  <span class="na">genericServer</span><span class="p">:</span> <span class="p">{},</span> <span class="c1">// prototype</span>
  <span class="na">servers</span><span class="p">:</span> <span class="p">{</span>
    <span class="na">servers</span><span class="p">:</span> <span class="p">[]</span>
  <span class="p">},</span>

  <span class="c1">// ROUTES //</span>
  <span class="na">routes</span><span class="p">:</span> <span class="p">{</span>
    <span class="na">routes</span><span class="p">:</span> <span class="p">{</span>
      <span class="na">get</span><span class="p">:</span> <span class="p">[</span><span class="nb">Object</span><span class="p">],</span>
      <span class="na">post</span><span class="p">:</span> <span class="p">[</span><span class="nb">Object</span><span class="p">],</span>
      <span class="na">put</span><span class="p">:</span> <span class="p">[</span><span class="nb">Object</span><span class="p">],</span>
      <span class="na">patch</span><span class="p">:</span> <span class="p">[</span><span class="nb">Object</span><span class="p">],</span>
      <span class="na">delete</span><span class="p">:</span> <span class="p">[</span><span class="nb">Object</span><span class="p">]</span>
    <span class="p">},</span>
     <span class="c1">// verbs: [],</span>
     <span class="c1">// processRoute: [Function],</span>
     <span class="c1">// matchURL: [Function],</span>
     <span class="c1">// loadRoutes: [Function],</span>
   <span class="p">},</span>

  <span class="c1">// STATIC FILES //</span>
  <span class="na">staticFile</span><span class="p">:{</span>
    <span class="c1">// path: [Function],</span>
    <span class="c1">// get: [Function],</span>
    <span class="na">sendFile</span><span class="p">:</span> <span class="p">[</span><span class="nb">Function</span><span class="p">],</span>
    <span class="c1">// sendFileNotFound: [Function],</span>
    <span class="c1">// checkExistence: [Function],</span>
    <span class="c1">// logRequest: [Function]</span>
  <span class="p">},</span>

  <span class="c1">// CHAT //</span>
  <span class="na">chatRoom</span><span class="p">:{</span>
    <span class="na">keys</span><span class="p">:</span> <span class="p">{</span>
      <span class="na">rooms</span><span class="p">:</span> <span class="s1">'actionhero:chatRoom:rooms'</span><span class="p">,</span>
      <span class="na">members</span><span class="p">:</span> <span class="s1">'actionhero:chatRoom:members:'</span>
    <span class="p">},</span>
    <span class="na">messageChannel</span><span class="p">:</span> <span class="s1">'/actionhero/chat/chat'</span><span class="p">,</span>
    <span class="na">joinCallbacks</span><span class="p">:</span> <span class="p">{},</span>
    <span class="na">leaveCallbacks</span><span class="p">:</span> <span class="p">{},</span>
    <span class="na">sayCallbacks</span><span class="p">:</span> <span class="p">{},</span>
    <span class="na">addJoinCallback</span><span class="p">:</span> <span class="p">[</span><span class="nb">Function</span><span class="p">],</span>
    <span class="na">addLeaveCallback</span><span class="p">:</span> <span class="p">[</span><span class="nb">Function</span><span class="p">],</span>
    <span class="na">addSayCallback</span><span class="p">:</span> <span class="p">[</span><span class="nb">Function</span><span class="p">],</span>
    <span class="na">broadcast</span><span class="p">:</span> <span class="p">[</span><span class="nb">Function</span><span class="p">],</span>
    <span class="na">generateMessagePayload</span><span class="p">:</span> <span class="p">[</span><span class="nb">Function</span><span class="p">],</span>
    <span class="na">incomingMessage</span><span class="p">:</span> <span class="p">[</span><span class="nb">Function</span><span class="p">],</span>
    <span class="na">add</span><span class="p">:</span> <span class="p">[</span><span class="nb">Function</span><span class="p">],</span>
    <span class="na">destroy</span><span class="p">:</span> <span class="p">[</span><span class="nb">Function</span><span class="p">],</span>
    <span class="na">exists</span><span class="p">:</span> <span class="p">[</span><span class="nb">Function</span><span class="p">],</span>
    <span class="na">sanitizeMemberDetails</span><span class="p">:</span> <span class="p">[</span><span class="nb">Function</span><span class="p">],</span>
    <span class="na">roomStatus</span><span class="p">:</span> <span class="p">[</span><span class="nb">Function</span><span class="p">],</span>
    <span class="na">generateMemberDetails</span><span class="p">:</span> <span class="p">[</span><span class="nb">Function</span><span class="p">],</span>
    <span class="na">addMember</span><span class="p">:</span> <span class="p">[</span><span class="nb">Function</span><span class="p">],</span>
    <span class="na">removeMember</span><span class="p">:</span> <span class="p">[</span><span class="nb">Function</span><span class="p">],</span>
    <span class="c1">// handleCallbacks: [Function],</span>
  <span class="p">},</span>

  <span class="c1">// RESQUE //</span>
  <span class="na">resque</span><span class="p">:</span> <span class="p">{</span>
    <span class="na">queue</span><span class="p">:</span> <span class="p">{},</span>
    <span class="na">multiWorker</span><span class="p">:</span> <span class="p">{},</span>
    <span class="na">scheduler</span><span class="p">:</span> <span class="kc">null</span><span class="p">,</span>
    <span class="c1">// connectionDetails: {},</span>
    <span class="c1">// startQueue: [Function],</span>
    <span class="c1">// startScheduler: [Function],</span>
    <span class="c1">// stopScheduler: [Function],</span>
    <span class="c1">// startMultiWorker: [Function],</span>
    <span class="c1">// stopMultiWorker: [Function],</span>
  <span class="p">},</span>

  <span class="c1">// TASKS //</span>
  <span class="na">tasks</span><span class="p">:{</span>
    <span class="na">tasks</span><span class="p">:</span> <span class="p">{},</span>
    <span class="na">jobs</span><span class="p">:</span>  <span class="p">{},</span>
    <span class="c1">// loadFile: [Function],</span>
    <span class="c1">// jobWrapper: [Function],</span>
    <span class="c1">// validateTask: [Function],</span>
    <span class="na">enqueue</span><span class="p">:</span> <span class="p">[</span><span class="nb">Function</span><span class="p">],</span>
    <span class="na">enqueueAt</span><span class="p">:</span> <span class="p">[</span><span class="nb">Function</span><span class="p">],</span>
    <span class="na">enqueueIn</span><span class="p">:</span> <span class="p">[</span><span class="nb">Function</span><span class="p">],</span>
    <span class="na">del</span><span class="p">:</span> <span class="p">[</span><span class="nb">Function</span><span class="p">],</span>
    <span class="na">delDelayed</span><span class="p">:</span> <span class="p">[</span><span class="nb">Function</span><span class="p">],</span>
    <span class="na">scheduledAt</span><span class="p">:</span> <span class="p">[</span><span class="nb">Function</span><span class="p">],</span>
    <span class="na">timestamps</span><span class="p">:</span> <span class="p">[</span><span class="nb">Function</span><span class="p">],</span>
    <span class="na">delayedAt</span><span class="p">:</span> <span class="p">[</span><span class="nb">Function</span><span class="p">],</span>
    <span class="na">allDelayed</span><span class="p">:</span> <span class="p">[</span><span class="nb">Function</span><span class="p">],</span>
    <span class="c1">// enqueueRecurrentJob: [Function],</span>
    <span class="c1">// enqueueAllRecurrentJobs: [Function],</span>
    <span class="na">stopRecurrentJob</span><span class="p">:</span> <span class="p">[</span><span class="nb">Function</span><span class="p">],</span>
    <span class="na">details</span><span class="p">:</span> <span class="p">[</span><span class="nb">Function</span><span class="p">]</span> <span class="p">},</span>

  <span class="c1">// DOCUMENATION //</span>
  <span class="na">doumentation</span><span class="p">:</span> <span class="p">{}</span>

<span class="p">};</span>
</code></pre>

<p>By now you will have noticed that most sections of ActionHero are initialized with access to the <code class="prettyprint">api</code> object.  The <code class="prettyprint">api</code> object is the top-level container/namespace for all of ActionHero&rsquo;s data and methods.  We use the <code class="prettyprint">api</code> object to avoid polluting any global namespaces.  The api object is available to all parts of ActionHero to share data and state.  Feel free to modify or add too the api object as you see fit, but be mindful of the data it already contains.  </p>

<p>Collections that you are recommended not leave unmodified are un-expanded <code class="prettyprint">[Object]</code>s and/or commented out.</p>

          <h1 id="web-server">Web Server</h1>

<h2 id="general">General</h2>
<pre class="highlight javascript"><code>
<span class="p">{</span>
  <span class="nl">hello</span><span class="p">:</span> <span class="s2">"world"</span>
  <span class="nl">serverInformation</span><span class="p">:</span> <span class="p">{</span>
    <span class="nl">serverName</span><span class="p">:</span> <span class="s2">"actionhero API"</span><span class="p">,</span>
    <span class="nx">apiVersion</span><span class="err">:</span> <span class="mi">1</span><span class="p">,</span>
    <span class="nx">requestDuration</span><span class="err">:</span> <span class="mi">14</span>
  <span class="p">},</span>
  <span class="nx">requestorInformation</span><span class="err">:</span> <span class="p">{</span>
    <span class="nl">remoteAddress</span><span class="p">:</span> <span class="s2">"127.0.0.1"</span><span class="p">,</span>
    <span class="nx">RequestsRemaining</span><span class="err">:</span> <span class="mi">989</span><span class="p">,</span>
    <span class="nx">recievedParams</span><span class="err">:</span> <span class="p">{</span>
      <span class="nl">action</span><span class="p">:</span> <span class="s2">""</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre>

<p>The web server exposes actions and files over http or https.  You can visit the API in a browser, Curl, etc. <code class="prettyprint">{url}?action=actioName</code> or <code class="prettyprint">{url}/api/{actioName}</code> is how you would access an action.  For example, using the default ports in <code class="prettyprint">/config/servers/web.js</code> you could reach the status action with both <code class="prettyprint">http://127.0.0.1:8080/status</code> or <code class="prettyprint">http://127.0.0.1:8080/?action=status</code>  </p>

<p>HTTP responses are always JSON and follow the format =&gt;</p>

<h2 id="http-example">HTTP Example:</h2>
<pre class="highlight shell"><code>
<span class="gp">&gt; </span>curl <span class="s1">'localhost:8080/api/status'</span> -v | python -mjson.tool
<span class="k">*</span> About to connect<span class="o">()</span> to localhost port 8080 <span class="o">(</span><span class="c">#0)</span>
<span class="k">*</span>   Trying 127.0.0.1...
<span class="k">*</span> connected
<span class="k">*</span> Connected to localhost <span class="o">(</span>127.0.0.1<span class="o">)</span> port 8080 <span class="o">(</span><span class="c">#0)</span>
<span class="gp">&gt; </span>GET /api/status HTTP/1.1
<span class="gp">&gt; </span>User-Agent: curl/7.24.0 <span class="o">(</span>x86_64-apple-darwin12.0<span class="o">)</span> libcurl/7.24.0 OpenSSL/0.9.8r zlib/1.2.5
<span class="gp">&gt; </span>Host: localhost:8080
<span class="gp">&gt; </span>Accept: <span class="k">*</span>/<span class="k">*</span>
&gt;
&lt; HTTP/1.1 200 OK
&lt; Content-Type: application/json
&lt; X-Powered-By: actionhero API
&lt; Date: Sun, 29 Jul 2012 23:25:53 GMT
&lt; Connection: keep-alive
&lt; Transfer-Encoding: chunked
&lt;
<span class="o">{</span> <span class="o">[</span>data not shown]
100   741    0   741    0     0   177k      0 --:--:-- --:--:-- --:--:--  361k
<span class="k">*</span> Connection <span class="c">#0 to host localhost left intact</span>
<span class="k">*</span> Closing connection <span class="c">#0</span>
<span class="o">{</span>
    <span class="s2">"requestorInformation"</span>: <span class="o">{</span>
        <span class="s2">"recievedParams"</span>: <span class="o">{</span>
            <span class="s2">"action"</span>: <span class="s2">"status"</span>,
        <span class="o">}</span>,
        <span class="s2">"remoteAddress"</span>: <span class="s2">"127.0.0.1"</span>
    <span class="o">}</span>,
    <span class="s2">"serverInformation"</span>: <span class="o">{</span>
        <span class="s2">"apiVersion"</span>: <span class="s2">"3.0.0"</span>,
        <span class="s2">"currentTime"</span>: 1343604353551,
        <span class="s2">"requestDuration"</span>: 1,
        <span class="s2">"serverName"</span>: <span class="s2">"actionhero API"</span>
    <span class="o">}</span>,
    <span class="s2">"stats"</span>: <span class="o">{</span>
        <span class="s2">"cache"</span>: <span class="o">{</span>
            <span class="s2">"numberOfObjects"</span>: 0
        <span class="o">}</span>,
        <span class="s2">"id"</span>: <span class="s2">"10.0.1.12:8080:4443:5000"</span>,
        <span class="s2">"memoryConsumption"</span>: 8421200,
        <span class="s2">"peers"</span>: <span class="o">[</span>
            <span class="s2">"10.0.1.12:8080:4443:5000"</span>
        <span class="o">]</span>,
        <span class="s2">"queue"</span>: <span class="o">{</span>
            <span class="s2">"queueLength"</span>: 0,
            <span class="s2">"sleepingTasks"</span>: <span class="o">[]</span>
        <span class="o">}</span>,
        <span class="s2">"socketServer"</span>: <span class="o">{</span>
            <span class="s2">"numberOfGlobalSocketRequests"</span>: 0,
            <span class="s2">"numberOfLocalActiveSocketClients"</span>: 0,
            <span class="s2">"numberOfLocalSocketRequests"</span>: 0
        <span class="o">}</span>,
        <span class="s2">"uptimeSeconds"</span>: 34.163,
        <span class="s2">"webServer"</span>: <span class="o">{</span>
            <span class="s2">"numberOfGlobalWebRequests"</span>: 5,
            <span class="s2">"numberOfLocalWebRequests"</span>: 3
        <span class="o">}</span>,
        <span class="s2">"webSocketServer"</span>: <span class="o">{</span>
            <span class="s2">"numberOfGlobalWebSocketRequests"</span>: 0,
            <span class="s2">"numberOfLocalActiveWebSocketClients"</span>: 0
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre>

<ul>
<li>you can provide the <code class="prettyprint">?callback=myFunc</code> param to initiate a JSONp response which will wrap the returned JSON in your callback function.  The mime type of the response will change from JSON to Javascript.</li>
<li>If everything went OK with your request, no error attribute will be set on the response, otherwise, you should see either a string or hash error response within your action</li>
<li>to build the response for &ldquo;hello&rdquo; above, the action would have set <code class="prettyprint">connection.response.hello = &quot;world&quot;;</code></li>
</ul>

<h2 id="config-settings">Config Settings</h2>

<p><code class="prettyprint">/config/servers/web.js</code> contains the settings for the web server.  The relevant options are:</p>
<pre class="highlight javascript"><code><span class="nx">config</span><span class="p">.</span><span class="nx">servers</span> <span class="o">=</span> <span class="p">{</span>
  <span class="s2">"web"</span> <span class="p">:</span> <span class="p">{</span>
    <span class="nl">secure</span><span class="p">:</span> <span class="kc">false</span><span class="p">,</span>                       <span class="c1">// HTTP or HTTPS?</span>
    <span class="na">serverOptions</span><span class="p">:</span> <span class="p">{},</span>                   <span class="c1">// Passed to https.createServer if secure=ture. Should contain SSL certificates</span>
    <span class="na">port</span><span class="p">:</span> <span class="mi">8080</span><span class="p">,</span>                          <span class="c1">// Port or Socket</span>
    <span class="na">bindIP</span><span class="p">:</span> <span class="s2">"0.0.0.0"</span><span class="p">,</span>                   <span class="c1">// Which IP to listen on (use 0.0.0.0 for all)</span>
    <span class="na">httpHeaders</span> <span class="p">:</span> <span class="p">{</span>                      <span class="c1">// Any additional headers you want actionhero to respond with</span>
      <span class="s1">'Access-Control-Allow-Origin'</span> <span class="p">:</span> <span class="s1">'*'</span><span class="p">,</span>
      <span class="s1">'Access-Control-Allow-Methods'</span><span class="p">:</span> <span class="s1">'PUT, GET, POST, DELETE, OPTIONS'</span><span class="p">,</span>
      <span class="s1">'Access-Control-Allow-Headers'</span><span class="p">:</span> <span class="s1">'Content-Type'</span>
    <span class="p">},</span>    
    <span class="na">urlPathForActions</span> <span class="p">:</span> <span class="s2">"api"</span><span class="p">,</span>           <span class="c1">// Route that actions will be served from; secondary route against this route will be treated as actions, IE: /api/?action=test == /api/test/</span>
    <span class="na">urlPathForFiles</span> <span class="p">:</span> <span class="s2">"public"</span><span class="p">,</span>          <span class="c1">// Route that static files will be served from; path (relitive to your project root) to server static content from</span>
    <span class="na">rootEndpointType</span> <span class="p">:</span> <span class="s2">"api"</span><span class="p">,</span>            <span class="c1">// When visiting the root URL, should visitors see "api" or "file"? Visitors can always visit /api and /public as normal</span>
    <span class="na">directoryFileType</span> <span class="p">:</span> <span class="s2">"index.html"</span><span class="p">,</span>    <span class="c1">// The default filetype to server when a user requests a directory</span>
    <span class="na">flatFileCacheDuration</span> <span class="p">:</span> <span class="mi">60</span><span class="p">,</span>          <span class="c1">// The header which will be returned for all flat file served from /public; defined in seconds</span>
    <span class="na">fingerprintOptions</span> <span class="p">:</span> <span class="p">{</span>               <span class="c1">// Settings for determining the id of an http(s) requset (browser-fingerprint)</span>
      <span class="na">cookieKey</span><span class="p">:</span> <span class="s2">"sessionID"</span><span class="p">,</span>
      <span class="na">toSetCookie</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
      <span class="na">onlyStaticElements</span><span class="p">:</span> <span class="kc">false</span>
    <span class="p">},</span>
    <span class="na">formOptions</span><span class="p">:</span> <span class="p">{</span>                       <span class="c1">// Options to be applied to incomming file uplaods. More options and details at https://github.com/felixge/node-formidable</span>
      <span class="na">uploadDir</span><span class="p">:</span> <span class="s2">"/tmp"</span><span class="p">,</span>
      <span class="na">keepExtensions</span><span class="p">:</span> <span class="kc">false</span><span class="p">,</span>
      <span class="na">maxFieldsSize</span><span class="p">:</span> <span class="mi">1024</span> <span class="o">*</span> <span class="mi">1024</span> <span class="o">*</span> <span class="mi">100</span>
    <span class="p">},</span>
    <span class="na">metadataOptions</span><span class="p">:</span> <span class="p">{</span>                   <span class="c1">// Options to configure metadata in responses</span>
      <span class="na">serverInformation</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
      <span class="na">requestorInformation</span><span class="p">:</span> <span class="kc">true</span>
    <span class="p">},</span>
    <span class="c1">// When true, returnErrorCodes will modify the response header for http(s) clients if connection.error is not null.</span>
    <span class="c1">// You can also set connection.rawConnection.responseHttpCode to specify a code per request.</span>
    <span class="na">returnErrorCodes</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
    <span class="c1">// should this node server attempt to gzip responses if the client can accept them?</span>
    <span class="c1">// this will slow down the performance of actionhero, and if you need this funcionality, it is recommended that you do this upstream with nginx or your load balancer</span>
    <span class="na">compress</span><span class="p">:</span> <span class="kc">false</span><span class="p">,</span>
    <span class="c1">// options to pass to the query parser</span>
    <span class="c1">// learn more about the options @ https://github.com/hapijs/qs</span>
    <span class="na">queryParseOptions</span><span class="p">:</span> <span class="p">{},</span>
    <span class="c1">// when true, an ETAG Header will be provided with each requested static file for caching reasons</span>
    <span class="na">enableEtag</span><span class="p">:</span> <span class="kc">true</span>  
  <span class="p">}</span>
<span class="p">}</span>  
</code></pre>

<p>Note that if you wish to create a secure (https) server, you will be required to complete the serverOptions hash with at least a cert and a keyfile:</p>
<pre class="highlight javascript"><code><span class="nx">config</span><span class="p">.</span><span class="nx">server</span><span class="p">.</span><span class="nx">web</span><span class="p">.</span><span class="nx">serverOptions</span><span class="err">:</span> <span class="p">{</span>
  <span class="nl">key</span><span class="p">:</span> <span class="nx">fs</span><span class="p">.</span><span class="nx">readFileSync</span><span class="p">(</span><span class="s1">'certs/server-key.pem'</span><span class="p">),</span>
  <span class="nx">cert</span><span class="err">:</span> <span class="nx">fs</span><span class="p">.</span><span class="nx">readFileSync</span><span class="p">(</span><span class="s1">'certs/server-cert.pem'</span><span class="p">)</span>
<span class="p">}</span>
</code></pre>

<h2 id="the-connection-object">The <code class="prettyprint">connection</code> object</h2>
<pre class="highlight javascript"><code><span class="p">{</span> <span class="nl">id</span><span class="p">:</span> <span class="s1">'3e55b464fd34708eba26f609f44481a120e094a8-a6dfb60b-9562-4cc0-9d92-bc6cc1b622ba'</span><span class="p">,</span>
  <span class="nx">connectedAt</span><span class="err">:</span> <span class="mi">1447554153233</span><span class="p">,</span>
  <span class="nx">type</span><span class="err">:</span> <span class="s1">'web'</span><span class="p">,</span>
  <span class="nx">rawConnection</span><span class="err">:</span>
   <span class="p">{</span>
     <span class="nl">req</span><span class="p">:</span> <span class="p">{},</span>
     <span class="nx">res</span><span class="err">:</span> <span class="p">{},</span>
     <span class="nx">params</span><span class="err">:</span> <span class="p">{</span> <span class="nl">query</span><span class="p">:</span> <span class="p">{}</span> <span class="p">},</span>
     <span class="nx">method</span><span class="err">:</span> <span class="s1">'GET'</span><span class="p">,</span>
     <span class="nx">cookies</span><span class="err">:</span> <span class="p">{},</span>
     <span class="nx">responseHeaders</span><span class="err">:</span> <span class="p">[</span> <span class="p">[</span><span class="nb">Object</span><span class="p">],</span> <span class="p">[</span><span class="nb">Object</span><span class="p">],</span> <span class="p">[</span><span class="nb">Object</span><span class="p">],</span> <span class="p">[</span><span class="nb">Object</span><span class="p">],</span> <span class="p">[</span><span class="nb">Object</span><span class="p">],</span> <span class="p">[</span><span class="nb">Object</span><span class="p">]</span> <span class="p">],</span>
     <span class="nx">responseHttpCode</span><span class="err">:</span> <span class="mi">200</span><span class="p">,</span>
     <span class="nx">parsedURL</span><span class="err">:</span>
      <span class="nx">Url</span> <span class="p">{},</span>
  <span class="nx">remotePort</span><span class="err">:</span> <span class="mi">57259</span><span class="p">,</span>
  <span class="nx">remoteIP</span><span class="err">:</span> <span class="s1">'127.0.0.1'</span><span class="p">,</span>
  <span class="nx">error</span><span class="err">:</span> <span class="kc">null</span><span class="p">,</span>
  <span class="nx">fingerprint</span><span class="err">:</span> <span class="s1">'3e55b464fd34708eba26f609f44481a120e094a8'</span><span class="p">,</span>
  <span class="nx">rooms</span><span class="err">:</span> <span class="p">[],</span>
  <span class="nx">params</span><span class="err">:</span> <span class="p">{</span> <span class="nl">action</span><span class="p">:</span> <span class="s1">'randomNumber'</span><span class="p">,</span> <span class="nx">apiVersion</span><span class="err">:</span> <span class="mi">1</span> <span class="p">},</span>
  <span class="nx">pendingActions</span><span class="err">:</span> <span class="mi">1</span><span class="p">,</span>
  <span class="nx">totalActions</span><span class="err">:</span> <span class="mi">1</span><span class="p">,</span>
  <span class="nx">messageCount</span><span class="err">:</span> <span class="mi">0</span><span class="p">,</span>
  <span class="nx">canChat</span><span class="err">:</span> <span class="kc">false</span><span class="p">,</span>
  <span class="nx">sendMessage</span><span class="err">:</span> <span class="p">[</span><span class="nb">Function</span><span class="p">],</span>
  <span class="nx">sendFile</span><span class="err">:</span> <span class="p">[</span><span class="nb">Function</span><span class="p">]</span> <span class="p">}</span>
</code></pre>

<p>when inspecting <code class="prettyprint">connection</code> in actions from web client, a few additional elements are added for convenience:</p>

<ul>
<li><code class="prettyprint">connection.rawConnection.responseHeaders</code>: array of headers which can be built up in the action.  Headers will be made unique, and latest header will be used (except setting cookies)</li>
<li><code class="prettyprint">connection.rawConnection.method</code>: A string, GET, POST, etc</li>
<li><code class="prettyprint">connection.rawConnection.cookies</code>: Hash representation of the connection&rsquo;s cookies</li>
<li><code class="prettyprint">connection.rawConnection.responseHttpCode</code>: the status code to be rendered to the user.  Defaults to 200</li>
<li><code class="prettyprint">connection.type</code> for a HTTP client is &ldquo;web&rdquo;</li>
<li><code class="prettyprint">connection.rawConnection.params.body</code> will contain un-filtered form data</li>
<li><code class="prettyprint">connection.rawConnection.params.files</code> will contain un-filtered form data</li>
<li><code class="prettyprint">connection.extension</code>.  If are using a route to access an action, and the request path ends in a file extension (IE: <code class="prettyprint">server.com/action/option.jpg</code>), the extension will be available.  Depending on the server&rsquo;s options, this extension may also be used to modify the response mime-type by configuring <code class="prettyprint">matchExtensionMimeType</code> within each action.</li>
</ul>

<p>Of course, the generic connection attributes (<code class="prettyprint">connection.error</code>, <code class="prettyprint">connection.params</code>, etc) will be present.</p>

<h2 id="sending-files">Sending Files</h2>
<pre class="highlight javascript"><code><span class="nx">data</span><span class="p">.</span><span class="nx">connection</span><span class="p">.</span><span class="nx">sendFile</span><span class="p">(</span><span class="s1">'/path/to/file.mp3'</span><span class="p">);</span>
<span class="nx">data</span><span class="p">.</span><span class="nx">toRender</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
<span class="nx">next</span><span class="p">();</span>
</code></pre>

<p>actionhero can also serve up flat files.  actionhero will not cache these files and each request to <code class="prettyprint">file</code> will re-read the file from disk (like the nginx web server).</p>

<ul>
<li>/public and /api are  routes which expose the &lsquo;directories&rsquo; of those types.  These top level path can be configured in <code class="prettyprint">/config/servers/web.js</code> with <code class="prettyprint">api.config.servers.web.urlPathForActions</code> and <code class="prettyprint">api.config.servers.web.urlPathForFiles</code>.</li>
<li>the root of the web server &ldquo;/&rdquo; can be toggled to serve the content between /file or /api actions per your needs <code class="prettyprint">api.config.servers.web.rootEndpointType</code>. The default is <code class="prettyprint">api</code>.</li>
<li>actionhero will serve up flat files (html, images, etc) as well from your ./public folder.  This is accomplished via the &#39;file&rsquo; route as described above. <code class="prettyprint">http://{baseUrl}/public/{pathToFile}</code> is equivalent to <code class="prettyprint">http://{baseUrl}?action=file&amp;fileName={pathToFile}</code> and <code class="prettyprint">http://{baseUrl}/file/{pathToFile}</code>.</li>
<li>Errors will result in a 404 (file not found) with a message you can customize.</li>
<li>Proper mime-type headers will be set when possible via the <code class="prettyprint">mime</code> package.</li>
</ul>

<p>There are helpers you can use in your actions to send files:</p>

<p>See the <a href="/docs#file-server">file server</a> page for more documentation</p>

<h2 id="routes">Routes</h2>

<p>For web clients (http and https), you can define an optional RESTful mapping to help route requests to actions.  If the client doesn&rsquo;t specify an action via a param, and the base route isn&rsquo;t a named action, the action will attempt to be discerned from this <code class="prettyprint">config/routes.js</code> file.</p>

<h4 id="example">Example</h4>

<p>This variables in play here are:</p>

<ul>
<li><code class="prettyprint">api.config.servers.web.urlPathForActions</code></li>
<li><code class="prettyprint">api.config.servers.web.rootEndpointType</code></li>
<li>and of course the content of <code class="prettyprint">config/routes.js</code></li>
</ul>

<p>Say you have an action called &#39;status&rsquo; (like in a freshly generated actionhero project).
Lets start with actionhero&rsquo;s default config:</p>
<pre class="highlight javascript"><code><span class="nx">api</span><span class="p">.</span><span class="nx">config</span><span class="p">.</span><span class="nx">servers</span><span class="p">.</span><span class="nx">web</span><span class="p">.</span><span class="nx">urlPathForActions</span> <span class="o">=</span> <span class="s1">'api'</span><span class="p">;</span>
<span class="nx">api</span><span class="p">.</span><span class="nx">config</span><span class="p">.</span><span class="nx">servers</span><span class="p">.</span><span class="nx">web</span><span class="p">.</span><span class="nx">urlPathForFiles</span> <span class="o">=</span> <span class="s1">'public'</span><span class="p">;</span>
<span class="nx">api</span><span class="p">.</span><span class="nx">config</span><span class="p">.</span><span class="nx">servers</span><span class="p">.</span><span class="nx">web</span><span class="p">.</span><span class="nx">rootEndpointType</span> <span class="o">=</span> <span class="s1">'file'</span><span class="p">;</span>
</code></pre>

<p>There are 3 ways a client can access actions via the web server.</p>

<ul>
<li>no routing at all and use GET params: <code class="prettyprint">server.com/api?action=status</code></li>
<li>with &#39;basic&rsquo; routing, where the action&rsquo;s name will respond after the /api path: <code class="prettyprint">server.com/api/status</code></li>
<li>or you can modify this with routes. Say you want <code class="prettyprint">server.com/api/stuff/statusPage</code></li>
</ul>
<pre class="highlight javascript"><code><span class="nx">exports</span><span class="p">.</span><span class="k">default</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">api</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="p">{</span>
    <span class="na">get</span><span class="p">:</span> <span class="p">[</span>
      <span class="p">{</span> <span class="na">path</span><span class="p">:</span> <span class="s1">'/stuff/statusPage'</span><span class="p">,</span> <span class="na">action</span><span class="p">:</span> <span class="s1">'status'</span> <span class="p">}</span>
    <span class="p">]</span>
  <span class="p">};</span>
<span class="p">}</span>
</code></pre>

<p>If the <code class="prettyprint">api.config.servers.web.rootEndpointType</code> is <code class="prettyprint">&quot;file&quot;</code> which means that the routes you are making are active only under the <code class="prettyprint">/api</code> path.  If you wanted the route example to become  <code class="prettyprint">server.com/stuff/statusPage</code>, you would need to change <code class="prettyprint">api.config.servers.web.rootEndpointType</code> to be &#39;api&rsquo;.  Note that making this change doesn&rsquo;t stop <code class="prettyprint">server.com/api/stuff/statusPage</code> from working as well, as you still have <code class="prettyprint">api.config.servers.web.urlPathForActions</code> set to be &#39;api&rsquo;, so both will continue to work.</p>

<p>For a route to match, all params must be satisfied.  So, if you expect a route to provide <code class="prettyprint">api/:a/:b/:c</code> and the request is only for <code class="prettyprint">api/:a/:c</code>, the route won&rsquo;t match. This holds for any variable, including <code class="prettyprint">:apiVersion</code>.  If you want to match both with and without apiVersion, just define the rote 2x, IE:</p>
<pre class="highlight javascript"><code><span class="nx">exports</span><span class="p">.</span><span class="k">default</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">api</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="p">{</span>
    <span class="na">all</span><span class="p">:</span> <span class="p">[</span>
      <span class="p">{</span> <span class="na">path</span><span class="p">:</span> <span class="s2">"/cache/:key/:value"</span><span class="p">,</span>             <span class="na">action</span><span class="p">:</span>  <span class="s2">"cacheTest"</span> <span class="p">},</span>
      <span class="p">{</span> <span class="na">path</span><span class="p">:</span> <span class="s2">"/:apiVersion/cache/:key/:value"</span><span class="p">,</span> <span class="na">action</span><span class="p">:</span>  <span class="s2">"cacheTest"</span> <span class="p">},</span>
    <span class="p">]</span>
  <span class="p">};</span>
<span class="p">}</span>
</code></pre>

<p>If you want to shut off access to your action at <code class="prettyprint">server.com/api/stuff/statusPage</code> and only allow access via <code class="prettyprint">server.com/stuff/statusPage</code>, you can disable <code class="prettyprint">api.config.servers.web.urlPathForActions</code> by setting it equal to <code class="prettyprint">null</code> (but keeping the <code class="prettyprint">api.config.servers.web.rootEndpointType</code> equal to &#39;api&rsquo;).</p>

<p>Routes will match the newest version of <code class="prettyprint">apiVersion</code>.  If you want to have a specific route match a specific version of an action, you can provide the <code class="prettyprint">apiVersion</code> param in your route definitions:</p>
<pre class="highlight javascript"><code><span class="nx">exports</span><span class="p">.</span><span class="k">default</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">api</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="p">{</span>
    <span class="na">get</span><span class="p">:</span> <span class="p">[</span>
      <span class="p">{</span> <span class="na">path</span><span class="p">:</span> <span class="s2">"/myAction/old"</span><span class="p">,</span> <span class="na">action</span><span class="p">:</span>  <span class="s2">"myAction"</span><span class="p">,</span> <span class="na">apiVersion</span><span class="p">:</span> <span class="mi">1</span> <span class="p">},</span>
      <span class="p">{</span> <span class="na">path</span><span class="p">:</span> <span class="s2">"/myAction/new"</span><span class="p">,</span> <span class="na">action</span><span class="p">:</span>  <span class="s2">"myAction"</span><span class="p">,</span> <span class="na">apiVersion</span><span class="p">:</span> <span class="mi">2</span> <span class="p">},</span>
    <span class="p">]</span>
  <span class="p">};</span>
<span class="p">}</span>
</code></pre>

<p>This would create both <code class="prettyprint">/api/myAction/old</code> and <code class="prettyprint">/api/myAction/new</code>, mapping to apiVersion 1 and 2 respectively.</p>

<p>In your actions and middleware, if a route was matched, you can see the details of the match by inspecting <code class="prettyprint">data.connection.matchedRoute</code> which will include <code class="prettyprint">path</code> and <code class="prettyprint">action</code>.</p>

<p>Finally, you can toggle an option, <code class="prettyprint">matchTrailingPathParts</code>, which allows the final segment of your route to absorb all trailing path parts in a matched variable.</p>
<pre class="highlight javascript"><code><span class="nx">post</span><span class="err">:</span> <span class="p">[</span>
  <span class="c1">// yes match: site.com/api/123</span>
  <span class="c1">// no match: site.com/api/123/admin</span>
  <span class="p">{</span> <span class="na">path</span><span class="p">:</span> <span class="s1">'/login/:userId(.*)'</span><span class="p">,</span> <span class="na">action</span><span class="p">:</span> <span class="s1">'login'</span> <span class="p">}</span>
<span class="p">],</span>

<span class="nx">post</span><span class="err">:</span> <span class="p">[</span>
  <span class="c1">// yes match: site.com/api/123</span>
  <span class="c1">// yes match: site.com/api/123/admin</span>
  <span class="p">{</span> <span class="na">path</span><span class="p">:</span> <span class="s1">'/login/:userId(.*)'</span><span class="p">,</span> <span class="na">action</span><span class="p">:</span> <span class="s1">'login'</span><span class="p">,</span> <span class="na">matchTrailingPathParts</span><span class="p">:</span> <span class="kc">true</span> <span class="p">}</span>
<span class="p">],</span>
</code></pre>

<p>This also enables &ldquo;catch all&rdquo; routes, like:</p>
<pre class="highlight javascript"><code><span class="nx">get</span><span class="err">:</span> <span class="p">[</span>
  <span class="p">{</span> <span class="na">path</span><span class="p">:</span> <span class="s1">':path(.*)'</span><span class="p">,</span> <span class="na">action</span><span class="p">:</span> <span class="s1">'catchAll'</span><span class="p">,</span> <span class="na">matchTrailingPathParts</span><span class="p">:</span> <span class="kc">true</span> <span class="p">}</span>
<span class="p">],</span>
</code></pre>

<p>If you have a route with multiple variables defined and <code class="prettyprint">matchTrailingPathParts</code> is true, only the final segment will match the trailing sections:</p>
<pre class="highlight javascript"><code><span class="nx">get</span><span class="err">:</span> <span class="p">[</span>
  <span class="c1">// the route site.com/users/123/should/do/a/thing would become {userId: 123, path: '/should/do/a/thing'}</span>
  <span class="p">{</span> <span class="na">path</span><span class="p">:</span> <span class="s1">'/users/:userId/:path(.*)'</span><span class="p">,</span> <span class="na">action</span><span class="p">:</span> <span class="s1">'catchAll'</span><span class="p">,</span> <span class="na">matchTrailingPathParts</span><span class="p">:</span> <span class="kc">true</span> <span class="p">}</span>
<span class="p">],</span>
</code></pre>

<p><strong>Note</strong>: In regular expressions used for routing, you cannot use the &ldquo;/&rdquo; character.</p>

<h4 id="handling-static-folders-with-routes">Handling Static Folders with Routes</h4>

<p>If you want map a special public folder to a given route you can use the &ldquo;dir&rdquo; parameter in your &ldquo;get&rdquo; routes in the routes.js file:</p>
<pre class="highlight javascript"><code><span class="nx">get</span><span class="err">:</span> <span class="p">[</span>
  <span class="p">{</span> <span class="na">path</span><span class="p">:</span> <span class="s1">'/my/special/folder'</span><span class="p">,</span> <span class="na">dir</span><span class="p">:</span> <span class="nx">__dirname</span> <span class="o">+</span> <span class="s1">'/../public/my/special/folder'</span><span class="p">,</span> <span class="na">matchTrailingPathParts</span><span class="p">:</span> <span class="kc">true</span> <span class="p">}</span>
<span class="p">],</span>
</code></pre>

<p>After mapping this route all files/folders within the mapped folder will be accessible on the route.</p>

<p>You have to map the specified public folder within the &ldquo;dir&rdquo; parameter, relative to the routes.js file or absolute. Make sure to set &ldquo;matchTrailingPathParts&rdquo; to &ldquo;true&rdquo;, because when it is set to false, the route will never match when you request a file. (e.g.: site.com/my/special/folder/testfile.txt).</p>

<h4 id="notes">Notes</h4>

<ul>
<li>actions defined in params directly <code class="prettyprint">action=theAction</code> or hitting the named URL for an action <code class="prettyprint">/api/theAction</code> will never override RESTful routing</li>
<li>you can mix explicitly defined params with route-defined params.  If there is an overlap, the route-defined params win

<ul>
<li>IE: /api/user/123?userId=456 =&gt; <code class="prettyprint">connection.userId = 123</code></li>
</ul></li>
<li>routes defined with the &ldquo;all&rdquo; method will be duplicated to &ldquo;get&rdquo;, &ldquo;put&rdquo;, &ldquo;post&rdquo;, and &ldquo;delete&rdquo;</li>
<li>use &ldquo;:variable&rdquo; to define &ldquo;variable&rdquo;</li>
<li>an undefined &ldquo;:variable&rdquo; will not match

<ul>
<li>IE: &ldquo;/api/user/&rdquo; will not match &ldquo;/api/user/:userId&rdquo;</li>
<li>You would need a second route in this case to match &ldquo;/api/user&rdquo;</li>
</ul></li>
<li>routes are matched as defined top-down in <code class="prettyprint">routes.js</code></li>
<li>you can optionally define a regex match along with your route variable

<ul>
<li>IE: <code class="prettyprint">{ path:&quot;/game/:id(^[a-z]{0,10}$)&quot;, action: &quot;gamehandler&quot; }</code></li>
<li>be sure to double-escape when needed: <code class="prettyprint">{ path: &quot;/login/:userID(^\\d{3}$)&quot;, action: &quot;login&quot; }</code></li>
</ul></li>
<li>The HTTP verbs which you can route against are: <code class="prettyprint">api.routes.verbs = [&#39;head&#39;, &#39;get&#39;, &#39;post&#39;, &#39;put&#39;, &#39;patch&#39;, &#39;delete&#39;]</code></li>
</ul>
<pre class="highlight javascript"><code><span class="nx">exports</span><span class="p">.</span><span class="k">default</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">api</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="p">{</span>
    <span class="na">get</span><span class="p">:</span> <span class="p">[</span>
      <span class="p">{</span> <span class="na">path</span><span class="p">:</span> <span class="s2">"/users"</span><span class="p">,</span> <span class="na">action</span><span class="p">:</span> <span class="s2">"usersList"</span> <span class="p">},</span> <span class="c1">// (GET) /api/users</span>
      <span class="p">{</span> <span class="na">path</span><span class="p">:</span> <span class="s2">"/search/:term/limit/:limit/offset/:offset"</span><span class="p">,</span> <span class="na">action</span><span class="p">:</span> <span class="s2">"search"</span> <span class="p">},</span> <span class="c1">// (GET) /api/search/car/limit/10/offset/100</span>
    <span class="p">],</span>

    <span class="na">post</span><span class="p">:</span> <span class="p">[</span>
      <span class="p">{</span> <span class="na">path</span><span class="p">:</span> <span class="s2">"/login/:userID(^\\d{3}$)"</span><span class="p">,</span> <span class="na">action</span><span class="p">:</span> <span class="s2">"login"</span> <span class="p">}</span> <span class="c1">// (POST) /api/login/123</span>
    <span class="p">],</span>

    <span class="na">all</span><span class="p">:</span> <span class="p">[</span>
      <span class="p">{</span> <span class="na">path</span><span class="p">:</span> <span class="s2">"/user/:userID"</span><span class="p">,</span> <span class="na">action</span><span class="p">:</span> <span class="s2">"user"</span> <span class="p">}</span> <span class="c1">// (*) / /api/user/123</span>
    <span class="p">]</span>
  <span class="p">};</span>
<span class="p">}</span>
</code></pre>

<h2 id="params">Params</h2>

<p>Params provided by the user (GET, POST, etc for http and https servers, setParam for TCP clients, and passed to action calls from a web socket client) will be checked against a whitelist defined by your action (can be disabled in <code class="prettyprint">/config/servers/web.js</code>).  Variables defined in your actions by <code class="prettyprint">action.inputs</code> will be added to your whitelist.  Special params which the api will always accept are:</p>
<pre class="highlight javascript"><code>  <span class="p">[</span> <span class="s1">'file'</span><span class="p">,</span>
    <span class="s1">'apiVersion'</span><span class="p">,</span>
    <span class="s1">'callback'</span><span class="p">,</span>
    <span class="s1">'action'</span><span class="p">,</span> <span class="p">]</span>
</code></pre>

<p>Params are loaded in this order GET -&gt; POST (normal) -&gt; POST (multipart).  This means that if you have <code class="prettyprint">{url}?key=getValue</code> and you post a variable <code class="prettyprint">key=postValue</code> as well, the <code class="prettyprint">postValue</code> will be the one used.  The only exception to this is if you use the URL method of defining your action.  You can add arbitrary params to the whitelist by adding them to the <code class="prettyprint">api.postVariables</code> array in your initializers.</p>

<p>File uploads from forms will also appear in <code class="prettyprint">connection.params</code>, but will be an object with more information.  That is, if you uploaded a file called &ldquo;image&rdquo;, you would have <code class="prettyprint">connection.params.image.path</code>, <code class="prettyprint">connection.params.image.name</code> (original file name), and <code class="prettyprint">connection.params.image.type</code> available to you.</p>

<p>A note on JSON payloads:</p>

<p>You can post BODY json paylaods to actionHero in the form of a hash or array.</p>

<p>Hash: <code class="prettyprint">curl -X POST -d &#39;{&quot;key&quot;:&quot;something&quot;, &quot;value&quot;:{&quot;a&quot;:1, &quot;b&quot;:2}}&#39; http://localhost:8080/api/cacheTest</code>.  This will result in:</p>
<pre class="highlight javascript"><code><span class="nx">connection</span><span class="p">.</span><span class="nx">params</span> <span class="o">=</span> <span class="p">{</span>
  <span class="na">key</span><span class="p">:</span> <span class="s1">'something'</span>
  <span class="na">value</span><span class="p">:</span> <span class="p">{</span>
    <span class="na">a</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
    <span class="na">b</span><span class="p">:</span> <span class="mi">2</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre>

<p>Array: <code class="prettyprint">curl -X POST -d &#39;[{&quot;key&quot;:&quot;something&quot;, &quot;value&quot;:{&quot;a&quot;:1, &quot;b&quot;:2}}]&#39; http://localhost:8080/api/cacheTest</code>.
In this case, we set the array to the param key <code class="prettyprint">payload</code>:</p>
<pre class="highlight javascript"><code><span class="nx">connection</span><span class="p">.</span><span class="nx">params</span> <span class="o">=</span> <span class="p">{</span>
  <span class="na">payload</span><span class="p">:</span> <span class="p">[</span>
    <span class="p">{</span>
      <span class="na">key</span><span class="p">:</span> <span class="s1">'something'</span>
      <span class="na">value</span><span class="p">:</span> <span class="p">{</span>
        <span class="na">a</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
        <span class="na">b</span><span class="p">:</span> <span class="mi">2</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">]</span>
<span class="p">}</span>
</code></pre>

<h2 id="uploading-files">Uploading Files</h2>

<p>actionhero uses the <a href="https://github.com/felixge/node-formidable">formidable</a> form parsing library.  You can set options for it via <code class="prettyprint">api.config.commonWeb.formOptions</code>.  You can upload multiple files to an action and they will be available within <code class="prettyprint">connection.params</code> as formidable response objects containing references to the original file name, where the uploaded file was stored temporarily, etc.   Here&rsquo;s an example:</p>
<pre class="highlight javascript"><code><span class="c1">// actions/uploader.js</span>

<span class="nx">exports</span><span class="p">.</span><span class="nx">action</span> <span class="o">=</span> <span class="p">{</span>
  <span class="na">name</span><span class="p">:</span> <span class="s1">'uploader'</span><span class="p">,</span>
  <span class="na">description</span><span class="p">:</span> <span class="s1">'uploader'</span><span class="p">,</span>
  <span class="na">inputs</span><span class="p">:</span> <span class="p">{</span>
    <span class="na">file1</span><span class="p">:</span> <span class="p">{</span><span class="na">required</span><span class="p">:</span> <span class="kc">true</span><span class="p">},</span>
    <span class="na">file2</span><span class="p">:</span> <span class="p">{</span><span class="na">required</span><span class="p">:</span> <span class="kc">false</span><span class="p">},</span>
    <span class="na">key1</span><span class="p">:</span> <span class="p">{</span><span class="na">required</span><span class="p">:</span> <span class="kc">false</span><span class="p">},</span>
    <span class="na">key2</span><span class="p">:</span> <span class="p">{</span><span class="na">required</span><span class="p">:</span> <span class="kc">false</span><span class="p">},</span>
  <span class="p">},</span>
  <span class="na">outputExample</span><span class="p">:</span> <span class="kc">null</span><span class="p">,</span>
  <span class="na">run</span><span class="p">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">api</span><span class="p">,</span> <span class="nx">data</span><span class="p">,</span> <span class="nx">next</span><span class="p">){</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">"\r\n\r\n"</span><span class="p">)</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">data</span><span class="p">.</span><span class="nx">params</span><span class="p">);</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">"\r\n\r\n"</span><span class="p">)</span>
    <span class="nx">next</span><span class="p">();</span>
  <span class="p">}</span>
<span class="p">};</span>
</code></pre>
<pre class="highlight html"><code><span class="c">&lt;!-- public/uploader.html --&gt;</span>
<span class="nt">&lt;html&gt;</span>
    <span class="nt">&lt;head&gt;&lt;/head&gt;</span>
    <span class="nt">&lt;body&gt;</span>
        <span class="nt">&lt;form</span> <span class="na">method=</span><span class="s">"post"</span> <span class="na">enctype=</span><span class="s">"multipart/form-data"</span> <span class="na">action=</span><span class="s">"http://localhost:8080/api/uploader"</span><span class="nt">&gt;</span>
            <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">"file"</span> <span class="na">name=</span><span class="s">"file1"</span> <span class="nt">/&gt;</span>
            <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">"file"</span> <span class="na">name=</span><span class="s">"file2"</span> <span class="nt">/&gt;</span>
            <span class="nt">&lt;br&gt;&lt;br&gt;</span>
            <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">'text'</span> <span class="na">name=</span><span class="s">"key1"</span> <span class="nt">/&gt;</span>
            <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">'text'</span> <span class="na">name=</span><span class="s">"key2"</span> <span class="nt">/&gt;</span>
            <span class="nt">&lt;br&gt;&lt;br&gt;</span>
            <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">"submit"</span> <span class="na">value=</span><span class="s">"send"</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;/form&gt;</span>
    <span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span>
</code></pre>
<pre class="highlight javascript"><code><span class="c1">// what the params look like to an action</span>
<span class="p">{</span> <span class="nl">action</span><span class="p">:</span> <span class="s1">'uploader'</span><span class="p">,</span>
  <span class="nx">file1</span><span class="err">:</span>
   <span class="p">{</span> <span class="nl">domain</span><span class="p">:</span> <span class="kc">null</span><span class="p">,</span>
     <span class="nx">_events</span><span class="err">:</span> <span class="kc">null</span><span class="p">,</span>
     <span class="nx">_maxListeners</span><span class="err">:</span> <span class="mi">10</span><span class="p">,</span>
     <span class="nx">size</span><span class="err">:</span> <span class="mi">5477608</span><span class="p">,</span>
     <span class="nx">path</span><span class="err">:</span> <span class="s1">'/Users/evantahler/PROJECTS/actionhero/tmp/86b2aa018a9785e20b3f6cea95babcca'</span><span class="p">,</span>
     <span class="nx">name</span><span class="err">:</span> <span class="s1">'1-02 Concentration Enhancing Menu Initialiser.mp3'</span><span class="p">,</span>
     <span class="nx">type</span><span class="err">:</span> <span class="s1">'audio/mp3'</span><span class="p">,</span>
     <span class="nx">hash</span><span class="err">:</span> <span class="kc">false</span><span class="p">,</span>
     <span class="nx">lastModifiedDate</span><span class="err">:</span> <span class="nx">Wed</span> <span class="nx">Feb</span> <span class="mi">13</span> <span class="mi">2013</span> <span class="mi">20</span><span class="err">:</span><span class="mi">32</span><span class="err">:</span><span class="mi">49</span> <span class="nx">GMT</span><span class="o">-</span><span class="mi">0800</span> <span class="p">(</span><span class="nx">PST</span><span class="p">),</span>
     <span class="nx">_writeStream</span><span class="err">:</span>
      <span class="p">{</span> <span class="p">...</span> <span class="p">},</span>
     <span class="nx">length</span><span class="err">:</span> <span class="p">[</span><span class="nx">Getter</span><span class="p">],</span>
     <span class="nx">filename</span><span class="err">:</span> <span class="p">[</span><span class="nx">Getter</span><span class="p">],</span>
     <span class="nx">mime</span><span class="err">:</span> <span class="p">[</span><span class="nx">Getter</span><span class="p">]</span> <span class="p">},</span>
  <span class="nx">file2</span><span class="err">:</span>
   <span class="p">{</span> <span class="nl">domain</span><span class="p">:</span> <span class="kc">null</span><span class="p">,</span>
     <span class="nx">_events</span><span class="err">:</span> <span class="kc">null</span><span class="p">,</span>
     <span class="nx">_maxListeners</span><span class="err">:</span> <span class="mi">10</span><span class="p">,</span>
     <span class="nx">size</span><span class="err">:</span> <span class="mi">10439802</span><span class="p">,</span>
     <span class="nx">path</span><span class="err">:</span> <span class="s1">'/Users/evantahler/PROJECTS/actionhero/tmp/6052010f1d75ceaeb9197a9a759124dc'</span><span class="p">,</span>
     <span class="nx">name</span><span class="err">:</span> <span class="s1">'1-10 There She Is.mp3'</span><span class="p">,</span>
     <span class="nx">type</span><span class="err">:</span> <span class="s1">'audio/mp3'</span><span class="p">,</span>
     <span class="nx">hash</span><span class="err">:</span> <span class="kc">false</span><span class="p">,</span>
     <span class="nx">lastModifiedDate</span><span class="err">:</span> <span class="nx">Wed</span> <span class="nx">Feb</span> <span class="mi">13</span> <span class="mi">2013</span> <span class="mi">20</span><span class="err">:</span><span class="mi">32</span><span class="err">:</span><span class="mi">49</span> <span class="nx">GMT</span><span class="o">-</span><span class="mi">0800</span> <span class="p">(</span><span class="nx">PST</span><span class="p">),</span>
     <span class="nx">_writeStream</span><span class="err">:</span>
      <span class="p">{</span> <span class="p">...</span> <span class="p">},</span>
  <span class="nx">key1</span><span class="err">:</span> <span class="s1">'123'</span><span class="p">,</span>
  <span class="nx">key2</span><span class="err">:</span> <span class="s1">'456'</span><span class="p">,</span>
 <span class="p">}</span>
</code></pre>

<h2 id="client-library">Client Library</h2>

<p>Although the <code class="prettyprint">actionheroClient</code> client-side library is mostly for websockets, it can now be used to make http actions when not connected (and websocket clients will fall back to http actions when disconnected)</p>
<pre class="highlight html"><code><span class="nt">&lt;script </span><span class="na">src=</span><span class="s">"../public/javascript/actionheroClient.js"</span><span class="nt">&gt;&lt;/script&gt;</span>

<span class="nt">&lt;script&gt;</span>
<span class="kd">var</span> <span class="nx">client</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">ActionheroClient</span><span class="p">();</span>
<span class="nx">client</span><span class="p">.</span><span class="nx">action</span><span class="p">(</span><span class="s1">'cacheTest'</span><span class="p">,</span> <span class="p">{</span><span class="na">key</span><span class="p">:</span> <span class="s1">'k'</span><span class="p">,</span> <span class="na">value</span><span class="p">:</span> <span class="s1">'v'</span><span class="p">},</span> <span class="kd">function</span><span class="p">(</span><span class="nx">error</span><span class="p">,</span> <span class="nx">data</span><span class="p">){</span>
   <span class="c1">// do stuff</span>
<span class="p">});</span>
<span class="nt">&lt;/script&gt;</span>
</code></pre>

<p>Note that we never called <code class="prettyprint">client.connect</code>.  More information can be found on the <a href="/docs#websocket-server">websocket server docs page</a>.</p>

          <h1 id="websocket-server">WebSocket Server</h1>

<h2 id="general">General</h2>

<p>actionhero uses <a href="https://github.com/primus/primus">Primus</a> for web sockets.  The Primus project allows you to choose from many websocket backends, including <code class="prettyprint">ws</code>, <code class="prettyprint">engine.io</code>, <code class="prettyprint">socket.io</code>, and more. Within actionhero, web sockets are bound to the web server (either http or https).</p>

<p>ActionHero will generate the client-side javascript needed for you (based on the actionheroClient library, primus, and the underlying ws transport). This file is regenerated each time you boot the application.</p>

<p><strong>Warning</strong></p>

<p>In <code class="prettyprint">v9.0.0</code> and later, actionhero will no longer attempt to manage non-sticky client connections. This means if you have a multi-server actionhero deployment and you use long-polling in your websocket transport, you will need to ensure that your load balancer can enforce sticky connections, meaning every request from the client will hit the same actionhero node.</p>

<h2 id="connection-details">Connection Details</h2>
<pre class="highlight html"><code><span class="nt">&lt;script </span><span class="na">src=</span><span class="s">"../public/javascript/actionheroClient.js"</span><span class="nt">&gt;&lt;/script&gt;</span>

<span class="nt">&lt;script&gt;</span>

  <span class="nx">client</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">ActionheroClient</span><span class="p">;</span>

  <span class="nx">client</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">'connected'</span><span class="p">,</span>    <span class="kd">function</span><span class="p">(){</span> <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'connected!'</span><span class="p">)</span> <span class="p">})</span>
  <span class="nx">client</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">'disconnected'</span><span class="p">,</span> <span class="kd">function</span><span class="p">(){</span> <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'disconnected :('</span><span class="p">)</span> <span class="p">})</span>

  <span class="nx">client</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">'error'</span><span class="p">,</span>        <span class="kd">function</span><span class="p">(</span><span class="nx">error</span><span class="p">){</span> <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'error'</span><span class="p">,</span> <span class="nx">error</span><span class="p">.</span><span class="nx">stack</span><span class="p">)</span> <span class="p">})</span>
  <span class="nx">client</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">'reconnect'</span><span class="p">,</span>    <span class="kd">function</span><span class="p">(){</span> <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'reconnect'</span><span class="p">)</span> <span class="p">})</span>
  <span class="nx">client</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">'reconnecting'</span><span class="p">,</span> <span class="kd">function</span><span class="p">(){</span> <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'reconnecting'</span><span class="p">)</span> <span class="p">})</span>

  <span class="c1">// this will log all messages send the client</span>
  <span class="c1">// client.on('message',      function(message){ console.log(message) })</span>

  <span class="nx">client</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">'alert'</span><span class="p">,</span>        <span class="kd">function</span><span class="p">(</span><span class="nx">message</span><span class="p">){</span> <span class="nx">alert</span><span class="p">(</span><span class="nx">message</span><span class="p">)</span> <span class="p">})</span>
  <span class="nx">client</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">'api'</span><span class="p">,</span>          <span class="kd">function</span><span class="p">(</span><span class="nx">message</span><span class="p">){</span> <span class="nx">alert</span><span class="p">(</span><span class="nx">message</span><span class="p">)</span> <span class="p">})</span>

  <span class="nx">client</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">'welcome'</span><span class="p">,</span>      <span class="kd">function</span><span class="p">(</span><span class="nx">message</span><span class="p">){</span> <span class="nx">appendMessage</span><span class="p">(</span><span class="nx">message</span><span class="p">);</span> <span class="p">})</span>
  <span class="nx">client</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">'say'</span><span class="p">,</span>          <span class="kd">function</span><span class="p">(</span><span class="nx">message</span><span class="p">){</span> <span class="nx">appendMessage</span><span class="p">(</span><span class="nx">message</span><span class="p">);</span> <span class="p">})</span>

  <span class="nx">client</span><span class="p">.</span><span class="nx">connect</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">error</span><span class="p">,</span> <span class="nx">details</span><span class="p">){</span>
    <span class="k">if</span><span class="p">(</span><span class="nx">error</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">){</span>
      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">error</span><span class="p">);</span>
    <span class="p">}</span><span class="k">else</span><span class="p">{</span>
      <span class="nx">client</span><span class="p">.</span><span class="nx">roomAdd</span><span class="p">(</span><span class="s2">"defaultRoom"</span><span class="p">);</span>
      <span class="nx">client</span><span class="p">.</span><span class="nx">action</span><span class="p">(</span><span class="s1">'someAction'</span><span class="p">,</span> <span class="p">{</span><span class="na">key</span><span class="p">:</span> <span class="s1">'k'</span><span class="p">,</span> <span class="na">value</span><span class="p">:</span> <span class="s1">'v'</span><span class="p">},</span> <span class="kd">function</span><span class="p">(</span><span class="nx">error</span><span class="p">,</span> <span class="nx">data</span><span class="p">){</span>
        <span class="c1">// do stuff</span>
      <span class="p">});</span>
    <span class="p">}</span>
  <span class="p">});</span>

<span class="nt">&lt;/script&gt;</span>
</code></pre>

<p><code class="prettyprint">connection.type</code> for a webSocket client is &ldquo;webSocket&rdquo;.  This type will not change regardless of if the client has fallen back to another protocol.</p>

<p>Data is always returned as JSON objects to the webSocket client.  </p>

<p>An example web socket session might be the following:</p>

<p>You can also inspect <code class="prettyprint">client.state</code> (&lsquo;connected&rsquo;, &#39;disconnected&rsquo;, etc).  The websocket client will attempt to re-connect automatically.</p>

<p>If you want to communicate with a websocket client outside of an action, you can call <code class="prettyprint">connection.send(message)</code> on the server. In the client lib, the event message will be fired. So, <code class="prettyprint">client.on(&#39;message, function(m){ ... })</code>.  Be sure to add some descriptive content to the message you send from the sever (like perhaps <code class="prettyprint">{&quot;type&quot;: &#39;message type&#39;}</code>) so you can route message types on the client.</p>

<h2 id="methods">Methods</h2>

<p>Methods which the provided actionheroWebSocket object expose are:</p>

<h3 id="client-connect-callback">client.connect(callback)</h3>

<ul>
<li><code class="prettyprint">callback</code> will contain (error, details)</li>
<li>details here is the same as the <code class="prettyprint">detailsView</code> method</li>
</ul>

<h3 id="client-action-action-params-callback">client.action(action, params, callback)</h3>

<ul>
<li><code class="prettyprint">action</code> is a string, like &ldquo;login&rdquo;</li>
<li><code class="prettyprint">params</code> is an object</li>
<li><code class="prettyprint">callback</code> will be passed <code class="prettyprint">response</code> (and you can inspect <code class="prettyprint">response.error</code>)</li>
</ul>

<h3 id="client-say-room-message-callback">client.say(room, message, callback)</h3>

<ul>
<li><code class="prettyprint">message</code> is a string</li>
<li>may contain an <code class="prettyprint">error</code></li>
<li>note that you have to first join a room with <code class="prettyprint">roomAdd</code> to chat within it of recieve events</li>
</ul>

<h3 id="client-detailsview-callback">client.detailsView(callback)</h3>

<ul>
<li><code class="prettyprint">callback</code> will be passed <code class="prettyprint">error</code>, <code class="prettyprint">response</code></li>
<li>the first response from detailsView will also always be saved to <code class="prettyprint">client.details</code> for later inspection</li>
<li>may contain an <code class="prettyprint">error</code></li>
</ul>

<h3 id="client-roomview-room-callback">client.roomView(room, callback)</h3>

<ul>
<li>will return metadata about the room</li>
<li>may contain an <code class="prettyprint">error</code></li>
</ul>

<h3 id="client-roomadd-room-callback">client.roomAdd(room, callback)</h3>

<ul>
<li><code class="prettyprint">room</code> is a string</li>
<li>may contain an <code class="prettyprint">error</code></li>
</ul>

<h3 id="client-roomleave-room-callback">client.roomLeave(room, callback)</h3>

<ul>
<li><code class="prettyprint">room</code> is a string</li>
<li>may contain an <code class="prettyprint">error</code></li>
</ul>

<h3 id="client-file-callback">client.file(callback)</h3>

<ul>
<li>see below for details</li>
</ul>

<h3 id="client-disconnect">client.disconnect()</h3>

<ul>
<li>instantly sever the connection to the server</li>
</ul>

<p>The contents of the <code class="prettyprint">file</code> callback look like:
<code class="prettyprint">javascript
{
  content: &quot;&lt;h1&gt;ActionHero&lt;/h1&gt;\nI am a flat file being served to you via the API from ./public/simple.html&lt;br /&gt;&quot;,
  context: &quot;response&quot;,
  error: null,
  length: 101,
  messageCount: 3,
  mime: &quot;text/html&quot;
}
</code></p>

<h2 id="events">Events</h2>

<h3 id="client-on-39-connected-39-function-console-log-39-connected-39">client.on(&#39;connected&rsquo;,    function(){ console.log(&#39;connected!&rsquo;) })</h3>

<ul>
<li>no event data</li>
</ul>

<h3 id="client-on-39-disconnected-39-function-console-log-39-disconnected-39">client.on(&#39;disconnected&rsquo;, function(){ console.log(&#39;disconnected :(&rsquo;) })</h3>

<ul>
<li>no event data</li>
</ul>

<h3 id="client-on-39-error-39-function-error-console-log-39-error-39-error-stack">client.on(&#39;error&rsquo;,        function(error){ console.log(&#39;error&rsquo;, error.stack) })</h3>

<ul>
<li>this is fired when a general error is encountered (outside of an action or verb)</li>
<li>this may fire when a general server error occurs</li>
</ul>

<h3 id="client-on-39-reconnect-39-function-console-log-39-reconnect-39">client.on(&#39;reconnect&rsquo;,    function(){ console.log(&#39;reconnect&rsquo;) })</h3>

<ul>
<li>fired when client has reconnected</li>
<li>this will indicate that details, connection.id and other server-generated settings may have changed</li>
</ul>

<h3 id="client-on-39-reconnecting-39-function-console-log-39-reconnecting-39">client.on(&#39;reconnecting&rsquo;, function(){ console.log(&#39;reconnecting&rsquo;) })</h3>

<ul>
<li>client is attempting to reconnect to server</li>
</ul>

<h3 id="client-on-39-message-39-function-message-console-log-message">client.on(&#39;message&rsquo;,      function(message){ console.log(message) })</h3>

<ul>
<li>this is VERY noisy, and is fired on all messages from the server, regardless of context or callback</li>
</ul>

<h3 id="client-on-39-alert-39-function-message-alert-message">client.on(&#39;alert&rsquo;,        function(message){ alert(message) })</h3>

<ul>
<li>fired when message recieved from the server&rsquo;s context is specifically &#39;alert&rsquo;</li>
</ul>

<h3 id="client-on-39-api-39-function-message-alert-message">client.on(&#39;api&rsquo;,          function(message){ alert(message) })</h3>

<ul>
<li>fired when message recieved from the server&rsquo;s context is unknown</li>
</ul>

<h3 id="client-on-39-welcome-39-function-message-appendmessage-message">client.on(&#39;welcome&rsquo;,      function(message){ appendMessage(message); })</h3>

<ul>
<li>server&rsquo;s welcome message</li>
</ul>

<h3 id="client-on-39-say-39-function-message-appendmessage-message">client.on(&#39;say&rsquo;,          function(message){ appendMessage(message); })</h3>

<ul>
<li>fired on all say messages from other clients in all rooms</li>
<li>message.room can be inspected</li>
</ul>

<h2 id="linking-websockets-to-web-auth">Linking websockets to web auth</h2>

<p>actionhero provides <code class="prettyprint">connection.fingerprint</code> where available to help you link websocket connections to related web connections. While every connection will always have a unique <code class="prettyprint">connection.id</code>, we attempt to build <code class="prettyprint">connection.fingerprint</code> by checking the headers the websocket connection began with.  If the cookie defined by <code class="prettyprint">api.config.servers.web.fingerprint.cookieKey</code> is present, we will store its value on the websocket connection.  </p>

<p>You can read more about using a value like <code class="prettyprint">connection.fingerprint</code> in an <a href="/docs#middleware">authentication middleware</a> or using it as a key for <a href="/docs/#example-initializers">session information</a>.</p>

<h2 id="options">Options</h2>
<pre class="highlight javascript"><code><span class="nx">enabled</span><span class="err">:</span>          <span class="kc">true</span><span class="p">,</span>
<span class="c1">// you can pass a FQDN here, or function to be called / window object to be inspected</span>
<span class="nx">clientUrl</span><span class="err">:</span>        <span class="s1">'window.location.origin'</span><span class="p">,</span>
<span class="c1">// Directory to render client-side JS.  </span>
<span class="c1">// Path should start with "/" and will be built starting from api.config..general.paths.public</span>
<span class="nx">clientJsPath</span><span class="err">:</span>     <span class="s1">'javascript/'</span><span class="p">,</span>
<span class="c1">// the name of the client-side JS file to render.  Both `.js` and `.min.js` versions will be created</span>
<span class="c1">// do not include the file exension</span>
<span class="c1">// set to `null` to not render the client-side JS on boot</span>
<span class="nx">clientJsName</span><span class="err">:</span>     <span class="s1">'actionheroClient'</span><span class="p">,</span>
<span class="c1">// should the server signal clients to not reconnect when the server is shutdown/reboot</span>
<span class="nx">destroyClientsOnShutdown</span><span class="err">:</span> <span class="kc">false</span><span class="p">,</span>

<span class="c1">// Primus Server Options:</span>
<span class="nx">server</span><span class="err">:</span> <span class="p">{</span>
  <span class="c1">// authorization: null,</span>
  <span class="c1">// pathname:      '/primus',</span>
  <span class="c1">// parser:        'JSON',</span>
  <span class="c1">// transformer:   'ws',</span>
  <span class="c1">// plugin:        {},</span>
  <span class="c1">// timeout:       35000,</span>
  <span class="c1">// origins:       '*',</span>
  <span class="c1">// methods:       ['GET','HEAD','PUT','POST','DELETE','OPTIONS'],</span>
  <span class="c1">// credentials:   true,</span>
  <span class="c1">// maxAge:        '30 days',</span>
  <span class="c1">// headers:       false,</span>
  <span class="c1">// exposed:       false,</span>
<span class="p">},</span>

<span class="c1">// Priumus Client Options:</span>
<span class="nx">client</span><span class="err">:</span> <span class="p">{</span>
  <span class="c1">// reconnect:        {},</span>
  <span class="c1">// timeout:          10000,</span>
  <span class="c1">// ping:             25000,</span>
  <span class="c1">// pong:             10000,</span>
  <span class="c1">// strategy:         "online",</span>
  <span class="c1">// manual:           false,</span>
  <span class="c1">// websockets:       true,</span>
  <span class="c1">// network:          true,</span>
  <span class="c1">// transport:        {},</span>
  <span class="c1">// queueSize:        Infinity,</span>
<span class="p">},</span>
</code></pre>

<p>You can create your client with options.  Options for both the server and client are stored in <code class="prettyprint">/config/servers/websocket.js</code>.  Note there are 3 sections: &#39;server&rsquo;, &#39;client&rsquo;, and &#39;generation&rsquo;:</p>

          <h1 id="socket-server">Socket Server</h1>

<h2 id="general">General</h2>
<pre class="highlight shell"><code><span class="gp">&gt; </span>telnet localhost 5000
Trying 127.0.0.1...
Connected to localhost.
Escape character is <span class="s1">'^]'</span>.
<span class="o">{</span><span class="s2">"welcome"</span>:<span class="s2">"Hello! Welcome to the actionhero api"</span>,<span class="s2">"room"</span>:<span class="s2">"defaultRoom"</span>,<span class="s2">"context"</span>:<span class="s2">"api"</span><span class="o">}</span>
<span class="gp">$ </span>detailsView
<span class="o">{</span><span class="s2">"status"</span>:<span class="s2">"OK"</span>,<span class="s2">"context"</span>:<span class="s2">"response"</span>,<span class="s2">"data"</span>:<span class="o">{</span><span class="s2">"id"</span>:<span class="s2">"2d68c389-521d-4dc6-b4f1-8292cd6cbde6"</span>,<span class="s2">"remoteIP"</span>:<span class="s2">"127.0.0.1"</span>,<span class="s2">"remotePort"</span>:57393,<span class="s2">"params"</span>:<span class="o">{}</span>,<span class="s2">"connectedAt"</span>:1368918901456,<span class="s2">"room"</span>:<span class="s2">"defaultRoom"</span>,<span class="s2">"totalActions"</span>:0,<span class="s2">"pendingActions"</span>:0<span class="o">}</span>,<span class="s2">"messageCount"</span>:1<span class="o">}</span>
randomNumber
<span class="o">{</span><span class="s2">"randomNumber"</span>:0.4977603426668793,<span class="s2">"context"</span>:<span class="s2">"response"</span>,<span class="s2">"messageCount"</span>:2<span class="o">}</span>
<span class="gp">$ </span>cacheTest
<span class="o">{</span><span class="s2">"error"</span>:<span class="s2">"Error: key is a required parameter for this action"</span>,<span class="s2">"context"</span>:<span class="s2">"response"</span>,<span class="s2">"messageCount"</span>:3<span class="o">}</span>
<span class="gp">$ </span>paramAdd <span class="nv">key</span><span class="o">=</span>myKey
<span class="o">{</span><span class="s2">"status"</span>:<span class="s2">"OK"</span>,<span class="s2">"context"</span>:<span class="s2">"response"</span>,<span class="s2">"data"</span>:null,<span class="s2">"messageCount"</span>:4<span class="o">}</span>
<span class="gp">$ </span>paramAdd <span class="nv">value</span><span class="o">=</span>myValue
<span class="o">{</span><span class="s2">"status"</span>:<span class="s2">"OK"</span>,<span class="s2">"context"</span>:<span class="s2">"response"</span>,<span class="s2">"data"</span>:null,<span class="s2">"messageCount"</span>:5<span class="o">}</span>
<span class="gp">$ </span>paramsView
<span class="o">{</span><span class="s2">"status"</span>:<span class="s2">"OK"</span>,<span class="s2">"context"</span>:<span class="s2">"response"</span>,<span class="s2">"data"</span>:<span class="o">{</span><span class="s2">"action"</span>:<span class="s2">"cacheTest"</span>,<span class="s2">"key"</span>:<span class="s2">"myKey"</span>,<span class="s2">"value"</span>:<span class="s2">"myValue"</span><span class="o">}</span>,<span class="s2">"messageCount"</span>:6<span class="o">}</span>
<span class="gp">$ </span>cacheTest
<span class="o">{</span><span class="s2">"cacheTestResults"</span>:<span class="o">{</span><span class="s2">"saveResp"</span>:true,<span class="s2">"sizeResp"</span>:1,<span class="s2">"loadResp"</span>:<span class="o">{</span><span class="s2">"key"</span>:<span class="s2">"cacheTest_myKey"</span>,<span class="s2">"value"</span>:<span class="s2">"myValue"</span>,<span class="s2">"expireTimestamp"</span>:1368918936984,<span class="s2">"createdAt"</span>:1368918931984,<span class="s2">"readAt"</span>:1368918931995<span class="o">}</span>,<span class="s2">"deleteResp"</span>:true<span class="o">}</span>,<span class="s2">"context"</span>:<span class="s2">"response"</span>,<span class="s2">"messageCount"</span>:7<span class="o">}</span>
<span class="gp">$ </span>roomAdd default Room
<span class="o">{</span><span class="s2">"status"</span>:<span class="s2">"OK"</span><span class="o">}</span>
<span class="gp">$ </span>say defaultRoom hooray!
<span class="o">{</span><span class="s2">"status"</span>:<span class="s2">"OK"</span>,<span class="s2">"context"</span>:<span class="s2">"response"</span>,<span class="s2">"data"</span>:null,<span class="s2">"messageCount"</span>:8<span class="o">}</span>
</code></pre>

<p>You can access actionhero&rsquo;s methods via a persistent socket connection.  The default port for this type of communication is 5000.  As this is a persistent connection, socket connections have actionhero&rsquo;s verbs available to them.  These verbs are:</p>

<ul>
<li><code class="prettyprint">quit</code> disconnect from the session</li>
<li><code class="prettyprint">paramAdd</code> - save a singe variable to your connection.  IE: &lsquo;addParam screenName=evan&rsquo;</li>
<li><code class="prettyprint">paramView</code> - returns the details of a single param. IE: &#39;viewParam screenName&rsquo;</li>
<li><code class="prettyprint">paramDelete</code> - deletes a single param.  IE: &#39;deleteParam screenName&rsquo;</li>
<li><code class="prettyprint">paramsView</code> - returns a JSON object of all the params set to this connection</li>
<li><code class="prettyprint">paramsDelete</code> - deletes all params set to this session</li>
<li><code class="prettyprint">roomAdd</code> - connect to a room.</li>
<li><code class="prettyprint">roomLeave</code> - (room) leave the <code class="prettyprint">room</code> you are connected to.</li>
<li><code class="prettyprint">roomView</code> - (room) show you the room you are connected to, and information about the members currently in that room.</li>
<li><code class="prettyprint">detailsView</code> - show you details about your connection, including your public ID.</li>
<li><code class="prettyprint">say</code> (room,) message</li>
</ul>

<p>Please note that any verbs set using the above method will be &#39;sticky&rsquo; to the connection and sent for all subsequent requests.  Be sure to delete or update your params before your next request.</p>

<p>To help sort out the potential stream of messages a socket user may receive, it is best to understand the &ldquo;context&rdquo; of the response.  For example, by default all actions set a context of &ldquo;response&rdquo; indicating that the message being sent to the client is response to a request they sent (either an action or a chat action like <code class="prettyprint">say</code>).  Messages sent by a user via the &#39;say&rsquo; command have the context of <code class="prettyprint">user</code> indicating they came form a user.  Messages resulting from data sent to the api (like an action) will have the <code class="prettyprint">response</code> context.</p>

<p><code class="prettyprint">connection.type</code> for a TCP/Socket client is &ldquo;socket&rdquo;</p>

<h2 id="tls">TLS</h2>
<pre class="highlight javascript"><code><span class="c1">// TLS Config Options</span>

<span class="nx">config</span><span class="p">.</span><span class="nx">severs</span><span class="p">.</span><span class="nx">socket</span> <span class="o">=</span> <span class="p">{</span>
  <span class="na">secure</span><span class="p">:</span> <span class="kc">false</span><span class="p">,</span>                        <span class="c1">// TCP or TLS?</span>
  <span class="na">serverOptions</span><span class="p">:</span> <span class="p">{},</span>                    <span class="c1">// passed to tls.createServer if secure=ture. Should contain SSL certificates</span>
  <span class="na">port</span><span class="p">:</span> <span class="mi">5000</span><span class="p">,</span>                           <span class="c1">// Port or Socket</span>
  <span class="na">bindIP</span><span class="p">:</span> <span class="s2">"0.0.0.0"</span><span class="p">,</span>                    <span class="c1">// which IP to listen on (use 0.0.0.0 for all)</span>
<span class="p">};</span>
</code></pre>
<pre class="highlight javascript"><code><span class="nx">config</span><span class="p">.</span><span class="nx">server</span><span class="p">.</span><span class="nx">socket</span><span class="p">.</span><span class="nx">serverOptions</span><span class="err">:</span> <span class="p">{</span>
  <span class="nl">key</span><span class="p">:</span> <span class="nx">fs</span><span class="p">.</span><span class="nx">readFileSync</span><span class="p">(</span><span class="s1">'certs/server-key.pem'</span><span class="p">),</span>
  <span class="nx">cert</span><span class="err">:</span> <span class="nx">fs</span><span class="p">.</span><span class="nx">readFileSync</span><span class="p">(</span><span class="s1">'certs/server-cert.pem'</span><span class="p">)</span>
<span class="p">}</span>
</code></pre>

<p>You can switch your TCP server to use TLS encryption if you desire.  Just toggle the settings in <code class="prettyprint">/config/servers/socket.js</code> and provide valid certificates.  You can test this with the openSSL client rather than telnet <code class="prettyprint">openssl s_client -connect 127.0.0.1:5000</code></p>

<p>Note that if you wish to create a secure (tls) server, you will be required to complete the serverOptions hash with at least a cert and a keyfile:</p>

<p>You can connect like: <code class="prettyprint">openssl s_client -connect 127.0.0.1:5000</code></p>

<p>or from node:</p>
<pre class="highlight javascript"><code><span class="c1">// Connecting over TLS from another node process</span>

<span class="kd">var</span> <span class="nx">tls</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'tls'</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">fs</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'fs'</span><span class="p">);</span>

<span class="kd">var</span> <span class="nx">options</span> <span class="o">=</span> <span class="p">{</span>
  <span class="na">key</span><span class="p">:</span> <span class="nx">fs</span><span class="p">.</span><span class="nx">readFileSync</span><span class="p">(</span><span class="s1">'certs/server-key.pem'</span><span class="p">),</span>
  <span class="na">cert</span><span class="p">:</span> <span class="nx">fs</span><span class="p">.</span><span class="nx">readFileSync</span><span class="p">(</span><span class="s1">'certs/server-cert.pem'</span><span class="p">)</span>
<span class="p">};</span>

<span class="kd">var</span> <span class="nx">cleartextStream</span> <span class="o">=</span> <span class="nx">tls</span><span class="p">.</span><span class="nx">connect</span><span class="p">(</span><span class="mi">5000</span><span class="p">,</span> <span class="nx">options</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'client connected'</span><span class="p">,</span> <span class="nx">cleartextStream</span><span class="p">.</span><span class="nx">authorized</span> <span class="p">?</span> <span class="s1">'authorized'</span> <span class="p">:</span> <span class="s1">'unauthorized'</span><span class="p">);</span>
  <span class="nx">process</span><span class="p">.</span><span class="nx">stdin</span><span class="p">.</span><span class="nx">pipe</span><span class="p">(</span><span class="nx">cleartextStream</span><span class="p">);</span>
  <span class="nx">process</span><span class="p">.</span><span class="nx">stdin</span><span class="p">.</span><span class="nx">resume</span><span class="p">();</span>
<span class="p">});</span>
<span class="nx">cleartextStream</span><span class="p">.</span><span class="nx">setEncoding</span><span class="p">(</span><span class="s1">'utf8'</span><span class="p">);</span>
<span class="nx">cleartextStream</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">'data'</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">data</span><span class="p">);</span>
<span class="p">});</span>
</code></pre>

<h2 id="files-and-routes">Files and Routes</h2>

<p>Connections over socket can also use the file action.  There is no &#39;route&rsquo; for files.</p>

<ul>
<li>errors are returned in the normal way <code class="prettyprint">{error: someError}</code> when they exist.</li>
<li>a successful file transfer will return the raw file data in a single send().  There will be no headers set, not will the content be JSON.</li>
</ul>

<h2 id="json-params">JSON Params</h2>

<p>The default method of using actions for TCP clients is to use the methods above to set params to their session and then call actions inline.  However, you can also communication via JSON, passing along params specific to each request.</p>

<ul>
<li><code class="prettyprint">{&quot;action&quot;: &quot;myAction&quot;, &quot;params&quot;: {&quot;key&quot;: &quot;value&quot;}}</code> is also a valid request over TCP</li>
</ul>

<h2 id="client-suggestions">Client Suggestions</h2>
<pre class="highlight javascript"><code><span class="kd">var</span> <span class="nx">actionheroClient</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s2">"actionhero-client"</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">client</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">actionheroClient</span><span class="p">();</span>

<span class="nx">client</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s2">"say"</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">msgBlock</span><span class="p">){</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">" &gt; SAY: "</span> <span class="o">+</span> <span class="nx">msgBlock</span><span class="p">.</span><span class="nx">message</span> <span class="o">+</span> <span class="s2">" | from: "</span> <span class="o">+</span> <span class="nx">msgBlock</span><span class="p">.</span><span class="nx">from</span><span class="p">);</span>
<span class="p">});</span>

<span class="nx">client</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s2">"welcome"</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">msg</span><span class="p">){</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">"WELCOME: "</span> <span class="o">+</span> <span class="nx">msg</span><span class="p">);</span>
<span class="p">});</span>

<span class="nx">client</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s2">"error"</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">error</span><span class="p">,</span> <span class="nx">data</span><span class="p">){</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">"ERROR: "</span> <span class="o">+</span> <span class="nx">error</span><span class="p">);</span>
  <span class="k">if</span><span class="p">(</span><span class="nx">data</span><span class="p">){</span> <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">data</span><span class="p">);</span> <span class="p">}</span>
<span class="p">});</span>

<span class="nx">client</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s2">"end"</span><span class="p">,</span> <span class="kd">function</span><span class="p">(){</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">"Connection Ended"</span><span class="p">);</span>
<span class="p">});</span>

<span class="nx">client</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s2">"timeout"</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">error</span><span class="p">,</span> <span class="nx">request</span><span class="p">,</span> <span class="nx">caller</span><span class="p">){</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">request</span> <span class="o">+</span> <span class="s2">" timed out"</span><span class="p">);</span>
<span class="p">});</span>

<span class="nx">client</span><span class="p">.</span><span class="nx">connect</span><span class="p">({</span>
  <span class="na">host</span><span class="p">:</span> <span class="s2">"127.0.0.1"</span><span class="p">,</span>
  <span class="na">port</span><span class="p">:</span> <span class="s2">"5000"</span><span class="p">,</span>
<span class="p">},</span> <span class="kd">function</span><span class="p">(){</span>
  <span class="c1">// get details about myself</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">client</span><span class="p">.</span><span class="nx">details</span><span class="p">);</span>

  <span class="c1">// try an action</span>
  <span class="kd">var</span> <span class="nx">params</span> <span class="o">=</span> <span class="p">{</span> <span class="na">key</span><span class="p">:</span> <span class="s2">"mykey"</span><span class="p">,</span> <span class="na">value</span><span class="p">:</span> <span class="s2">"myValue"</span> <span class="p">};</span>
  <span class="nx">client</span><span class="p">.</span><span class="nx">actionWithParams</span><span class="p">(</span><span class="s2">"cacheTest"</span><span class="p">,</span> <span class="nx">params</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">error</span><span class="p">,</span> <span class="nx">apiResponse</span><span class="p">,</span> <span class="nx">delta</span><span class="p">){</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">"cacheTest action response: "</span> <span class="o">+</span> <span class="nx">apiResponse</span><span class="p">.</span><span class="nx">cacheTestResults</span><span class="p">.</span><span class="nx">saveResp</span><span class="p">);</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">" ~ request duration: "</span> <span class="o">+</span> <span class="nx">delta</span> <span class="o">+</span> <span class="s2">"ms"</span><span class="p">);</span>
  <span class="p">});</span>

  <span class="c1">// join a chat room and talk</span>
  <span class="nx">client</span><span class="p">.</span><span class="nx">roomAdd</span><span class="p">(</span><span class="s2">"defaultRoom"</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">error</span><span class="p">){</span>
    <span class="nx">client</span><span class="p">.</span><span class="nx">say</span><span class="p">(</span><span class="s2">"defaultRoom"</span><span class="p">,</span> <span class="s2">"Hello from the actionheroClient"</span><span class="p">);</span>
    <span class="nx">client</span><span class="p">.</span><span class="nx">roomLeave</span><span class="p">(</span><span class="s2">"defaultRoom"</span><span class="p">);</span>
  <span class="p">});</span>

  <span class="c1">// leave</span>
  <span class="nx">setTimeout</span><span class="p">(</span><span class="kd">function</span><span class="p">(){</span>
    <span class="nx">client</span><span class="p">.</span><span class="nx">disconnect</span><span class="p">(</span><span class="kd">function</span><span class="p">(){</span>
      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">"all done!"</span><span class="p">);</span>
    <span class="p">});</span>
  <span class="p">},</span> <span class="mi">1000</span><span class="p">);</span>

<span class="p">});</span>
</code></pre>

<p>The main <code class="prettyprint">trick</code> to working with TCP/wire connections directly is to remember that you can have many &#39;pending&rsquo; requests at the same time.  Also, the order in which you receive responses back can be variable.  if you request <code class="prettyprint">slowAction</code> and then <code class="prettyprint">fastAction</code>, it&rsquo;s fairly likely that you will get a response to <code class="prettyprint">fastAction</code> first.</p>

<p>Note that only requests the client makes increment the <code class="prettyprint">messageCount</code>, but broadcasts do not (the <code class="prettyprint">say</code> command, etc)</p>

<p><a href="https://github.com/evantahler/actionhero-client">The actionhero client library</a> uses TCP/TLS connections, and makes use of actionhero&rsquo;s <code class="prettyprint">messageCount</code> parameter to keep track of requests, and keeps response callbacks for actions in a pending queue. For example:</p>

          <h1 id="production-notes">Production Notes</h1>

<h2 id="topology-example">Topology Example</h2>
<pre class="highlight javascript"><code>
<span class="c1">// Assume we use the flag `process.env.ACTIONHERO_ROLE` to denote the type of server</span>
<span class="c1">// You can set this variable in the ENV of your server or launch each process with the flag:</span>
<span class="c1">// Worker =&gt; `ACTIONHERO_ROLE='worker' npm start`</span>
<span class="c1">// Server =&gt; `ACTIONHERO_ROLE='server' npm start`</span>

<span class="c1">// config/tasks.js</span>

<span class="nx">exports</span><span class="p">.</span><span class="nx">production</span> <span class="o">=</span> <span class="p">{</span>
    <span class="na">tasks</span><span class="p">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">api</span><span class="p">){</span>

        <span class="c1">// default to config for 'server'</span>
        <span class="kd">var</span> <span class="nx">config</span> <span class="o">=</span> <span class="p">{</span>
          <span class="na">scheduler</span><span class="p">:</span> <span class="kc">false</span><span class="p">,</span>
          <span class="na">queues</span><span class="p">:</span> <span class="p">[</span><span class="s1">'*'</span><span class="p">],</span>
          <span class="na">verbose</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
          <span class="c1">// ...</span>
        <span class="p">};</span>

        <span class="k">if</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">ACTIONHERO_ROLE</span> <span class="o">===</span> <span class="s1">'worker'</span><span class="p">){</span>
            <span class="nx">config</span><span class="p">.</span><span class="nx">scheduler</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
            <span class="nx">config</span><span class="p">.</span><span class="nx">minTaskProcessors</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
            <span class="nx">config</span><span class="p">.</span><span class="nx">maxTaskProcessors</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="nx">config</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">};</span>

<span class="c1">// config/servers/web.js</span>

<span class="nx">exports</span><span class="p">.</span><span class="k">default</span> <span class="o">=</span> <span class="p">{</span>
    <span class="na">servers</span><span class="p">:</span> <span class="p">{</span>
        <span class="na">web</span><span class="p">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">api</span><span class="p">){</span>
            <span class="nx">config</span> <span class="o">=</span> <span class="p">{</span>
                <span class="na">enabled</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
                <span class="na">secure</span><span class="p">:</span> <span class="kc">false</span><span class="p">,</span>
                <span class="na">serverOptions</span><span class="p">:</span> <span class="p">{},</span>
                <span class="na">port</span><span class="p">:</span> <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">PORT</span> <span class="o">||</span> <span class="mi">8080</span>
                <span class="c1">// ...</span>
            <span class="p">};</span>

            <span class="k">if</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">ACTIONHERO_ROLE</span> <span class="o">===</span> <span class="s1">'worker'</span><span class="p">){</span>
                <span class="nx">config</span><span class="p">.</span><span class="nx">enabled</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
            <span class="p">}</span>

            <span class="k">return</span> <span class="nx">config</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">};</span>

</code></pre>

<p>Here is a common ActionHero production topology:</p>

<p><img alt="cluster" src="../images/cluster.png" /></p>

<p>Notes:</p>

<ul>
<li>It&rsquo;s best to seperate the &ldquo;workers&rdquo; from the web &ldquo;servers&rdquo;

<ul>
<li>be sure to modify the config files for each type of server acordingly (ie: turn of all servers for the workers, and turn of all workers on the servers)</li>
</ul></li>
<li>To acomplish the above, you only need to make changes to your configuration files on each server.  You will still be running the same same ActionHero project codebase.  See the example:</li>
<li>Always have a replica of redis!</li>
</ul>

<h2 id="paths-and-environments">Paths and Environments</h2>

<p>You can set a few environment variables to affect how ActionHero runs:</p>

<ul>
<li><code class="prettyprint">PROJECT_ROOT</code>: This is useful when deploying ActionHero applications on a server where symlinks will change under a running process.  The cluster will look at your symlink <code class="prettyprint">PROJECT_ROOT=/path/to/current_symlink</code> rather than the absolute path it was started from</li>
<li><code class="prettyprint">ACTIONHERO_ROOT</code>: This can used to set the absolute path to the ActionHero binaries</li>
<li><code class="prettyprint">ACTIONHERO_CONFIG</code>: This can be user to set the absolute path to the ActionHero config directory you wish to use.  This is useful when you might have a variable configs per server</li>
<li><code class="prettyprint">ACTIONHERO_TITLE</code>: The value of <code class="prettyprint">api.id</code>, and the name for the pidfile in some boot configurations</li>
</ul>

<h2 id="daemon">Daemon</h2>

<p>When deploying ActionHero, you will probably have more than 1 process.  You can use the cluster manager to keep an eye on the workers and manage them</p>

<ul>
<li>Start the cluster with 2 workers: <code class="prettyprint">./node_modules/.bin/actionhero start cluster --workers=2</code></li>
</ul>

<p>When deploying new code, you can gracefully restart your workers by sending the <code class="prettyprint">USR2</code> signal to the cluster manager to signal a reload to all workers.  You don&rsquo;t need to start and stop the cluster-master.  This allows for 0-downtime deployments.  </p>

<p>You may want to set some of the ENV variables above to help with your deployment.</p>

<h2 id="number-of-workers">Number of workers</h2>

<p>When choosing the number of workers (<code class="prettyprint">--workers=n</code>) for your ActionHero cluster, choose at least 1 less than the number of CPUs available.  If you have a &ldquo;burstable&rdquo; architecture (like a Joyent smart machine), opt for the highest number of &lsquo;consistent&rsquo; CPUs you can have, meaning a number of CPUs that you will always have available to you.  </p>

<p>You never want more workers than you can run at a time, or else you will actually be slowing down the execution of all processes.</p>

<p>Of course, not going in to swap memory is more important than utilizing all of your CPUs, so if you find yourself running out of ram, reduce the number of workers!</p>

<h2 id="pidfiles">Pidfiles</h2>

<p>ActionHero will write its pid to a pidfile in the normal unix way.  The path for the pidfile is set in <code class="prettyprint">config/api.js</code> with <code class="prettyprint">config.general.paths.pid</code>.  </p>

<p>Individual ActionHero servers will name their pidfiles by <code class="prettyprint">api.id</code>, which is determined by the logic <a href="https://github.com/evantahler/actionhero/blob/master/initializers/pids.js">here</a> and <a href="https://github.com/evantahler/actionhero/blob/master/initializers/id.js">here</a>.  For example, on my laptop with the IP address of <code class="prettyprint">192.168.0.1</code>, running <code class="prettyprint">npm start</code> would run one ActionHero server and generate a pidfile of <code class="prettyprint">./pids/actionhero-192.168.0.1</code> in which would be a single line containg the process&rsquo; pid.</p>

<p>When running the cluster, the cluster process first writes his own pidfile to <code class="prettyprint">process.cwd() + &#39;./pids/cluster_pidfile&#39;</code>.  Then, every worker the cluster master creates will have a pid like <code class="prettyprint">actionhero-worker-1</code> in the location defined by <code class="prettyprint">config/api.js</code>.</p>

<h2 id="git-based-deployment">Git-based Deployment</h2>
<pre class="highlight shell"><code><span class="c">#!/usr/bin/env bash</span>
<span class="c"># assuming the ActionHero cluster master process is already running</span>

<span class="nv">DEPLOY_PATH</span><span class="o">=</span>/path/to/your/application

<span class="nb">cd</span> <span class="nv">$DEPLOY_PATH</span> <span class="o">&amp;&amp;</span> git pull
<span class="nb">cd</span> <span class="nv">$DEPLOY_PATH</span> <span class="o">&amp;&amp;</span> npm install
<span class="c"># run any build tasks here, like perhaps an asset compile step or a database migration</span>
<span class="nb">cd</span> <span class="nv">$DEPLOY_PATH</span> <span class="o">&amp;&amp;</span> <span class="nb">kill</span> -s USR2 <span class="sb">`</span>cat pids/cluster_pidfile<span class="sb">`</span>
</code></pre>

<p>To send a signal to the cluster master process to reboot all its workers (<code class="prettyprint">USR2</code>), you can cat the pidfile (bash):
<code class="prettyprint">kill -s USR2 &quot;cat /path/to/pids/cluster_pidfile&quot;</code></p>

<p>If you want to setup a git-based deployment, the simplest steps would be something like =&gt;</p>

<h2 id="global-packages">Global Packages</h2>

<p>It&rsquo;s probably best to avoid installing any global packages.  This way, you won&rsquo;t have to worry about conflicts, and your project can be kept up to date more easily.  When using npm to install a local package the package&rsquo;s binaries are always copied into <code class="prettyprint">./node_modules/.bin</code>.</p>

<p>You can add local references to your $PATH like so to use these local binaries:</p>

<p><code class="prettyprint">export PATH=$PATH:node_modules/.bin</code></p>

<h2 id="nginx-example">Nginx Example</h2>
<pre class="highlight javascript"><code><span class="c1">// From `config/servers/web.js`</span>

<span class="nx">exports</span><span class="p">.</span><span class="nx">production</span> <span class="o">=</span> <span class="p">{</span>
  <span class="na">servers</span><span class="p">:</span> <span class="p">{</span>
    <span class="na">web</span><span class="p">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">api</span><span class="p">){</span>
      <span class="k">return</span> <span class="p">{</span>
        <span class="na">port</span><span class="p">:</span> <span class="s1">'/home/USER/www/APP/current/tmp/sockets/actionhero.sock'</span><span class="p">,</span>
        <span class="na">bindIP</span><span class="p">:</span> <span class="kc">null</span><span class="p">,</span>
        <span class="na">metadataOptions</span><span class="p">:</span> <span class="p">{</span>
          <span class="na">serverInformation</span><span class="p">:</span> <span class="kc">false</span><span class="p">,</span>
          <span class="na">requesterInformation</span><span class="p">:</span> <span class="kc">false</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre>
<pre class="highlight shell"><code><span class="c"># The nginx.conf:</span>

<span class="c">#user  nobody;</span>
worker_processes  4;

error_log  /var/log/nginx/error.log warn;
pid        /var/run/nginx.pid;


events <span class="o">{</span>
  worker_connections 1024;
  accept_mutex on;
<span class="o">}</span>


http <span class="o">{</span>
    include       mime.types;
    default_type  application/octet-stream;
    server_tokens off;
    sendfile        on;
    keepalive_timeout  65;

    set_real_ip_from  X.X.X.X/24;
    real_ip_header    X-Forwarded-For;

    gzip on;
    gzip_http_version 1.0;
    gzip_comp_level 9;
    gzip_proxied any;
    gzip_types text/plain text/xml text/css text/comma-separated-values text/javascript application/x-javascript font/ttf font/otf image/svg+xml application/atom+xml;

    log_format  main  <span class="s1">'$remote_addr - $remote_user [$time_local] "$request" $status $body_bytes_sent "$http_referer" "$http_user_agent" "$http_x_forwarded_for" $request_time'</span>;

    server <span class="o">{</span>
        proxy_set_header X-Forwarded-For <span class="nv">$proxy_add_x_forwarded_for</span>;
        proxy_set_header Host <span class="nv">$http_host</span>;
        proxy_set_header X_FORWARDED_PROTO https;
        proxy_redirect off;

        listen       80;
        server_name  _;

        access_log  /var/log/nginx/access.log  main;
        error_log   /var/log/nginx/error.log;

        root        /home/XXUSERXX/XXAPPLICATIONXX/www/current/public/;
        try_files /<span class="nv">$uri</span>/index.html /cache/<span class="nv">$uri</span>/index.html /<span class="nv">$uri</span>.html /cache/<span class="nv">$uri</span>.html /<span class="nv">$uri</span> /cache/<span class="nv">$uri</span> @app;

        client_max_body_size 50M;

        location /primus <span class="o">{</span>
            proxy_http_version 1.1;
            proxy_buffering off;
            proxy_set_header Upgrade <span class="nv">$http_upgrade</span>;
            proxy_set_header Connection <span class="s2">"Upgrade"</span>;
            proxy_set_header Host <span class="nv">$host</span>;

            proxy_pass http://unix:/home/XXUSERXX/www/XXAPPLICATIONXX/shared/tmp/sockets/actionhero.sock;
        <span class="o">}</span>

        location / <span class="o">{</span>
            proxy_http_version 1.1;
            proxy_buffering off;
            proxy_cache_bypass <span class="nv">$http_pragma</span> <span class="nv">$http_authorization</span>;
            proxy_no_cache <span class="nv">$http_pragma</span> <span class="nv">$http_authorization</span>;

            proxy_pass http://unix:/home/XXUSERXX/www/XXAPPLICATIONXX/shared/tmp/sockets/actionhero.sock;
        <span class="o">}</span>
    <span class="o">}</span>

<span class="o">}</span>
</code></pre>

<p>While ActionHero can be the font-line server your users hit, it&rsquo;s probably best to proxy ActionHero behind a load balancer, nginx, haproxy, etc.  This will help you pool connections before hitting node, SSL terminate, serve static assets, etc.  </p>

<p>Here is an example nginx config for interfacing with ActionHero, including using sockets (not http) and handing the websocket upgrade path.</p>

<ul>
<li>Note the proxy-pass format to the socket: proxy_pass http://unix:/path/to/socket</li>
<li>Note some of the extra work you need to have for the websocket upgrade headers (the primus directive)</li>
</ul>

<h2 id="redis-high-availability-configurations">Redis High-availability Configurations</h2>

<p><a href="http://redis.io/">Redis</a> is technically optional in ActionHero environments, but you will need it if you want to coordinates tasks across a cluster of workers, handle group chat mechanics between WebSocket clients, or do other cross-cluster operations.  In those cases, you&rsquo;ll want your Redis setup to be reliable.  There are 2 methods to achieving HA redis: Sentinels and Cluster.  A simple architectural wireframe of how to deploy the various options is below  The <a href="https://github.com/luin/ioredis"><code class="prettyprint">ioredis</code></a> node package supports both of these connection schemes, and all you need to change is your connection options.</p>

<p><img alt="../images/redis.png" src="../images/redis.png" /></p>

<h3 id="sentinel-mode">Sentinel Mode</h3>

<p>In Sentinel mode, you have your Redis configured in a normal master-&gt;slave configuration. However, rather than hard-code your application to know who the master and slaves are, your application connects to the Sentinel processes instead. These Sentinels transparently pipeline your connection to the proper Redis master, and they do this invisibly to ActionHero / your application.</p>

<p>The biggest advantage to this configuration is high-availability. In the event of a master failure, the Sentinel processes reach a consensus, then elect a new master automatically. Since the same process which handles master election also manages the client connections, no requests are lost - the sentinels hold the connection idle and then replay any pending requests on the new master after election. In the configuration shown in the first diagram above, up to 2 Redis data nodes and any 1 Sentinel can fail without the entire system failing.</p>

<p>Note that it is not necessary to run the Sentinel nodes on separate servers. They can be run as parallel processes on the Redis nodes themselves.</p>

<p>To run this configuration, configure ioredis with a list of the Sentinel nodes and the name of the cluster. The driver will automatically connect to an appropriate Sentinel in round-robin fashion, reconnecting to another node if one is down, or fails.</p>

<p>An example of a <code class="prettyprint">redis.js</code> config file for sentinels would be:</p>
<pre class="highlight javascript"><code><span class="nx">exports</span><span class="p">.</span><span class="nx">production</span> <span class="o">=</span> <span class="p">{</span>
  <span class="na">redis</span><span class="p">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">api</span><span class="p">){</span>
    <span class="k">return</span> <span class="p">{</span>
      <span class="na">channel</span><span class="p">:</span> <span class="s1">'actionhero-myApp'</span><span class="p">,</span>
      <span class="na">rpcTimeout</span><span class="p">:</span> <span class="mi">5000</span><span class="p">,</span>

      <span class="na">pkg</span><span class="p">:</span> <span class="s1">'ioredis'</span><span class="p">,</span>
      <span class="na">port</span><span class="p">:</span> <span class="kc">null</span><span class="p">,</span>
      <span class="na">host</span><span class="p">:</span> <span class="kc">null</span><span class="p">,</span>
      <span class="na">password</span><span class="p">:</span> <span class="s1">'redis-password'</span><span class="p">,</span>
      <span class="na">database</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>

      <span class="na">options</span><span class="p">:</span> <span class="p">{</span>
        <span class="na">name</span><span class="p">:</span> <span class="s1">'myCluster'</span><span class="p">,</span>
        <span class="na">password</span><span class="p">:</span> <span class="s1">'redis-password'</span><span class="p">,</span>
        <span class="na">db</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
        <span class="na">sentinels</span><span class="p">:</span> <span class="p">[</span>
          <span class="p">{</span> <span class="na">host</span><span class="p">:</span> <span class="s1">'1.2.3.4'</span><span class="p">,</span> <span class="na">port</span><span class="p">:</span> <span class="mi">26379</span> <span class="p">},</span>
        <span class="p">]</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre>

<h3 id="cluster-mode">Cluster Mode</h3>

<p>In Cluster mode, Redis shards all the keys in data into &ldquo;slots&rdquo; which are evenly allocated though all the masters in the cluster. The client can connect to any node in the cluster, and if the requested key belongs on another node, it will proxy the request for you (just like the Sentinel would). The cluster can also take care of master re-election for each shard in the event of a master node failure.</p>

<p>Cluster mode provides similar high-availability to Sentinel mode, but the sharding allows more data to be stored in the cluster overall. However, where Sentinel mode requires a minimum of 3 servers, Cluster mode requires a minimum of 6 to reach a quorom and provide full redundancy.</p>

<p>Also an important note:  while you may opt to run “sentinel processes”, it’s the same codebase as regular redis, just running in “sentinel mode”.  The same goes if you run redis in “cluster mode”.</p>

<p>An example of a <code class="prettyprint">redis.js</code> config file for redis cluster would be:</p>
<pre class="highlight javascript"><code><span class="c1">// TODO</span>
</code></pre>

<h2 id="best-practices">Best Practices</h2>

<p>As ActionHero is a framework, much of the work for keeping your application secure is dependent on the types of actions and tasks you create.  That said, here is a list of general best-practices for ensuring your deployment is as robust as it can be:</p>

<h3 id="general-configuration">General Configuration</h3>

<ul>
<li>Be sure to change <code class="prettyprint">api.config.general.serverToken</code> to something unique for your application</li>
<li>Turn off <a href="/docs/#development-mode">developer mode</a> in production.</li>
<li>Use <code class="prettyprint">api.config.general.filteredParams</code> to hide sensitive information from the logs.  You probably don&rsquo;t want to log out <code class="prettyprint">password</code>, <code class="prettyprint">credit_card</code>, and other things of that nature.</li>
</ul>

<h3 id="topology">Topology</h3>

<ul>
<li>Run a cluster via <code class="prettyprint">start cluster</code>.  This will guarantee that you can reboot your application with 0 downtime and deploy new versions without interruption.

<ul>
<li>You can run 1 ActionHero instance per core (assuming the server is dedicated to ActionHero), and that is the default behavior of <code class="prettyprint">start cluster</code>.</li>
<li>You don&rsquo;t need a tool like PM2 to manage ActionHero cluster process, but you can.</li>
<li>You can use an init script to <code class="prettyprint">start cluster</code> at boot, or use a tool like <a href="https://mmonit.com/monit/">monit</a> to do it for you.</li>
</ul></li>
<li>Never run tasks on the same ActionHero instances you run your servers on; never run your servers on the same ActionHero instances you run your tasks on

<ul>
<li>Yes, under most situations running servers + tasks on the same instance will work OK, but the load profiles (and often the types of packages required) vary in each deployment.  Actions are designed to respond quickly and offload hard computations to tasks.  Tasks are designed to work slower computations.</li>
<li>Do any CPU-intensive work in a task.  If a client needs to see the result of a CPU-intensive operation, poll for it (or use web-sockets)</li>
</ul></li>
<li>Use a centralized logging tool like Splunk, ELK, SumoLogic, etc.  ActionHero is <em>built for the cloud</em>, which means that it expects pids, application names, etc to change, and as such, will create many log files.  Use a centralized tool to inspect the state of your application.

<ul>
<li>Log everything.  You never know what you might want to check up on.  ActionHero&rsquo;s logger has various levels you can use for this.</li>
</ul></li>
<li>Split out the redis instance you use for cache from the one you use for tasks.  If your cache fills up, do you want task processing to fail?</li>
<li>Your web request stack should look like: [Load Balancer] -&gt; [App Server] -&gt; [Nginx] -&gt; [ActionHero]

<ul>
<li>This layout allows you to have control, back-pressure and throttling at many layers.</li>
<li>Configure Nginx to serve static files whenever possible to remove load from ActionHero, and leave it just to process actions</li>
</ul></li>
<li>Use a CDN. ActionHero will serve static files with the proper last-modified headers, so your CDN should respect this, and you should not need to worry about asset SHAs/Checksums.</li>
<li>Use redis-cluster or redis-sentinel.  The <a href="https://github.com/luin/ioredis"><code class="prettyprint">ioredis</code></a> redis library has support for them by default.  This allows you to have a High Availability redis configuration.</li>
</ul>

<h3 id="crashing-and-safety">Crashing and Safety</h3>
<pre class="highlight shell"><code><span class="gp">&gt; </span>./node_modules./bin/actionhero start cluster --workers 1
2016-04-11T18:51:32.891Z - info: actionhero &gt;&gt; start cluster
2016-04-11T18:51:32.904Z - notice:  - STARTING CLUSTER -
2016-04-11T18:51:32.905Z - notice: pid: 43315
2016-04-11T18:51:32.911Z - info: starting worker <span class="c">#1</span>
2016-04-11T18:51:33.097Z - info: <span class="o">[</span>worker <span class="c">#1 (43316)]: starting</span>
2016-04-11T18:51:33.984Z - info: <span class="o">[</span>worker <span class="c">#1 (43316)]: started</span>
2016-04-11T18:51:33.985Z - notice: cluster equilibrium state reached with 1 workers
2016-04-11T18:51:44.775Z - alert: <span class="o">[</span>worker <span class="c">#1 (43316)]: uncaught exception =&gt; yay is not defined</span>
2016-04-11T18:51:44.775Z - alert: <span class="o">[</span>worker <span class="c">#1 (43316)]:    ReferenceError: yay is not defined</span>
2016-04-11T18:51:44.775Z - alert: <span class="o">[</span>worker <span class="c">#1 (43316)]:        at Object.exports.action.run (../Users/evantahler/Dropbox/Projects/actionhero/actions/bad.js:14:5)</span>
2016-04-11T18:51:44.775Z - alert: <span class="o">[</span>worker <span class="c">#1 (43316)]:        at /Users/evantahler/Dropbox/Projects/actionhero/initializers/actionProcessor.js:268:31</span>
2016-04-11T18:51:44.775Z - alert: <span class="o">[</span>worker <span class="c">#1 (43316)]:        at /Users/evantahler/Dropbox/Projects/actionhero/initializers/actionProcessor.js:149:9</span>
2016-04-11T18:51:44.776Z - alert: <span class="o">[</span>worker <span class="c">#1 (43316)]:        at /Users/evantahler/Dropbox/Projects/actionhero/node_modules/async/lib/async.js:726:13</span>
2016-04-11T18:51:44.776Z - alert: <span class="o">[</span>worker <span class="c">#1 (43316)]:        at /Users/evantahler/Dropbox/Projects/actionhero/node_modules/async/lib/async.js:52:16</span>
2016-04-11T18:51:44.776Z - alert: <span class="o">[</span>worker <span class="c">#1 (43316)]:        at iterate (../Users/evantahler/Dropbox/Projects/actionhero/node_modules/async/lib/async.js:260:24)</span>
2016-04-11T18:51:44.776Z - alert: <span class="o">[</span>worker <span class="c">#1 (43316)]:        at async.forEachOfSeries.async.eachOfSeries (../Users/evantahler/Dropbox/Projects/actionhero/node_modules/async/lib/async.js:281:9)</span>
2016-04-11T18:51:44.776Z - alert: <span class="o">[</span>worker <span class="c">#1 (43316)]:        at _parallel (../Users/evantahler/Dropbox/Projects/actionhero/node_modules/async/lib/async.js:717:9)</span>
2016-04-11T18:51:44.776Z - alert: <span class="o">[</span>worker <span class="c">#1 (43316)]:        at Object.async.series (../Users/evantahler/Dropbox/Projects/actionhero/node_modules/async/lib/async.js:739:9)</span>
2016-04-11T18:51:44.777Z - alert: <span class="o">[</span>worker <span class="c">#1 (43316)]:        at api.actionProcessor.preProcessAction (../Users/evantahler/Dropbox/Projects/actionhero/initializers/actionProcessor.js:148:13)</span>
2016-04-11T18:51:44.777Z - notice: cluster equilibrium state reached with 1 workers
2016-04-11T18:51:44.785Z - info: <span class="o">[</span>worker <span class="c">#1 (43316)]: exited</span>
2016-04-11T18:51:44.785Z - info: starting worker <span class="c">#1</span>
2016-04-11T18:51:44.960Z - info: <span class="o">[</span>worker <span class="c">#1 (43323)]: starting</span>
2016-04-11T18:51:45.827Z - info: <span class="o">[</span>worker <span class="c">#1 (43323)]: started</span>
2016-04-11T18:51:45.827Z - notice: cluster equilibrium state reached with 1 workers
</code></pre>

<ul>
<li>Let the app crash rather than being defensive prematurely.  ActionHero has a good logger, and if you are running within <code class="prettyprint">start cluster</code> mode, your server will be restarted.  It is very easy to hide uncaught errors, exceptions, or un-resolved promises, and doing so might leave your application in strange state.<br></li>
<li>We removed domains from the project in v13 to follow this philosophy, and rely on a parent process (<code class="prettyprint">start cluster</code>) to handle error logging.  Domains are deprecated in node.js now for the same reasons we discuss here.

<ul>
<li>For example, if you timeout connections that are taking too long, what are you going to do about the database connection it was running?  Will you roll it back?  What about the other clients using the same connection pool?  How can you be sure which connection in the mySQL pool was in use?  Rather than handle all these edge cases&hellip; just let your app crash, log, and reboot.<br></li>
</ul></li>
<li>As noted above, centralized logging (Splunk et al) will be invaluable here.  You can can also employ a tool like <a href="https://bugsnag.com">BugSnag</a> to collect and correlate errors.</li>
</ul>

<h3 id="actions">Actions</h3>

<ul>
<li>Remember that all params which come in via the <code class="prettyprint">web</code> and <code class="prettyprint">socket</code> servers are <code class="prettyprint">String</code>s.  If you want to typeCast them (perhaps you always know that the param <code class="prettyprint">user_id</code> will be an integer), you can do so in a middleware or within an action&rsquo;s <a href="/docs/#inputs"><code class="prettyprint">params.formatter</code></a> step.</li>
<li>Always remember to sanitize any input for SQL injection, etc.  The best way to describe this is &ldquo;never pass a query to your database which can be directly modified via user input&rdquo;!</li>
<li>Remember that you can restrict actions to specific server types.  Perhaps only a web POST request should be able to login, and not a websocket client.  You can control application flow this way.</li>
<li>Crafting <a href="https://github.com/evantahler/actionhero-angular-bootstrap-cors-csrf">authentication middleware is not that hard</a></li>
</ul>

<h3 id="tasks">Tasks</h3>

<ul>
<li>Tasks can be created from any part of ActionHero: Actions, Servers, Middleware, even other Tasks.</li>
<li>You can chain tasks together to create workflows.<br></li>
<li>ActionHero uses the <a href="https://github.com/taskrabbit/node-resque#multi-worker"><code class="prettyprint">multiWorker</code></a> from node-resque.  When configured properly, it will consume 100% of a CPU core, to work as many tasks at once as it can.  This will also fluctuate depending on the CPU difficulty of the job.  Plan accordingly.</li>
<li>Create a way to view the state of your redis cluster.  Are you running out of RAM?  Are your Queues growing faster than they can be worked?  Checking this information is the key to having a healthy ecosystem.  <a href="/docs/#queue-inspection">The methods for doing so</a> are available.</li>
<li>Be extra-save within your actions, and do not allow an uncaught exception.  This will cause the worker to crash and the job to be remain &#39;claimed&rsquo; in redis, and never make it to the failed queue.</li>
</ul>

          <h1 id="running-actionhero">Running actionhero</h1>

<h2 id="the-actionhero-binary">The actionhero Binary</h2>
<pre class="highlight shell"><code>ActionHero - A multi-transport node.js API Server with integrated cluster
  capabilities and delayed tasks

Binary options:
<span class="k">*</span> <span class="nb">help</span> <span class="o">(</span>default<span class="o">)</span>
<span class="k">*</span> start
<span class="k">*</span> start cluster
<span class="k">*</span> generate
<span class="k">*</span> generate action
<span class="k">*</span> generate task
<span class="k">*</span> generate initializer
<span class="k">*</span> generate server
<span class="k">*</span> actions list
<span class="k">*</span> tasks enqueue
<span class="k">*</span> console
<span class="k">*</span> link
<span class="k">*</span> unlink

Descriptions:

<span class="k">*</span> actionhero <span class="nb">help
  </span>will display this document

<span class="k">*</span> actionhero start --config<span class="o">=[</span>/path/to/config] --title<span class="o">=[</span>processTitle]
    --daemon
  <span class="o">[</span>config] <span class="o">(</span>optional<span class="o">)</span> path to config.js, defaults to <span class="s2">"process.cwd() + '/'
    + config.js"</span>. You can also use ENV[ACTIONHERO_CONFIG].
  <span class="o">[</span>title] <span class="o">(</span>optional<span class="o">)</span> process title to use <span class="k">for </span>ActionHero<span class="s1">'s ID, ps, log, and
    pidFile defaults. Must be unique for each member of the cluster.
    You can also use ENV[ACTIONHERO_TITLE].
    Process renaming does not work on OSX/Windows
  [daemon] (optional) to fork and run as a new background process defaults
    to false

* actionhero start cluster --workers=[numWorkers] --workerTitlePrefix=[title]  
    --daemon
  will launch a ActionHero cluster (using node-s cluster module)
  [workers] (optional) number of workers (defaults to # CPUs - 2)
  [title] (optional) worker title prefix (default '</span>actionhero-worker-<span class="s1">')
    set `--workerTitlePrefix=hostname`, your app.id would be like 
    `your_host_name-#`
  [daemon] (optional) to fork and run as a new background process defaults
    to false

* actionhero generate
  will prepare an empty directory with a template ActionHero project

* actionhero generate action --name=[name] --description=[description]
  will generate a new action in "actions"
  [name] (required)
  [description] (optional)

* actionhero generate task --name=[name] --description=[description]
    --scope=[scope] --frequency=[frequency]
  will generate a new task in "tasks"
  [name] (required)
  [description] (optional)
  [queue] (required)
  [frequency] (optional)

* actionhero generate initializer --name=[name] --loadPriority=[p]
    --startPriority=[p] --stopPriority=[p]
  will generate a new initializer in "initializers"
  [name] (required)
  [loadPriority] (optional)
  [startPriority] (optional)
  [stopPriority] (optional)

* actionhero generate server --name=[name]
  will generate a new server in "servers"
  [name] (required)

* actionhero actions list
  will list all actions in this server to stdout

* actionhero task enqueue --name=[taskName] --args=[JSON-formatted args]
  will enqueue a task into redis

* actionhero console
  will open an interactive CLI with the API object in scope.
  this is sometimes called a REPL

* actionhero link --name=[pluginName] --overwriteConfig=[overwriteConfig]
  will link the actions, tasks, initializers, etc from a plugin into your
    top-level project normally, you will have first installed the plugin
    via `npm install myPlugin`
  [name] (required)
  [overwriteConfig] (optional) default: false

* actionhero unlink --name=[pluginName]
  will remove the linked actions, tasks, initializers, etc from a plugin in your
    top-level project. Please remove the config files manually
  Remember if your plugin was installed via NPM, also be sure to remove it from your
    package.json or uninstall it with npm uninstall --save
  [name] (required)

#############################################################
## More Help &amp; the ActionHero documentation can be found @ ##
##             http://www.actionherojs.com                 ##
#############################################################
</span></code></pre>

<p>The suggested method to run your ActionHero server is to use the included <code class="prettyprint">./node_modules/.bin/actionhero</code> binary.  Note that there is no <code class="prettyprint">main.js</code> or specific start script your project needs.  ActionHero handles this for you.  Your ActionHero project simply needs to follow the proper directory conventions and it will be bootable.</p>

<p>At the time of this writing the ActionHero binary&rsquo;s help contains:</p>

<h2 id="linking-the-actionhero-binary">Linking the ActionHero binary</h2>

<ul>
<li>If you installed ActionHero globally (<code class="prettyprint">npm install actionhero -g</code>) you should have the <code class="prettyprint">actionhero</code> binary available to you within your shell at all times.</li>
<li>Otherwise, you can reference the binary from either <code class="prettyprint">./node_modules/.bin/actionhero</code> or <code class="prettyprint">./node_modules/actionhero/bin/actionhero</code>.</li>
<li>If you installed ActionHero locally, you can add a reference to your path (OSX and Linux): <code class="prettyprint">export PATH=$PATH:node_modules/.bin</code> to be able to use simpler commands, IE <code class="prettyprint">actionhero start</code>. On windows this can be done by running <code class="prettyprint">set PATH=%PATH%;%cd%\node_modules\.bin</code> at command prompt (not powershell).</li>
</ul>

<h2 id="environments-and-config">Environments and Config</h2>

<p>By default, ActionHero will use the settings found in the <code class="prettyprint">exports.default</code> blocks in <code class="prettyprint">/config/</code>.  However, you can set environment-specfic overrides or changes.  ActionHero inspects <code class="prettyprint">process.env.NODE_ENV</code> to load up runtime configuration overrides from <code class="prettyprint">exports.#{env}</code> blocks in your configuration files.  This is the recommended way to have separate settings for staging and production.</p>

<p>The load order of configs is:
- default values in <code class="prettyprint">/config</code>
- environment-specific values in <code class="prettyprint">/config</code>
- options passed in to boot with <code class="prettyprint">actionhero.start({configChanges: configChanges}, callback)</code></p>

<h2 id="programatic-use-of-actionhero">Programatic Use of ActionHero</h2>
<pre class="highlight javascript"><code><span class="kd">var</span> <span class="nx">actionheroPrototype</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s2">"actionhero"</span><span class="p">).</span><span class="nx">actionheroPrototype</span><span class="p">;</span>
<span class="kd">var</span> <span class="nx">actionhero</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">actionheroPrototype</span><span class="p">();</span>

<span class="kd">var</span> <span class="nx">timer</span> <span class="o">=</span> <span class="mi">5000</span><span class="p">;</span>
<span class="nx">actionhero</span><span class="p">.</span><span class="nx">start</span><span class="p">(</span><span class="nx">params</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">error</span><span class="p">,</span> <span class="nx">api</span><span class="p">){</span>

  <span class="nx">api</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">" &gt;&gt; Boot Successful!"</span><span class="p">);</span>
  <span class="nx">setTimeout</span><span class="p">(</span><span class="kd">function</span><span class="p">(){</span>

    <span class="nx">api</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">" &gt;&gt; restarting server..."</span><span class="p">);</span>
    <span class="nx">actionhero</span><span class="p">.</span><span class="nx">restart</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">error</span><span class="p">,</span> <span class="nx">api</span><span class="p">){</span>

      <span class="nx">api</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">" &gt;&gt; Restarted!"</span><span class="p">);</span>
      <span class="nx">setTimeout</span><span class="p">(</span><span class="kd">function</span><span class="p">(){</span>

        <span class="nx">api</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">" &gt;&gt; stopping server..."</span><span class="p">);</span>
        <span class="nx">actionhero</span><span class="p">.</span><span class="nx">stop</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">error</span><span class="p">,</span> <span class="nx">api</span><span class="p">){</span>

          <span class="nx">api</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">" &gt;&gt; Stopped!"</span><span class="p">);</span>
          <span class="nx">process</span><span class="p">.</span><span class="nx">exit</span><span class="p">();</span>

        <span class="p">});</span>
      <span class="p">},</span> <span class="nx">timer</span><span class="p">);</span>
    <span class="p">})</span>
  <span class="p">},</span> <span class="nx">timer</span><span class="p">);</span>
<span class="p">});</span>
</code></pre>

<p>While <strong>NOT</strong> encouraged, you can always instantiate an ActionHero server yourself.  Perhaps you wish to combine ActionHero with an existing project.  Here&rsquo;s how!  Take note that using these methods will not work for actionCluster, and only a single instance will be started within your project.  </p>

<p>Feel free to look at the source of <code class="prettyprint">./node_modules/actionhero/bin/include/start</code> to see how the main ActionHero server is implemented for more information.</p>

<p>You can programmatically control an ActionHero server with <code class="prettyprint">actionhero.start(params, callback)</code>, <code class="prettyprint">actionhero.stop(callback)</code> and <code class="prettyprint">actionhero.restart(callback)</code></p>

<p>From within ActionHero itself (actions, initilizers, etc), you can use <code class="prettyprint">api.commands.start</code>, <code class="prettyprint">api.commands.stop</code>, and <code class="prettyprint">api.commands.restart</code> to control the server.</p>

<h2 id="signals">Signals</h2>
<pre class="highlight shell"><code><span class="gp">&gt; </span>./node_modules/.bin/actionhero start cluster --workers<span class="o">=</span>2
info: actionhero &gt;&gt; start cluster
notice:  - STARTING CLUSTER -
notice: pid: 41382
info: starting worker <span class="c">#1</span>
info: worker 41383 <span class="o">(</span><span class="c">#1) has spawned</span>
info: Worker <span class="c">#1 [41383]: starting</span>
info: Worker <span class="c">#1 [41383]: started</span>
info: starting worker <span class="c">#2</span>
info: worker 41384 <span class="o">(</span><span class="c">#2) has spawned</span>
info: Worker <span class="c">#2 [41384]: starting</span>
info: Worker <span class="c">#2 [41384]: started</span>

<span class="c"># A new terminal</span>
<span class="nb">kill</span> -s TTIN <span class="sb">`</span>cat pids/cluster_pidfile<span class="sb">`</span>

info: worker 41632 <span class="o">(</span><span class="c">#3) has spawned</span>
info: Worker <span class="c">#3 [41632]: starting</span>
info: Worker <span class="c">#3 [41632]: started</span>

<span class="c"># A new terminal</span>
<span class="nb">kill</span> -s KILL <span class="sb">`</span>cat pids/cluster_pidfile<span class="sb">`</span>

warning: Cluster manager quitting
info: Stopping each worker...
info: Worker <span class="c">#1 [41901]: stopping</span>
info: Worker <span class="c">#2 [41904]: stopping</span>
info: Worker <span class="c">#3 [41906]: stopping</span>
info: Worker <span class="c">#3 [41906]: stopped</span>
info: Worker <span class="c">#2 [41904]: stopped</span>
info: Worker <span class="c">#1 [41901]: stopped</span>
alert: worker 41901 <span class="o">(</span><span class="c">#1) has exited</span>
alert: worker 41904 <span class="o">(</span><span class="c">#2) has exited</span>
alert: worker 41906 <span class="o">(</span><span class="c">#3) has exited</span>
info: all workers gone
notice: cluster <span class="nb">complete</span>, Bye!
</code></pre>

<p>ActionHero is intended to be run on <code class="prettyprint">*nix</code> operating systems.  The <code class="prettyprint">start</code> and <code class="prettyprint">start cluster</code> commands provide support for signaling. (There is limited support for some of these commands in windows).</p>

<p><strong>actionhero start</strong></p>

<ul>
<li><code class="prettyprint">kill</code> / <code class="prettyprint">term</code> / <code class="prettyprint">int</code> : Process will attempt to &ldquo;gracefully&rdquo; shut down.  That is, the worker will close all server connections (possibly sending a shutdown message to clients, depending on server type), stop all task workers, and eventually shut down.  This action may take some time to fully complete.</li>
<li><code class="prettyprint">USR2</code>: Process will restart itself.  The process will preform the &ldquo;graceful shutdown&rdquo; above, and they restart.</li>
</ul>

<p><strong>actionhero start cluster</strong></p>

<p>All signals should be sent to the cluster master process.  You can still signal the termination of a worker, but the cluster manager will start a new one in its place.</p>

<ul>
<li><code class="prettyprint">kill</code> / <code class="prettyprint">term</code> / <code class="prettyprint">int</code>:  Will signal the master to &ldquo;gracefully terminate&rdquo; all workers.  Master will terminate once all workers have completed</li>
<li><code class="prettyprint">HUP</code> : Restart all workers.</li>
<li><code class="prettyprint">USR2</code> : &ldquo;Hot reload&rdquo;.  Worker will kill off existing workers one-by-one, and start a new worker in their place.  This is used for 0-downtime restarts.  Keep in mind that for a short while, your server will be running both old and new code while the workers are rolling.</li>
<li><code class="prettyprint">TTOU</code>: remove one worker</li>
<li><code class="prettyprint">TTIN</code>: add one worker</li>
</ul>

<h2 id="shutting-down">Shutting Down</h2>

<p>When using <code class="prettyprint">actionhero start</code> or <code class="prettyprint">actionhero start cluster</code>, when you signal ActionHero to stop via the signals above (or from within your running application via <code class="prettyprint">api.commands.stop()</code>), actionhero will attempt to gracefully shutdown.  This will include running any initializer&rsquo;s <code class="prettyprint">stop()</code> method.  This will close any open servers, and attempt to allow any running tasks to complete.</p>

<p>Because things sometimes go wrong, <code class="prettyprint">actionhero start</code> and <code class="prettyprint">actionhero start cluster</code> also have a &ldquo;emergency stop&rdquo; timeout.  This defaults to 30 seconds, and is configurable via the <code class="prettyprint">ACTIONHERO_SHUTDOWN_TIMEOUT</code> environment variable.  Be sure that your tasks and actions can complete within that window, or else raise that shutdown limit.</p>

<h2 id="windows-specific-notes">Windows-Specific Notes</h2>

<ul>
<li>Sometimes ActionHero may require a git-based module (rather than a NPM module).  You will need to have git installed.  Depending on how you installed git, it may not be available to the node shell.  Be sure to have also installed references to git.  You can also run node/npm install from the git shell.</li>
<li>Sometimes, npm will not install the actionhero binary @ <code class="prettyprint">/node_modules/.bin/actionhero</code>, but rather it will attempt to create a windows executable and wrapper.  You can launch ActionHero directly with <code class="prettyprint">./node_modules/actionhero/bin/actionhero</code></li>
</ul>

          <h1 id="testing">Testing</h1>

<p>actionhero provides test helpers so that you may try your actions and tasks within a headless environment. We do this by including a <code class="prettyprint">specHelper</code> initializer which creates a server, <code class="prettyprint">testServer</code> when running within the test environment.  Via the <code class="prettyprint">testServer</code>, you can easily call actions or tasks without making a real request.</p>

<p>We have chosen <a href="http://mochajs.org/">mocha</a> as our test framework and <a href="https://github.com/visionmedia/should.js/">should</a> as our assertion tool which are included as dependancies within all new projects (<a href="/docs#install-amp-quickstart">generated</a> with <code class="prettyprint">./node_modules/.bin/actionhero generate</code>).  You do not need to use these testing tools, but an example will be provided which makes use of them.</p>

<p>You also don&rsquo;t need to use these test helpers, and you may want to make a &lsquo;real&rsquo; http or websocket request to test something specific.  If this is the case, you can <a href="https://github.com/evantahler/actionhero/tree/master/test/servers">check out how actionhero tests its own servers</a> for examples.</p>

<h2 id="getting-started">Getting Started</h2>
<pre class="highlight javascript"><code><span class="c1">// package.json from a new actionhero project with `mocha` and `should` included</span>
<span class="p">{</span>
  <span class="s2">"author"</span>      <span class="err">:</span> <span class="s2">"YOU &lt;YOU@example.com&gt;"</span><span class="p">,</span>
  <span class="s2">"name"</span>        <span class="err">:</span> <span class="s2">"my_actionhero_project"</span><span class="p">,</span>
  <span class="s2">"description"</span> <span class="err">:</span> <span class="s2">"my actionhero project"</span><span class="p">,</span>
  <span class="s2">"version"</span>     <span class="err">:</span> <span class="s2">"0.0.1"</span><span class="p">,</span>
  <span class="s2">"engines"</span>     <span class="err">:</span> <span class="p">{</span>
    <span class="s2">"node"</span><span class="err">:</span> <span class="s2">"&gt;=0.10.0"</span>
  <span class="p">},</span>
  <span class="s2">"dependencies"</span> <span class="err">:</span> <span class="p">{</span>
    <span class="s2">"actionhero"</span> <span class="err">:</span> <span class="s2">"12.3.0"</span><span class="p">,</span>
    <span class="s2">"ws"</span>         <span class="err">:</span> <span class="s2">"latest"</span>
  <span class="p">},</span>
  <span class="s2">"devDependencies"</span> <span class="err">:</span> <span class="p">{</span>
    <span class="s2">"mocha"</span>  <span class="err">:</span> <span class="s2">"latest"</span><span class="p">,</span>
    <span class="s2">"should"</span> <span class="err">:</span> <span class="s2">"latest"</span>
  <span class="p">},</span>
  <span class="s2">"scripts"</span> <span class="err">:</span> <span class="p">{</span>
    <span class="s2">"help"</span>         <span class="err">:</span> <span class="s2">"actionhero help"</span><span class="p">,</span>
    <span class="s2">"start"</span>        <span class="err">:</span> <span class="s2">"actionhero start"</span><span class="p">,</span>
    <span class="s2">"actionhero"</span>   <span class="err">:</span> <span class="s2">"actionhero"</span><span class="p">,</span>
    <span class="s2">"start cluster"</span><span class="err">:</span> <span class="s2">"actionhero start cluster"</span><span class="p">,</span>
    <span class="s2">"test"</span>         <span class="err">:</span> <span class="s2">"NODE_ENV=test mocha"</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre>

<p>To run a mocha test suite, you invoke the mocha binary, <code class="prettyprint">./node_modules/.bin/mocha</code>.  This will tell mocha to look in your <code class="prettyprint">./test</code> folder and run any tests that it can find.  There are ways to change the test folder location, only run specific tests, change the reporting format and more which you can learn about on <a href="http://mochajs.org/">Mocha&rsquo;s website</a>.  We asume that you have <code class="prettyprint">mocha</code> (and <code class="prettyprint">should</code>) installed to your project by listing it in your <code class="prettyprint">package.json</code>.  If you used <code class="prettyprint">actionhero generate</code> to create your project, this should already be configured for your.</p>

<p>The majority of the time, you&rsquo;ll be testing actions and other methods you have written, so you&rsquo;ll need to &ldquo;run&rdquo; an actionhero server as part of your test suite.  Many times you&rsquo;ll want to have actionhero behave in a slightly unique way while testing (perhaps connect to a special database, don&rsquo;t log, etc).  To do this, you can change the behavior of the config files for the <code class="prettyprint">test</code> environment.  Here&rsquo;s how we tell actionhero <a href="https://github.com/evantahler/actionhero/blob/master/config/logger.js#L48-L54">not to write any logs when testing</a>. Note thest test-specific configuration overrides the defaults.  To ensure that actionhero boots with the <code class="prettyprint">test</code> environment loaded, the test command you run should explicitly do this, AKA: <code class="prettyprint">NODE_ENV=test ./node_modules/.bin/mocha</code>.  You can log this in as the <a href="https://github.com/evantahler/actionhero/blob/master/package.json#L63"><code class="prettyprint">test</code> script in your <code class="prettyprint">package.json</code></a> so you can simplify the running of tests with just <code class="prettyprint">npm test</code>.</p>

<p>ActionHero comes with a <code class="prettyprint">specHelper</code> to make it easier to test tasks and actions.  This specHelper is a special <a href="/docs/#servers">server</a> which can check things without needing to make an HTTP, websocket, etc request.  If you need to check the true behavior of a server (perhaps how the router works for an HTTP request), you should make a real HTTP request in your test suite, using something like the <a href="https://github.com/request/request">request</a> library (<a href="https://github.com/evantahler/actionhero/blob/master/test/servers/web.js#L178-L184">example</a>).</p>

<h2 id="example-test">Example Test</h2>
<pre class="highlight javascript"><code><span class="c1">// ./test/integartion/actions/randomNumber.js</span>

<span class="kd">var</span> <span class="nx">should</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'should'</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">actionheroPrototype</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'actionhero'</span><span class="p">).</span><span class="nx">actionheroPrototype</span><span class="p">;</span>
<span class="kd">var</span> <span class="nx">actionhero</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">actionheroPrototype</span><span class="p">();</span>
<span class="kd">var</span> <span class="nx">api</span><span class="p">,</span> <span class="nx">firstNumber</span><span class="p">;</span>

<span class="nx">describe</span><span class="p">(</span><span class="s1">'Action: RandomNumber'</span><span class="p">,</span> <span class="kd">function</span><span class="p">(){</span>

  <span class="nx">before</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">done</span><span class="p">){</span>
    <span class="nx">actionhero</span><span class="p">.</span><span class="nx">start</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">error</span><span class="p">,</span> <span class="nx">a</span><span class="p">){</span>
      <span class="nx">api</span> <span class="o">=</span> <span class="nx">a</span><span class="p">;</span>
      <span class="nx">done</span><span class="p">();</span>
    <span class="p">})</span>
  <span class="p">});</span>

  <span class="nx">after</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">done</span><span class="p">){</span>
    <span class="nx">actionhero</span><span class="p">.</span><span class="nx">stop</span><span class="p">(</span><span class="kd">function</span><span class="p">(){</span>
      <span class="nx">done</span><span class="p">();</span>
    <span class="p">});</span>
  <span class="p">});</span>

  <span class="nx">it</span><span class="p">(</span><span class="s1">'generates random numbers'</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">done</span><span class="p">){</span>
    <span class="nx">api</span><span class="p">.</span><span class="nx">specHelper</span><span class="p">.</span><span class="nx">runAction</span><span class="p">(</span><span class="s1">'randomNumber'</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">response</span><span class="p">){</span>
      <span class="nx">response</span><span class="p">.</span><span class="nx">randomNumber</span><span class="p">.</span><span class="nx">should</span><span class="p">.</span><span class="nx">be</span><span class="p">.</span><span class="nx">a</span><span class="p">.</span><span class="nb">Number</span><span class="p">;</span>
      <span class="nx">response</span><span class="p">.</span><span class="nx">randomNumber</span><span class="p">.</span><span class="nx">should</span><span class="p">.</span><span class="nx">be</span><span class="p">.</span><span class="nx">within</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">);</span>
      <span class="nx">firstNumber</span> <span class="o">=</span> <span class="nx">response</span><span class="p">.</span><span class="nx">randomNumber</span><span class="p">;</span>
      <span class="nx">done</span><span class="p">();</span>
    <span class="p">});</span>
  <span class="p">});</span>

  <span class="nx">it</span><span class="p">(</span><span class="s1">'is unique / random'</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">done</span><span class="p">){</span>
    <span class="nx">api</span><span class="p">.</span><span class="nx">specHelper</span><span class="p">.</span><span class="nx">runAction</span><span class="p">(</span><span class="s1">'randomNumber'</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">response</span><span class="p">){</span>
      <span class="nx">response</span><span class="p">.</span><span class="nx">randomNumber</span><span class="p">.</span><span class="nx">should</span><span class="p">.</span><span class="nx">be</span><span class="p">.</span><span class="nx">a</span><span class="p">.</span><span class="nb">Number</span><span class="p">;</span>
      <span class="nx">response</span><span class="p">.</span><span class="nx">randomNumber</span><span class="p">.</span><span class="nx">should</span><span class="p">.</span><span class="nx">not</span><span class="p">.</span><span class="nx">equal</span><span class="p">(</span><span class="nx">firstNumber</span><span class="p">);</span>
      <span class="nx">done</span><span class="p">();</span>
    <span class="p">});</span>
  <span class="p">});</span>

<span class="p">});</span>
</code></pre>

<p>Say you had an action that was supposed to respond with a <code class="prettyprint">randomNumber</code>, and you wanted to write a test for it.  </p>

<p>More details on the specHelper methods are below.</p>

<p>If you want to see fuller example of how to create an integration test within actionhero, please <a href="https://github.com/evantahler/actionhero-tutorial#testing">check out the tutorial</a></p>

<h2 id="test-methods">Test Methods</h2>

<h3 id="new-api-spechelper-connection">new api.specHelper.connection()</h3>

<ul>
<li>generate a new connection object for the <code class="prettyprint">testServer</code></li>
<li>this connection can run actions, chat, etc.</li>
<li><code class="prettyprint">connection.messages</code> will contain all messages the connection has been sent (welcome messages, action responses, say messages, etc)</li>
</ul>

<h3 id="api-spechelper-runaction-actionname-input-callback">api.specHelper.runAction(actionName, input, callback)</h3>

<ul>
<li>use this method to run an action</li>
<li><code class="prettyprint">input</code> can be either a <code class="prettyprint">api.specHelper.connection</code> object, or simply a hash of params, IE: <code class="prettyprint">{key: &#39;value&#39;}</code></li>
<li>the callback returns <code class="prettyprint">message</code> and <code class="prettyprint">connection</code>.</li>
<li>example use:</li>
</ul>
<pre class="highlight javascript"><code><span class="nx">api</span><span class="p">.</span><span class="nx">specHelper</span><span class="p">.</span><span class="nx">runAction</span><span class="p">(</span><span class="s1">'cacheTest'</span><span class="p">,</span> <span class="p">{</span><span class="na">key</span><span class="p">:</span> <span class="s1">'key'</span><span class="p">,</span> <span class="na">value</span><span class="p">:</span> <span class="s1">'value'</span><span class="p">},</span> <span class="kd">function</span><span class="p">(</span><span class="nx">message</span><span class="p">,</span> <span class="nx">connection</span><span class="p">){</span>
  <span class="c1">// message is the normal API response;</span>
  <span class="c1">// connection is a new connection object</span>
<span class="p">})</span>
</code></pre>

<h3 id="api-spechelper-getstaticfile-file-callback">api.specHelper.getStaticFile(file, callback)</h3>

<ul>
<li>request a file in <code class="prettyprint">/public</code> from the server</li>
<li>the callback returns <code class="prettyprint">message</code> and <code class="prettyprint">connection</code> where <code class="prettyprint">message</code> is a hash:</li>
</ul>
<pre class="highlight javascript"><code><span class="kd">var</span> <span class="nx">message</span> <span class="o">=</span> <span class="p">{</span>
  <span class="na">error</span>    <span class="p">:</span> <span class="nx">error</span><span class="p">,</span>  <span class="c1">// null if everything is OK</span>
  <span class="na">content</span>  <span class="p">:</span> <span class="p">(</span><span class="nx">string</span><span class="p">),</span>  <span class="c1">// string representation of the file's body</span>
  <span class="na">mime</span>     <span class="p">:</span> <span class="nx">mime</span><span class="p">,</span>  <span class="c1">// file mime</span>
  <span class="na">length</span>   <span class="p">:</span> <span class="nx">length</span>  <span class="c1">// bytes</span>
<span class="p">}</span>
</code></pre>

<h3 id="api-spechelper-runtask-taskname-params-callback">api.specHelper.runTask(taskName, params, callback)</h3>

<ul>
<li>callback may or may not return anything depending on your task&rsquo;s makeup</li>
</ul>
<pre class="highlight javascript"><code><span class="nx">api</span><span class="p">.</span><span class="nx">specHelper</span><span class="p">.</span><span class="nx">runTask</span><span class="p">(</span><span class="s1">'sendEmailTask'</span><span class="p">,</span> <span class="p">{</span><span class="na">message</span><span class="p">:</span> <span class="s1">'hello'</span> <span class="na">to</span><span class="p">:</span> <span class="s1">'evan@test.com'</span><span class="p">},</span> <span class="kd">function</span><span class="p">(</span><span class="nx">response</span><span class="p">){</span>
  <span class="c1">// test it!</span>
  <span class="c1">// remember that the task really will be run, so be sure that the test environment is set properly</span>
<span class="p">})</span>
</code></pre>

<h2 id="notes">Notes</h2>

<ul>
<li>be sure to run your tests in the <code class="prettyprint">test</code> environment, setting the shell&rsquo;s env with <code class="prettyprint">NODE_ENV=test</code>.  You can alternatively set this explicitly in your tests with <code class="prettyprint">process.env.NODE_ENV = &#39;test&#39;</code></li>
</ul>

          <h1 id="upgrading-actionhero">Upgrading ActionHero</h1>

<p>Upgrading big ActionHero projects to a new major might require some effort. Every ActionHero version has it&rsquo;s own specific project files which you generate using <code class="prettyprint">actionhero generate</code> command. One of the ways to upgrade your project is to generate a new project using the latest ActionHero framework (<code class="prettyprint">npm install actionhero &amp;&amp; ./node_modules/.bin/actionhero generate</code>). Using that as your starting point you can then carefully copy all your <code class="prettyprint">configs</code>, <code class="prettyprint">initializers</code>, <code class="prettyprint">servers</code>, links and other custom code from your old project, making sure that you are at the same working state as before. It&rsquo;s a good practice to make tests for your actions (or any other component) before you plan to upgrade your ActionHero project.</p>

<p>With good <a href="http://www.actionherojs.com/docs/#testing">test coverage</a> you can make sure that you have successfully upgraded your project.</p>

<p>ActionHero follows <a href="http://semver.org/">semantic versioning</a>.  This means that a minor change is a right-most number.  A new feature added is the middle number, and a breaking change is the left number.  You should expect something in your application to need to be changed if you upgrade a major version.</p>

<h2 id="upgrading-from-v14-x-x-to-v15-x-x">Upgrading from v14.x.x to v15.x.x</h2>

<p><strong>Full Release Notes: <a href="https://github.com/evantahler/actionhero/releases/tag/v15.0.0">GitHub</a></strong></p>

<p><strong>Breaking Changes and How to Overcome Them:</strong></p>
<pre class="highlight shell"><code><span class="sb">`</span>actionhero generateAction --name<span class="o">=[</span>name]<span class="sb">`</span>      -&gt; <span class="sb">`</span>actionhero generate action --name<span class="o">=[</span>name]<span class="sb">`</span>
<span class="sb">`</span>actionhero generateInitializer --name<span class="o">=[</span>name]<span class="sb">`</span> -&gt; <span class="sb">`</span>actionhero generate initializer --name<span class="o">=[</span>name]<span class="sb">`</span>
<span class="sb">`</span>actionhero generateServer --name<span class="o">=[</span>name]<span class="sb">`</span>      -&gt; <span class="sb">`</span>actionhero generate server --name<span class="o">=[</span>name]<span class="sb">`</span>
<span class="sb">`</span>actionhero generateTask --name<span class="o">=[</span>name]<span class="sb">`</span>        -&gt; <span class="sb">`</span>actionhero generate task --name<span class="o">=[</span>name]<span class="sb">`</span>
</code></pre>

<ul>
<li>The ActionHero binary has had it&rsquo;s commands changed.<br>

<ul>
<li>Any deployment or automation tools you use will need to be updated accordingly.</li>
</ul></li>
<li>Tasks now use middleware instead of plugins.

<ul>
<li>You will need to convert all uses of task plugins to task middleware.</li>
</ul></li>
</ul>

<h2 id="upgrading-from-v13-x-x-to-v14-x-x">Upgrading from v13.x.x to v14.x.x</h2>

<p><strong>Full Release Notes: <a href="https://github.com/evantahler/actionhero/releases/tag/v14.0.0">GitHub</a></strong></p>

<p><strong>Breaking Changes and How to Overcome Them:</strong></p>

<ul>
<li>Redis Client Configurations have changed drastically.  This allows for greater configuration, but at a complexity cost.

<ul>
<li>The easiest way to upgrade your <code class="prettyprint">config/redis.js</code> is to take if from the <a href="https://github.com/evantahler/actionhero/blob/master/config/redis.js">master branch</a> directly and re-apply your configuration.</li>
<li>Move <code class="prettyprint">api.config.redis.channel</code> to <code class="prettyprint">api.config.general.channel</code></li>
<li>Move <code class="prettyprint">api.config.redis. rpcTimeout</code> to <code class="prettyprint">api.config.general.rpcTimeout</code></li>
<li>Throughout the code, use <code class="prettyprint">api.config.redis.client</code> rather than <code class="prettyprint">api.redis.client</code></li>
</ul></li>
</ul>

<h2 id="upgrading-from-v12-x-x-to-v13-x-x">Upgrading from v12.x.x to v13.x.x</h2>

<p><strong>Full Release Notes: <a href="https://github.com/evantahler/actionhero/releases/tag/v13.0.0">GitHub</a></strong></p>

<p><strong>Breaking Changes and How to Overcome Them:</strong></p>

<ul>
<li>Pluggins

<ul>
<li><code class="prettyprint">config/plugins.js</code> is removed.  Delete yours.<br></li>
<li>Use the new binary command, <code class="prettyprint">actionhero link --name=NameOfPlugin</code> to link your plugins in the new method.<br></li>
<li>Linking plugins will likley create new config files you may need to customize.<br></li>
</ul></li>
<li>Locales

<ul>
<li>This release introduced Locales. You will need the new locale config file.  The easiest way to upgrade your <code class="prettyprint">config/i18n.js</code> is to take if from the <a href="https://github.com/evantahler/actionhero/blob/master/config/i18n.js">master branch</a>.</li>
<li>Ensure that <code class="prettyprint">api.config.i18n.updateFiles</code> is <code class="prettyprint">true</code> so that your locale files can be generated for the first time.</li>
</ul></li>
<li>Errors

<ul>
<li><code class="prettyprint">config/errors.js</code> has been completely redone to take advantage of <code class="prettyprint">connection.localize</code>.  The easiest way to upgrade your <code class="prettyprint">config/errors.js</code> is to take if from the <a href="https://github.com/evantahler/actionhero/blob/master/config/errors.js">master branch</a>.</li>
</ul></li>
<li>Grunt Removed

<ul>
<li>Grunt is removed from the project.  The old ActionHero grunt commands have been moved into the ActionHero binary.</li>
</ul></li>
<li>Redis configuration

<ul>
<li><code class="prettyprint">package</code> is a reserved keyword in JavaScript.  We now use the key <code class="prettyprint">pkg</code> in the redis config.</li>
</ul></li>
</ul>

<h2 id="upgrading-from-v11-x-x-to-v12-x-x">Upgrading from v11.x.x to v12.x.x</h2>

<p><strong>Full Release Notes: <a href="https://github.com/evantahler/actionhero/releases/tag/v12.0.0">GitHub</a></strong></p>

<p><strong>Breaking Changes and How to Overcome Them:</strong></p>

<ul>
<li>Redis configuration

<ul>
<li>Switch from using the <code class="prettyprint">redis</code> npm pacakge to <code class="prettyprint">ioredis</code>.  Change this in your package.json.</li>
<li><code class="prettyprint">ioredis</code> handles passwords slightly differently.  Read the <a href="https://github.com/luin/ioredis">ioredis</a> documentation to learn more.</li>
</ul></li>
<li>Stats Removed

<ul>
<li>The <code class="prettyprint">api.stats</code> subsection has been removed from actionhero</li>
<li>If you need the stats subsection, you can get get it <a href="https://github.com/evantahler/ah-stats-plugin">via plugin</a><br></li>
</ul></li>
</ul>

<h2 id="upgrading-from-v10-x-x-to-v11-x-x">Upgrading from v10.x.x to v11.x.x</h2>

<p><strong>Full Release Notes: <a href="https://github.com/evantahler/actionhero/releases/tag/v11.0.0">GitHub</a></strong></p>

<p><strong>Breaking Changes and How to Overcome Them:</strong></p>

<ul>
<li>Action Syntax changed

<ul>
<li>Actions now look like
<code class="prettyprint">javascript
run: function(api, data, next){
data.response.randomNumber = Math.random();
next(error);
}
</code></li>
<li>Where data contains:
<code class="prettyprint">javascript
data = {
connection: connection,
action: &#39;randomNumber&#39;,
toProcess: true,
toRender: true,
messageCount: 123,
params: { action: &#39;randomNumber&#39;, apiVersion: 1 },
actionStartTime: 123,
response: {},
}
</code></li>
<li>You will need to change all of your actions to use <code class="prettyprint">data.connection</code> rather than <code class="prettyprint">connection</code> directly.</li>
<li>You will need to change all of your actions to use <code class="prettyprint">data.response</code> rather than <code class="prettyprint">connection.response</code> directly.</li>
</ul></li>
<li>Middleware syntax has changed to match action&rsquo;s <code class="prettyprint">data</code> pattern.  You will need to change your middleware accordingly.</li>
<li>Removed <code class="prettyprint">connection._originalConnection</code>.</li>
<li>Websockets:

<ul>
<li>The params of websocket connections should NOT be sticky. All actions will start with <code class="prettyprint">connection.params = {}</code>.  If you rely on the old behavior, you will need to change your client code.</li>
</ul></li>
<li>Action Processor:

<ul>
<li>Removed duplicate callback prevention in actionProcessor. This belongs on the user/implementer to handle.</li>
</ul></li>
</ul>

          <h1 id="examples">Examples</h1>

<p>There are full ActionHero project examples:</p>

<ul>
<li><a href="https://github.com/evantahler/actionhero-tutorial">https://github.com/evantahler/actionhero-tutorial</a></li>
<li><a href="https://github.com/evantahler/actionhero-angular-bootstrap-cors-csrf">https://github.com/evantahler/actionhero-angular-bootstrap-cors-csrf</a></li>
</ul>

<h2 id="example-actions">Example Actions</h2>

<p><strong><a href="https://github.com/evantahler/actionhero/blob/master/actions/cacheTest.js">cachetest</a></strong>: This action demonstrates how to handle parameter checking for an actin, and how to use the internal cache methods of actionhero to save and recall data provided from a client.</p>

<p><strong><a href="https://github.com/evantahler/actionhero/blob/master/actions/randomNumber.js">randomNumber</a></strong>: This example shows how to craft a simple action with no input, but to respond differently to clients based on their HTTP method (if it exists)</p>

<p><strong><a href="https://github.com/evantahler/actionhero/blob/master/actions/status.js">status</a></strong>: This action will render some statistics about this ActionHero node, and all nodes in the cluster.  Useful for health checks.</p>

<p><strong><a href="https://gist.github.com/evantahler/9541992">SimpleFileResponder</a></strong>: This action demonstrates how you can can manually send files from within actions.</p>

<p><strong><a href="https://gist.github.com/connanp/6169574">JadefileResponder</a></strong>: This snippet is for rendering Jade templates on the server for pushState single page apps in ActionHero. Useful when you need to bootstrap model data on initial page load. It also pre-compiles the templates on server start and will recompile if they change.</p>

<p><strong><a href="https://gist.github.com/4326070">oauth</a></strong>: This file is actually 2 actions which are needed to authenticate a user against twitter&rsquo;s API.  Note the use of <code class="prettyprint">api.cache</code> to save and load the temporary secret tokens, and how to send custom (redirect) headers with ActionHero</p>

<p><strong><a href="https://blog.evantahler.com/authentication-with-actionhero-again-b197f406532f">Authentication Example</a></strong>: This example contains a working user system (auth, login, user creation, sessions, etc) using redis.</p>

<p><strong><em><a href="https://gist.github.com/evantahler/5898472">Tic-Tac-Toe API</a></em></strong> This advanced example demonstrates how to create actions (and initializers) which will enable you to play tic-tac-toe against an AI Player.</p>

<h2 id="example-clients">Example Clients</h2>

<p><strong><a href="https://github.com/evantahler/actionhero-client">node via TCP</a></strong>: You can talk to an ActionHero server from another node project over TCP directly using this package.</p>

<p><strong><a href="https://github.com/evantahler/actionhero/blob/master/test/servers/web.js">node via HTTP/connect</a></strong>: ActionHero has a robust test suite for the web server which users connect.</p>

<p><strong><a href="https://github.com/evantahler/actionhero-angular-bootstrap-cors-csrf/blob/master/public/js/app/app.js#L43-L89">Angular</a></strong>: You can connect to ActionHero via angular and connect via HTTP or WebSocket (actionheroWebSocket).</p>

<h2 id="example-initializers">Example Initializers</h2>

<p><strong><a href="https://gist.github.com/evantahler/801a07085f230fa7f55d">mysql</a></strong>: Use <a href="http://sequelizejs.com/">sequilize.js</a> within an initializer</p>

<p><strong><a href="https://gist.github.com/evantahler/59ba68a5ef5990574b7d">session</a></strong>: use the cache methods and <code class="prettyprint">connection.id</code> to easily make some session management helpers.</p>

<p><strong><a href="https://gist.github.com/juancgarcia/e4caf5dc7474769f5137">passport</a></strong>: Use the <a href="http://passportjs.org/">passport</a> package for authentication in ActionHero.</p>

<p><strong><a href="https://gist.github.com/evantahler/0c59aa8680259aee3e01">mongo</a></strong>: a MongoDB initializer</p>

<h2 id="example-tasks">Example Tasks</h2>

<p><strong><a href="https://github.com/evantahler/actionhero/blob/master/tasks/runAction.js">runAction</a></strong>: This (non periodic) task is used to call an action in the background.  For example, you might have an action to <code class="prettyprint">sendEmail</code> which can be called synchronously by a client, but you also might want to call it in a delayed manner.  This is the task for you!</p>

<p><strong><a href="https://gist.github.com/evantahler/5aea80c04f14e8a88c91">sayHi</a></strong> A very simple example which will just log &lsquo;HELLO&rsquo; to the command line every 5 seconds.</p>

<p><strong><a href="https://gist.github.com/evantahler/5f427cde60f2f88ad61b">cleanLogFiles</a></strong>: This periodic task will run on all servers and inspect ActionHero&rsquo;s <code class="prettyprint">log</code> directly for large log files, and delete them</p>

<p><strong><a href="https://gist.github.com/evantahler/b2f6e90e800916d3d26d">pingSocketClients</a></strong>: This periodic task will run on all servers and send a &#39;ping&rsquo; to any connected TCP clients to help them keep their</p>

          <h1 id="utils">Utils</h1>

<p>ActionHero ships with a few utility methods exposed for your convince:</p>

<h3 id="api-utils-hashmerge-a-b">api.utils.hashMerge(a, b)</h3>

<ul>
<li>create a new hash which looks like b merged into a</li>
<li><code class="prettyprint">{a:1, b:2}</code> merged with <code class="prettyprint">{b:3, c:4}</code> looks like <code class="prettyprint">{a: 1, b:3, c:4}</code></li>
</ul>

<h3 id="api-utils-isplainobject-object">api.utils.isPlainObject(object)</h3>

<ul>
<li>determines if <code class="prettyprint">object</code> is a plain js &lsquo;Object&rsquo; or somethign more complex, like a stream</li>
</ul>

<h3 id="api-utils-arrayuniqueify-arr">api.utils.arrayUniqueify(arr)</h3>

<ul>
<li>removes duplicate entries from an array</li>
</ul>

<h3 id="api-utils-objclone-obj">api.utils.objClone(obj)</h3>

<ul>
<li>creates a new object with the same keys and values of the original object</li>
</ul>

<h3 id="api-utils-getexternalipaddress">api.utils.getExternalIPAddress()</h3>

<ul>
<li>attempts to determine this server&rsquo;s external IP address out of all plausible addressees this host is listening on</li>
</ul>

<h3 id="api-utils-parsecookies-req">api.utils.parseCookies(req)</h3>

<ul>
<li>a helper to parse the request object&rsquo;s headers and returns a hash of the client&rsquo;s cookies</li>
</ul>

<h3 id="api-utils-parseipv6uri-address">api.utils.parseIPv6URI(address)</h3>

<ul>
<li>will return <code class="prettyprint">{host: host, port: port}</code> for an IPv6 address</li>
</ul>

      </div>
      <div class="dark-box">
          <div class="lang-selector">
          </div>
      </div>
    </div>

    <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-29132597-1']);
    _gaq.push(['_setDomainName', 'actionherojs.com']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://' : 'http://') + 'stats.g.doubleclick.net/dc.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
</script>


  </body>
</html>
